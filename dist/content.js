!function(){"use strict";const e="background_files",t="current_bg",n="moodle_custom_settings_v4",o="moodle_custom_timetable_v2",r={headerBgColor:"#ffffff",headerTextColor:"#000000",headerStrokeColor:"#ffffff",backgroundUrl:"",backgroundType:"none",opacity:80,brightness:100,showTimetable:!0,contentOpacity:70},a={月:{},火:{},水:{},木:{},金:{},土:{},日:{}},i=[{start:900,end:1030,period:1},{start:1040,end:1210,period:2},{start:1255,end:1425,period:3},{start:1435,end:1605,period:4},{start:1615,end:1745,period:5},{start:1755,end:1925,period:6}],l=["日","月","火","水","木","金","土"],c="body#page-my-index, body#page-course-view-topics, body#page-course-view-weeks,body#page";let s,d={},u=null,p=new Map,m=!1,g=null,b=[],y=null,h=null,f=0;async function x(){!function(){const e=document.createElement("style");e.innerHTML=`\n            /* ヘッダーの透明化 */\n            #page-header, .page-context-header, #page {\n                background-color: transparent !important;\n                border-bottom: none !important;\n            }\n\n            /* ヘッダーのドロップダウンなど */\n            .navbar-nav .nav-item .nav-link:hover,\n            .navbar-nav .nav-item.open > .nav-link {\n                background-color: rgba(0, 0, 0, 0.3) !important;\n                border-radius: 4px;\n            }\n            .navbar-nav .nav-item.dropdown .dropdown-menu {\n                background-color: #ffffff !important;\n                box-shadow: 0 5px 10px rgba(0,0,0,0.2);\n            }\n            .navbar-nav .nav-item.dropdown .dropdown-menu a.dropdown-item {\n                color: #000000 !important;\n                text-shadow: none !important;\n            }\n            .page-context-header .page-header-headings h1,\n            .page-context-header a {\n                color: #000000 !important;\n            }\n            #usernavigation .usermenu {\n                 display: flex;\n                 align-items: center;\n            }\n            #customSettingsBtn {\n                 margin-right: 5px;\n            }\n\n            /* 背景とコンテンツ */\n            ${c} {\n                background-color: #f0f2f5 !important;\n                overflow-x: hidden !important;\n            }\n            #background-video, #background-image-container {\n                 transition: opacity 0.5s ease, filter 0.5s ease;\n            }\n            #page, #page-wrapper {\n                background-color: transparent !important;\n                z-index: 1;\n                position: relative;\n            }\n            .main-inner, .secondary-navigation d-print-none, .moremenu navigation observed, .nav more-nav nav-tabs, .card-footer border-0 bg-white w-100 {\n                background-color:  rgba(255, 255, 255, 1) !important;\n            }\n            :is(#secondary-navigation d-print-none, #page-content, #region-main, #region-main-box, .block) {\n                background-color: transparent !important;\n                z-index: 1;\n                position: relative;\n            }\n            .section {\n                 border-bottom: 2px solid rgba(255, 255, 255, 0.4) !important;\n                 margin-bottom: 10px !important;\n            }\n            .card-footer, .bg-white, .form-control, .page-item, .pagination mb-0, .pagination, .secondary-navigation, .secondary-navigation, .card-foote {\n                background-color: transparent !important;\n            }\n            :is(nav, .primary-navigation, .secondary-navigation, .nav, .nav-tabs, .moremenu, .course-section-header, .section-item) {\n                background-color: transparent !important;\n            }\n            .block * { color: #000000; }\n            .block a, .card a { color: #0d6efd; }\n\n            /* その他 */\n            .deadline-highlight {\n                border: 1px solid #ff4d4d !important;\n                background-color: rgba(255, 240, 240, 0.3) !important;\n                box-shadow: 0 0 8px rgba(255, 0, 0, 0.5) !important;\n            }\n            .block, .card:not(.custom-card-style) {\n                border: 0px solid rgba(255, 255, 255, 0.8) !important;\n                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);\n                transition: box-shadow 0.3s ease-in-out, background-color 0.3s ease;\n                z-index: 1;\n                position: relative;\n            }\n            .card.custom-card-style {\n                border: 1px solid rgba(255, 255, 255, 0.9) !important;\n            }\n            #customTimetableTable th {\n                 border-bottom-color: #aaa !important;\n                 border-bottom-width: 2px !important;\n                 border-left: 2px solid #ccc !important;\n            }\n            #customTimetableTable td {\n                 border-bottom-color: #f0f0f0 !important;\n                 border-bottom-width: 2px !important;\n                 border-left: 2px solid #f0f0f0 !important;\n            }\n            .section {\n                 border-bottom: 2px solid rgba(255, 255, 255, 0.4) !important;\n                 margin-bottom: 1px !important;\n            }\n            .section-item {\n                border: none !important;\n            }\n\n            /* ★★★ GitHub Button V2 Styles (From Uiverse.io by Mangesh636) ★★★ */\n            button.github-btn-mangesh636 {\n              background: transparent;\n              position: relative;\n              padding: 5px 10px; /* 既存のヘッダーに合わせてパディングを少し調整 */\n              display: flex;\n              align-items: center;\n              font-size: 15px; /* ヘッダーに合わせてフォントサイズを調整 */\n              font-weight: 600;\n              text-decoration: none;\n              cursor: pointer;\n              border: 1px solid rgb(36, 41, 46);\n              border-radius: 25px;\n              outline: none;\n              overflow: hidden;\n              color: rgb(36, 41, 46);\n              transition: color 0.3s 0.1s ease-out, border-color 0.3s 0.1s ease-out;\n              text-align: center;\n              height: 38px; /* 高さを調整 */\n            }\n\n            button.github-btn-mangesh636 span {\n              margin: 0 5px; /* マージンを調整 */\n            }\n\n            button.github-btn-mangesh636 svg {\n              transition: fill 0.3s 0.1s ease-out;\n            }\n\n            button.github-btn-mangesh636::before {\n              position: absolute;\n              top: 0;\n              left: 0;\n              right: 0;\n              bottom: 0;\n              margin: auto;\n              content: "";\n              border-radius: 50%;\n              display: block;\n              width: 20em;\n              height: 20em;\n              left: -5em;\n              text-align: center;\n              transition: box-shadow 0.5s ease-out;\n              z-index: -1;\n            }\n\n            button.github-btn-mangesh636:hover {\n              color: #fff !important; /* ホバー時は白文字 */\n              border: 1px solid rgb(36, 41, 46) !important;\n            }\n            \n            button.github-btn-mangesh636:hover svg {\n               fill: #fff !important; /* ホバー時は白アイコン */\n            }\n\n            button.github-btn-mangesh636:hover::before {\n              box-shadow: inset 0 0 0 10em rgb(36, 41, 46);\n            }\n              /* --- Quiz Retake Mode Styles (v2) --- */\n            .retake-controls-card {\n                background-color: #ffffff;\n                border: 1px solid #ddd;\n                border-radius: 8px;\n                padding: 20px;\n                margin-bottom: 20px;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.08);\n                position: relative; /* 終了ボタンの配置基準 */\n            }\n            .retake-controls-card h4 {\n                margin-top: 0;\n                color: #005A9C; /* 落ち着いた青 */\n                font-weight: 600;\n                border-bottom: 1px solid #eee;\n                padding-bottom: 10px;\n                margin-bottom: 10px;\n                display: flex;\n                align-items: center;\n                gap: 8px; /* アイコンとテキストの間隔 */\n            }\n            .retake-controls-card p {\n                font-size: 0.95em;\n                color: #555;\n                margin-bottom: 20px;\n            }\n            .retake-controls-card .button-group {\n                display: flex;\n                gap: 12px;\n                flex-wrap: wrap;\n            }\n            .retake-btn {\n                padding: 10px 18px;\n                border: none;\n                border-radius: 5px;\n                cursor: pointer;\n                font-size: 0.95em; /* 少し小さく調整 */\n                font-weight: 600; /* Moodleボタンに合わせて太く */\n                transition: all 0.2s ease;\n                text-decoration: none;\n                display: inline-flex; /* アイコンとテキストを中央揃え */\n                align-items: center;\n                gap: 6px; /* アイコンとテキストの間隔 */\n                text-align: center;\n                line-height: 1.2;\n            }\n            .retake-btn-primary {\n                background-color: #007bff; /* Moodleのプライマリカラー */\n                color: white;\n            }\n            .retake-btn-primary:hover {\n                background-color: #0056b3;\n                box-shadow: 0 2px 5px rgba(0,0,0,0.15);\n                transform: translateY(-1px);\n            }\n            .retake-btn-secondary {\n                background-color: #f8f9fa;\n                color: #333;\n                border: 1px solid #ccc;\n            }\n            .retake-btn-secondary:hover {\n                background-color: #e9ecef;\n                border-color: #bbb;\n            }\n            .retake-btn-exit {\n                position: absolute;\n                top: 15px;\n                right: 15px;\n                background: none;\n                border: none;\n                font-size: 1.5rem;\n                color: #888;\n                cursor: pointer;\n                padding: 5px;\n                line-height: 1;\n                transition: color 0.2s ease;\n            }\n            .retake-btn-exit:hover {\n                color: #333;\n            }\n        `,document.head.appendChild(e)}(),await v();const e=await k();!function(){const e=document.querySelector("#usernavigation .usermenu");if(!e||document.getElementById("custom-github-nav-item"))return;const t=document.createElement("li");t.classList.add("nav-item"),t.id="custom-github-nav-item",t.style.cssText="display: flex; align-items: center;",t.innerHTML='\n          <button id="githubLinkBtnV2" class="github-btn-mangesh636" title="GitHubリポジトリを開く" style="margin-right: 5px;">\n            <svg\n              viewBox="0 0 24 24"\n              fill="currentColor"\n              height="20"\n              width="20"\n              xmlns="http://www.w3.org/2000/svg"\n            >\n              <path\n                d="M12.001 2C6.47598 2 2.00098 6.475 2.00098 12C2.00098 16.425 4.86348 20.1625 8.83848 21.4875C9.33848 21.575 9.52598 21.275 9.52598 21.0125C9.52598 20.775 9.51348 19.9875 9.51348 19.15C7.00098 19.6125 6.35098 18.5375 6.15098 17.975C6.03848 17.6875 5.55098 16.8 5.12598 16.5625C4.77598 16.375 4.27598 15.9125 5.11348 15.9C5.90098 15.8875 6.46348 16.625 6.65098 16.925C7.55098 18.4375 8.98848 18.0125 9.56348 17.75C9.65098 17.1 9.91348 16.6625 10.201 16.4125C7.97598 16.1625 5.65098 15.3 5.65098 11.475C5.65098 10.3875 6.03848 9.4875 6.67598 8.7875C6.57598 8.5375 6.22598 7.5125 6.77598 6.1375C6.77598 6.1375 7.61348 5.875 9.52598 7.1625C10.326 6.9375 11.176 6.825 12.026 6.825C12.876 6.825 13.726 6.9375 14.526 7.1625C16.4385 5.8625 17.276 6.1375 17.276 6.1375C17.826 7.5125 17.476 8.5375 17.376 8.7875C18.0135 9.4875 18.401 10.375 18.401 11.475C18.401 15.3125 16.0635 16.1625 13.8385 16.4125C14.201 16.725 14.5135 17.325 14.5135 18.2625C14.5135 19.6 14.501 20.675 14.501 21.0125C14.501 21.275 14.6885 21.5875 15.1885 21.4875C19.259 20.1133 21.9999 16.2963 22.001 12C22.001 6.475 17.526 2 12.001 2Z"\n              ></path>\n            </svg>\n            <span>GitHub</span>\n          </button>\n        ',e.prepend(t),document.getElementById("githubLinkBtnV2").addEventListener("click",()=>{window.open("https://github.com/Miaka1020/Moodle-Custom-Extension/","_blank")})}(),function(){const e=document.querySelector("#usernavigation .usermenu");if(!e||document.getElementById("customSettingsBtn"))return;const t=document.createElement("li");t.classList.add("nav-item"),t.innerHTML='\n            <button id="customSettingsBtn" class="btn nav-link" style="\n                background: none; border: none; padding: 0.5rem 0.8rem;\n                cursor: pointer; font-size: 1.25rem; line-height: 1;\n            " title="Moodleカスタム設定">\n                <i class="fa fa-cog" aria-hidden="true"></i> </button>\n        ',e.prepend(t),document.getElementById("customSettingsBtn").addEventListener("click",async()=>{const e=await k();let t=document.getElementById("custom-settings-modal");t||(E(e),t=document.getElementById("custom-settings-modal")),B(e),t.style.display="flex"})}(),E(e),D(await U()),await S(!1),document.URL.includes("/my/")&&(h&&clearInterval(h),f=0,h=setInterval(async()=>{f++,document.querySelector('.block_timeline [data-region="event-list-content-date"]')?(clearInterval(h),h=null,function(){if(b=[],!document.URL.includes("/my/"))return;const e=document.querySelector(".block_timeline");if(!e)return;const t=e.querySelectorAll('[data-region="event-list-content-date"]'),n=new Date,o=n.getFullYear();t.forEach(e=>{const t=parseInt(e.getAttribute("data-timestamp")),r=new Date(1e3*t),a=e.nextElementSibling;a&&a.querySelectorAll('[data-region="event-list-item"]').forEach(e=>{try{const t=e.querySelector(".event-name-container small.mb-0");if(!t)return;const a=t.textContent||"";if(!(a.includes("due")||a.includes("closes")||a.includes("提出期限")||a.includes("終了")))return;const i=e.querySelector(".event-name-container a"),l=i?.textContent.trim();if(!l)return;const c=a.match(/·\s*(.*)/),s=c?c[1].trim():null;if(!s)return;const d=(e.querySelector(".timeline-name > small.text-nowrap")?.textContent||"").match(/(\d{1,2}):(\d{2})/);let u=0,p=0;d&&(u=parseInt(d[1]),p=parseInt(d[2]));const m=new Date(r.getTime());m.setHours(u,p,0,0),m.getMonth()<n.getMonth()-6?m.setFullYear(o+1):m.setFullYear(o);const g=Math.floor(m.getTime()/1e3),y=`${m.getMonth()+1}月${m.getDate()}日 ${String(u).padStart(2,"0")}:${String(p).padStart(2,"0")}`;b.push({courseName:s,assignmentName:l,dueTimestamp:g,dueDateString:y})}catch(t){console.warn("Deadline parse error:",t,e)}})})}(),function(){if(!document.URL.includes("/my/"))return;const e=document.querySelector(".block_timeline");if(!e)return;const t=e.querySelectorAll('[data-region="event-list-content-date"]'),n=new Date;n.setHours(0,0,0,0);const o=new Date(n.getTime()+6048e5);t.forEach(e=>{const t=parseInt(e.getAttribute("data-timestamp")),r=new Date(1e3*t);if(r>=n&&r<o){const t=e.nextElementSibling;t&&t.querySelectorAll('[data-region="event-list-item"]').forEach(e=>{const t=e.querySelector(".timeline-name small.mb-0")?.textContent||"";(t.includes("due")||t.includes("closes")||t.includes("提出期限")||t.includes("終了"))&&e.classList.add("deadline-highlight")})}})}(),b.length>0&&await A()):f>60&&(clearInterval(h),h=null)},200))}function v(){return new Promise((t,n)=>{if(!window.indexedDB)return console.warn("IndexedDB not supported."),t(null);const o=indexedDB.open("MoodleCustomBGDB",2);o.onupgradeneeded=t=>{s=t.target.result,s.objectStoreNames.contains(e)||s.createObjectStore(e,{keyPath:"id"})},o.onsuccess=e=>{s=e.target.result,t(s)},o.onerror=e=>{console.error("IndexedDB error:",e.target.errorCode),n(e.target.errorCode)}})}async function k(){let o;const a=(await chrome.storage.local.get(n))[n];if(a)try{o=JSON.parse(a)}catch(e){console.error("設定データのパースに失敗。デフォルトを使用します。",e),o=r}else o=r;if(d={...r,...o},"indexeddb"===d.backgroundUrl)try{const n=await new Promise((n,o)=>{if(!s)return n(null);const r=s.transaction([e],"readonly").objectStore(e).get(t);r.onsuccess=e=>{const t=e.target.result;if(t&&t.blob){const e=URL.createObjectURL(t.blob);n({url:e,type:t.type})}else n(null)},r.onerror=e=>o(e)});n?(u&&URL.revokeObjectURL(u),u=n.url,d.backgroundUrl=n.url,d.backgroundType=n.type.startsWith("video/")?"video":"image"):(d.backgroundUrl="",d.backgroundType="none")}catch(e){console.error("Failed to load file from IndexedDB:",e),d.backgroundUrl="",d.backgroundType="none"}else""===d.backgroundUrl||d.backgroundUrl.startsWith("blob:")||(d.backgroundUrl="",d.backgroundType="none");return d}async function w(e){u&&u!==e.backgroundUrl&&(URL.revokeObjectURL(u),u=null);let t={...e};t.backgroundUrl.startsWith("blob:")?t.backgroundUrl="indexeddb":"indexeddb"!==t.backgroundUrl&&(t.backgroundUrl="",t.backgroundType="none"),await chrome.storage.local.set({[n]:JSON.stringify(t)}),d=e}function E(n){const o=`\n            <div id="custom-settings-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 10001; display: none; justify-content: center; align-items: center;">\n                <div id="custom-settings-content" style="background-color: white; padding: 30px; border-radius: 8px; width: 95%; max-width: 600px; max-height: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; display: flex; flex-direction: column;">\n                    <h4 style="margin-top: 0; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">\n                       Moodle カスタム設定\n                    </h4>\n                    <div style="overflow-y: auto; flex-grow: 1;">\n\n                        <fieldset style="border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 4px;">\n                            <legend style="font-weight: bold; padding: 0 10px; width: auto; margin-left: -5px;">ヘッダー設定</legend>\n                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: center;">\n                                <label for="headerBgColorInput" style="font-weight: 500;">背景色:</label>\n                                <input type="color" id="headerBgColorInput" value="${n.headerBgColor}" style="height: 35px; width: 100%; border: 1px solid #ccc; padding: 2px;">\n                                <label for="headerTextColorInput" style="font-weight: 500;">文字色:</label>\n                                <input type="color" id="headerTextColorInput" value="${n.headerTextColor}" style="height: 35px; width: 100%; border: 1px solid #ccc; padding: 2px;">\n                                <label for="headerStrokeColorInput" style="font-weight: 500;">文字枠線色:</label>\n                                <input type="color" id="headerStrokeColorInput" value="${n.headerStrokeColor}" style="height: 35px; width: 100%; border: 1px solid #ccc; padding: 2px;">\n                            </div>\n                        </fieldset>\n\n                        <fieldset style="border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 4px;">\n                            <legend style="font-weight: bold; padding: 0 10px; width: auto; margin-left: -5px;">ページ背景設定 (画像/動画)</legend>\n                            <input type="file" id="backgroundFileInput" accept="image/*,video/*" style="display: none;">\n                            <button id="selectBackgroundBtn" style="padding: 8px 15px; background-color: #0062caff; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%; margin-bottom: 15px;">\n                                ファイルを選択する (IndexedDB)\n                            </button>\n                            <p id="currentBackgroundInfo" style="font-size: 0.9em; color: #6c757d;"></p>\n                            <p style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">※画像・動画ともに大容量でも保存可能です。</p>\n                            <hr>\n                            <div style="margin-bottom: 15px;">\n                                <label style="display: block; margin-bottom: 5px;">背景種別（現在の設定）:</label>\n                                <input type="radio" id="bg-type-video" name="bg-type" value="video" ${"video"===n.backgroundType?"checked":""} disabled>\n                                <label for="bg-type-video" style="margin-right: 15px;">動画</label>\n                                <input type="radio" id="bg-type-image" name="bg-type" value="image" ${"image"===n.backgroundType?"checked":""} disabled>\n                                <label for="bg-type-image">画像</label>\n                            </div>\n                            <div style="margin-top: 20px;">\n                                <label for="opacityRange" style="display: block; margin-bottom: 5px; font-weight: bold;">背景の透明度: <span id="opacityValue">${n.opacity}</span>%</label>\n                                <input type="range" id="opacityRange" min="0" max="100" value="${n.opacity}" style="width: 100%;">\n                            </div>\n                            <div style="margin-top: 15px;">\n                                <label for="brightnessRange" style="display: block; margin-bottom: 5px; font-weight: bold;">背景の明度: <span id="brightnessValue">${n.brightness}</span>%</label>\n                                <input type="range" id="brightnessRange" min="0" max="200" value="${n.brightness}" style="width: 100%;">\n                                <small style="color: #6c757d;">(100%が標準)</small>\n                            </div>\n                        </fieldset>\n\n                        <fieldset style="border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 4px;">\n                            <legend style="font-weight: bold; padding: 0 10px; width: auto; margin-left: -5px;">コンテンツブロック背景設定</legend>\n                            <div style="margin-top: 15px;">\n                                <label for="contentOpacityRange" style="display: block; margin-bottom: 5px; font-weight: bold;">ブロックの透明度: <span id="contentOpacityValue">${n.contentOpacity}</span>%</label>\n                                <input type="range" id="contentOpacityRange" min="0" max="100" value="${n.contentOpacity}" style="width: 100%;">\n                                <small style="color: #6c757d;">(0%で完全透明、100%で白が不透明)</small>\n                            </div>\n                        </fieldset>\n\n                        <fieldset style="border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 4px;">\n                             <legend style="font-weight: bold; padding: 0 10px; width: auto; margin-left: -5px;">ウィジェット設定</legend>\n                             <div style="margin-bottom: 15px;">\n                                <input type="checkbox" id="showTimetableCheckbox" ${n.showTimetable?"checked":""}>\n                                <label for="showTimetableCheckbox" style="font-weight: bold; margin-left: 5px;">ダッシュボードにカスタム時間割を表示</label>\n                            </div>\n                        </fieldset>\n\n                        <div style="text-align: right; margin-top: 10px;">\n                            <button id="resetSettingsBtn" style="padding: 8px 15px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">\n                                設定をリセット\n                            </button>\n                        </div>\n                    </div>\n                    <div style="margin-top: 20px; text-align: right; flex-shrink: 0; border-top: 1px solid #eee; padding-top: 15px;">\n                        <button id="saveSettingsBtn" style="padding: 10px 20px; background-color: #0077ff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">\n                            保存\n                        </button>\n                        <button id="closeSettingsModal" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">\n                            閉じる\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `;document.body.insertAdjacentHTML("beforeend",o),function(){const n=document.getElementById("custom-settings-modal"),o=document.getElementById("saveSettingsBtn"),a=document.getElementById("closeSettingsModal"),i=document.getElementById("resetSettingsBtn"),l=document.getElementById("headerBgColorInput"),c=document.getElementById("headerTextColorInput"),p=document.getElementById("headerStrokeColorInput"),m=document.getElementById("opacityRange"),g=document.getElementById("brightnessRange"),b=document.getElementById("contentOpacityRange"),y=document.getElementById("backgroundFileInput"),h=document.getElementById("selectBackgroundBtn");function f(){L({...d,headerBgColor:l.value,headerTextColor:c.value,headerStrokeColor:p.value})}l.addEventListener("input",f),c.addEventListener("input",f),p.addEventListener("input",f),m.addEventListener("input",I),g.addEventListener("input",I),b&&b.addEventListener("input",e=>{document.getElementById("contentOpacityValue").textContent=e.target.value,C(parseInt(e.target.value))}),h&&h.addEventListener("click",()=>{y.click()}),y&&y.addEventListener("change",n=>{if(n.target.files.length>0){const o=n.target.files[0],r=o.type.startsWith("video/")?"video":"image";!async function(n,o){u&&(URL.revokeObjectURL(u),u=null);try{await(r=n,a=n.type,new Promise((n,o)=>{if(!s)return o("DB not initialized");const i=s.transaction([e],"readwrite").objectStore(e),l={id:t,blob:r,type:a},c=i.put(l);c.onsuccess=()=>n(),c.onerror=e=>o(e)}));const i=URL.createObjectURL(n);u=i,d.backgroundUrl=i,d.backgroundType=o,I();const l=document.getElementById("custom-settings-modal");l&&"flex"===l.style.display&&(document.getElementById("currentBackgroundInfo").innerHTML="<b>現在の背景</b>: ローカルファイル (IndexedDB経由・永続化済み)",document.getElementById("bg-type-video").checked="video"===o,document.getElementById("bg-type-image").checked="image"===o),alert(`背景ファイル ${n.name} をプレビュー適用しました。\n「保存」ボタンを押して永続化してください。`)}catch(e){console.error("IndexedDB Save Error:",e),alert("エラー: ファイルの保存中に問題が発生しました。")}var r,a}(o,r),n.target.value=""}}),o&&o.addEventListener("click",async()=>{const e={...d,headerBgColor:l.value,headerTextColor:c.value,headerStrokeColor:p.value,opacity:parseInt(m.value),brightness:parseInt(g.value),showTimetable:document.getElementById("showTimetableCheckbox").checked,contentOpacity:parseInt(b.value)};await w(e),n.style.display="none",S(!0)}),a&&a.addEventListener("click",async()=>{const e=await k();L(e),$(e),C(e.contentOpacity),n.style.display="none"}),i&&i.addEventListener("click",async()=>{if(confirm("全てのカスタム設定を初期値に戻しますか？（時間割の内容はリセットされません）")){u&&(URL.revokeObjectURL(u),u=null);try{if(s){s.transaction([e],"readwrite").objectStore(e).clear()}else if(console.warn("DB not initialized during reset, attempting to open and clear."),await v(),s){s.transaction([e],"readwrite").objectStore(e).clear()}}catch(e){console.warn("Failed to clear IndexedDB:",e)}await w(r),B(r),S(!0),alert("カスタム設定をリセットし、反映しました。")}})}()}function B(e){document.getElementById("headerBgColorInput").value=e.headerBgColor,document.getElementById("headerTextColorInput").value=e.headerTextColor,document.getElementById("headerStrokeColorInput").value=e.headerStrokeColor;const t=document.getElementById("currentBackgroundInfo"),n=document.getElementById("bg-type-video"),o=document.getElementById("bg-type-image");n.checked="video"===e.backgroundType,o.checked="image"===e.backgroundType,e.backgroundUrl.startsWith("blob:")?t.innerHTML="現在の背景: ローカルファイル (IndexedDB経由・永続化済み)":t.innerHTML="現在の背景: なし (ファイルを選択してください)",document.getElementById("opacityRange").value=e.opacity,document.getElementById("opacityValue").textContent=e.opacity,document.getElementById("brightnessRange").value=e.brightness,document.getElementById("brightnessValue").textContent=e.brightness,document.getElementById("showTimetableCheckbox").checked=e.showTimetable,document.getElementById("contentOpacityRange").value=e.contentOpacity,document.getElementById("contentOpacityValue").textContent=e.contentOpacity}function I(){const e=document.getElementById("opacityRange"),t=document.getElementById("brightnessRange");if(!e||!t)return;const n=parseInt(e.value),o=parseInt(t.value);document.getElementById("opacityValue").textContent=n,document.getElementById("brightnessValue").textContent=o,$({...d,opacity:n,brightness:o})}async function S(e=!0){e&&await k();const t=d;!function(){if(document.querySelector(c)){if(!document.getElementById("background-video")){const e=document.createElement("video");e.id="background-video",e.loop=!0,e.autoplay=!0,e.muted=!0,e.playsInline=!0,e.style.cssText="\n                position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n                object-fit: cover; z-index: -100; display: none;\n                transition: opacity 0.5s ease, filter 0.5s ease;\n            ",document.body.prepend(e),e.oncanplaythrough=()=>{e.play().catch(e=>console.warn("Video autoplay blocked:",e))},e.onerror=t=>{d.backgroundUrl.startsWith("blob:")&&"video"===d.backgroundType&&(console.error("Failed to load background VIDEO (Blob/IndexedDB).",t),e.error&&alert(`動画の読み込みに失敗。\nエラーコード: ${e.error.code}\n理由: ${e.error.message}\n\nブラウザがこの動画形式をサポートしていない可能性があります。`))}}if(!document.getElementById("background-image-container")){const e=document.createElement("div");e.id="background-image-container",e.style.cssText="\n                position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n                background-size: cover; background-position: center center;\n                background-repeat: no-repeat; z-index: -100; display: none;\n                transition: opacity 0.5s ease, filter 0.5s ease;\n            ",document.body.prepend(e)}}}(),L(t),$(t),C(t.contentOpacity),await A(),document.URL.includes("/mod/quiz/review.php")&&function(){if(!document.URL.includes("/mod/quiz/review.php")||document.getElementById("retake-controls"))return;const e=document.querySelector('#region-main > [role="main"]');if(!e)return void console.error("Moodle main region not found for Quiz Retake feature.");const t=document.createElement("div");t.id="retake-result";const n=document.createElement("div");n.id="retake-controls",n.className="retake-controls-card",n.innerHTML='\n            <button id="exitRetakeBtn" class="retake-btn-exit" title="解き直しを終了" style="display: none;">×</button>\n            \n            <h4>解き直し学習モード</h4>\n            <p>Moodleの成績には影響しません。何度でも問題を解き直して復習できます。</p>\n            \n            <div class="button-group">\n                <button id="startRetakeBtn" class="retake-btn retake-btn-primary">\n                解き直しモードを開始\n                </button>\n                \n                <button id="gradeRetakeBtn" class="retake-btn retake-btn-primary" style="display: none;">\n                採点\n                </button>\n                <button id="resetRetakeBtn" class="retake-btn retake-btn-secondary" style="display: none;">\n                    <i class="fa fa-refresh" aria-hidden="true"></i> リセット\n                </button>\n            </div>\n        ',e.prepend(n),e.prepend(t),document.getElementById("startRetakeBtn").addEventListener("click",O),document.getElementById("gradeRetakeBtn").addEventListener("click",F),document.getElementById("resetRetakeBtn").addEventListener("click",N),document.getElementById("exitRetakeBtn").addEventListener("click",H)}()}function L(e){let t=document.getElementById("custom-header-style");t||(t=document.createElement("style"),t.id="custom-header-style",document.head.appendChild(t));const n=`\n            -1px -1px 0 ${e.headerStrokeColor}, 1px -1px 0 ${e.headerStrokeColor},\n            -1px  1px 0 ${e.headerStrokeColor}, 1px  1px 0 ${e.headerStrokeColor}\n        `;t.innerHTML=`\n            .navbar.fixed-top.navbar-light.bg-white, .navbar {\n                background-color: ${e.headerBgColor} !important;\n                background-image: none !important;\n                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);\n                border-bottom: none !important;\n            }\n            .navbar-brand, .navbar-nav .nav-link, #customSettingsBtn {\n                color: ${e.headerTextColor} !important;\n                text-shadow: ${n};\n            }\n            .usernavigation .btn, .usernavigation .usermenu .btn {\n                color: ${e.headerTextColor} !important;\n                text-shadow: none !important;\n            }\n            \n            /* ★ GitHub Button V2 ヘッダー色連携 (文字潰れ対策) ★ */\n            button.github-btn-mangesh636 {\n                 color: ${e.headerTextColor} !important;\n                 border: 1px solid ${e.headerTextColor} !important;\n                 /* text-shadow: ${n}; */ /* ← 文字潰れの原因になるため削除 */\n            }\n            button.github-btn-mangesh636 svg {\n                 fill: ${e.headerTextColor} !important;\n            }\n            /* ホバー時は StaticStyles の :hover が優先される */\n        `}function $(e={}){const t={...d,...e},n=document.getElementById("background-video"),o=document.getElementById("background-image-container"),r=document.querySelector(c);if(!r||!n||!o)return;r.style.overflowX="hidden";const a=t.opacity/100,i=t.brightness/100;"video"===t.backgroundType&&t.backgroundUrl?(n.src=t.backgroundUrl,n.style.display="block",n.style.opacity=a.toString(),n.style.filter=`brightness(${i})`,o.style.display="none",o.style.backgroundImage="none"):"image"===t.backgroundType&&t.backgroundUrl?(o.style.backgroundImage=`url("${t.backgroundUrl}")`,o.style.display="block",o.style.opacity=a.toString(),o.style.filter=`brightness(${i})`,n.style.display="none",n.src=""):(n.style.display="none",n.src="",o.style.display="none",o.style.backgroundImage="none")}function C(e){const t=e/100;let n=document.getElementById("custom-content-style");n||(n=document.createElement("style"),n.id="custom-content-style",document.head.appendChild(n));const o=Math.min(t+.2,1);n.innerHTML=`\n            .block, .card:not(.custom-card-style), .card-body, .card,\n            #secondary-navigation d-print-none, #page-content,\n            #region-main, #region-main-box, .bg-white, .main-inner {\n                background-color: rgba(255, 255, 255, ${t}) !important;\n            }\n            .card.custom-card-style {\n                background-color: rgba(255, 255, 255, ${o}) !important;\n                border: 1px solid rgba(255, 255, 255, 0.9) !important;\n            }\n        `}function T(e){return"string"!=typeof e?"":e.normalize("NFKC").replace(/\s| /g,"").replace(/（.*）$|\(.*\)$/,"")}function q(e){if(e<=0)return'<span style="color: #6c757d; font-weight: bold;">[ 期限切れ ]</span>';const t=Math.floor(e/86400),n=Math.floor(e%86400/3600),o=Math.floor(e%3600/60),r=Math.floor(e%60);let a=[],i="#333";return t>0?(a.push(`<b>${t}</b>日`),a.push(`<b>${n}</b>時間`),a.push(`<b>${o}</b>分`),t<=3&&(i="#E67E22")):n>0?(a.push(`<b>${n}</b>時間`),a.push(`<b>${o}</b>分`),a.push(`<b>${r}</b>秒`),i="#E67E22"):(a.push(`<b>${o}</b>分`),a.push(`<b>${r}</b>秒`),i="#dc3545"),`<span style="color: ${i}; font-weight: bold; font-size: 0.95em;">あと ${a.join(" ")}</span>`}function M(){const e=document.querySelectorAll(".custom-countdown-timer"),t=Math.floor(Date.now()/1e3);if(0===e.length&&y)return clearInterval(y),void(y=null);e.forEach(e=>{const n=parseInt(e.dataset.dueTimestamp,10);if(isNaN(n))return;const o=n-t;o>86400&&""!==e.innerHTML?t%60==0&&(e.innerHTML=q(o)):e.innerHTML=q(o)})}async function A(){const e=document.querySelector("#block-region-content");let t=document.getElementById("customTimetableWidget");if(document.URL.includes("/my/")&&e)if(d.showTimetable){const n=await U();t||(t=document.createElement("div"),t.id="customTimetableWidget",t.classList.add("card","mb-3","custom-card-style"),t.style.cssText="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); position: relative;",t.innerHTML='\n                    <div class="card-header"><h5 class="mb-0">カスタム時間割</h5></div>\n                    <div class="card-body" style="padding: 0;"></div>\n                ',e.prepend(t));const o=t.querySelector(".card-body");if(o){o.innerHTML=function(e,t){const n=new Date,o=l[n.getDay()],{periodNumber:r,status:a,course:c}=function(e){const t=new Date,n=l[t.getDay()],o=100*t.getHours()+t.getMinutes();for(const t of i)if(o>=t.start&&o<=t.end){const o=t.period.toString();return e[n]&&e[n][o]?{periodNumber:o,status:"授業中",course:e[n][o]}:{periodNumber:o,status:"空きコマ"}}for(let e=0;e<i.length-1;e++)if(o>i[e].end&&o<i[e+1].start)return{periodNumber:null,status:"休み時間"};return{periodNumber:null,status:"授業時間外"}}(e);let s=`\n            <div style="padding: 15px;">\n                <h4 style="margin-top: 0; display: flex; justify-content: space-between; align-items: center;">\n                    週間時間割\n                    <button id="editTimetableBtn" style="font-size: 0.7em; padding: 5px 10px; border: 1px solid #ccc; background-color: #f8f9fa; cursor: pointer; border-radius: 4px;">編集</button>\n                </h4>\n                <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px;">\n                    現在:\n                    ${"授業中"===a?`<span style="color: #dc3545;">${r}講時 - ${c.name}</span> <a href="${R(c.id)}" target="_self" style="font-size: 0.8em; margin-left: 10px;">[コースへ]</a>`:`<span style="color: #6c757d;">${a} ${r?`(${r}講時)`:""}</span>`}\n                </div>\n                <hr style="margin: 5px 0 15px 0;">\n                <table id="customTimetableTable" style="width: 100%; border-collapse: collapse; text-align: left; font-size: 0.95em;">\n                    <thead>\n                        <tr>\n                            <th style="padding: 8px; border-bottom: 2px solid #ccc;">時間</th>\n                            ${l.slice(1,6).map(e=>`<th style="padding: 8px; border-bottom: 1px solid #ccc; ${e===o?"color: #dc3545;":""}">${e}</th>`).join("")}\n                        </tr>\n                    </thead>\n                    <tbody>\n        `;for(const n of i){const a=n.period.toString(),i=`${Math.floor(n.start/100)}:${(n.start%100).toString().padStart(2,"0")}〜`;s+=`<tr><td style="padding: 8px; border-bottom: 1px solid #eee;">${a} (${i})</td>`;for(let n=1;n<=5;n++){const i=l[n],c=e[i]?e[i][a]:null;if(s+=`<td style="padding: 8px; ${i===o&&a===r?"background-color: rgba(14, 114, 181, 0.1); font-weight: bold; border-bottom: 3px solid #eee;":"border-bottom: 1px solid #eee;"}">`,c){s+=`<a href="${R(c.id)}" target="_self" style="color: #007bff; text-decoration: none;">${c.name}</a>`;const e=T(c.name),n=t.filter(t=>T(t.courseName).includes(e)).sort((e,t)=>e.dueTimestamp-t.dueTimestamp);n.length>0&&(s+="\n                            <ul style=\"\n                                font-size: 0.85em; \n                                color: #dc3545; /* 赤色 */\n                                margin: 5px 0 0 10px; \n                                padding-left: 10px; \n                                list-style-type: '!! '; /* リストマーカー */\n                                line-height: 1.4;\n                                font-weight: 500;\n                            \">\n                        ",n.forEach(e=>{s+=`<li>\n                                <b>${e.assignmentName}</b>\n                                <div \n                                    class="custom-countdown-timer" \n                                    data-due-timestamp="${e.dueTimestamp}"\n                                >\n                                    </div>\n                                <span style="display: block; font-size: 0.9em; color: #6c757d;">\n                                    (締め切り: ${e.dueDateString})\n                                </span>\n                            </li>`}),s+="</ul>")}else s+='<span style="color: #6c757d;">-</span>';s+="</td>"}s+="</tr>"}return s+='\n                    </tbody>\n                </table>\n                <p style="font-size: 0.8em; color: #999; margin-top: 20px;">※コース名をクリックすると直接コースページへ移動します。</p>\n            </div>\n        ',s}(n,b),y&&clearInterval(y),M(),y=setInterval(M,1e3);const e=document.getElementById("editTimetableBtn");e&&e.addEventListener("click",async()=>{let e=document.getElementById("timetable-modal");e&&e.remove(),D(await U()),document.getElementById("timetable-modal").style.display="flex"})}}else t&&t.remove();else t&&t.remove()}function R(e){return`https://polite.do-johodai.ac.jp/moodle/course/view.php?id=${e}`}async function U(){let e;const t=(await chrome.storage.local.get(o))[o];if(t)try{e=JSON.parse(t)}catch(t){console.error("時間割データのパースに失敗。デフォルトを使用します。",t),e=a}else e=a,chrome.storage.local.set({[o]:JSON.stringify(a)});return e}function D(e){if(document.getElementById("timetable-modal"))return;const t=function(e){const t=l.slice(1,6),n=i.map(e=>e.period.toString());let o=`\n            <p style="margin-bottom: 15px;">科目名とMoodleのコースIDを入力してください。（IDはURL <code>course/view.php?id=XXX</code> のXXX部分です）</p>\n            <div id="timetable-edit-grid" style="display: grid; grid-template-columns: 80px repeat(5, 1fr); gap: 10px; font-size: 0.9em;">\n                <div style="font-weight: bold;">時間</div>\n                ${t.map(e=>`<div style="font-weight: bold; text-align: center;">${e}</div>`).join("")}\n        `;for(const r of n){const n=i.find(e=>e.period.toString()===r),a=n?`${Math.floor(n.start/100)}:${(n.start%100).toString().padStart(2,"0")}`:"";o+=`<div style="font-weight: bold; line-height: 1.2;">${r}講時<br>(${a})</div>`;for(const n of t){const t=e[n]&&e[n][r]?e[n][r]:null;o+=`\n                    <div>\n                        <input type="text" id="name-${n}-${r}" placeholder="科目名" value="${t?t.name:""}" style="width: 100%; margin-bottom: 5px; padding: 4px;">\n                        <input type="number" id="id-${n}-${r}" placeholder="コースID" value="${t?t.id:""}" style="width: 100%; padding: 4px;">\n                    </div>\n                `}}return o+="</div>",`\n            <div id="timetable-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 10000; display: none; justify-content: center; align-items: center;">\n                <div id="timetable-modal-content" style="background-color: white; padding: 30px; border-radius: 8px; width: 95%; max-width: 900px; max-height: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; display: flex; flex-direction: column;">\n                    <h4 style="margin-top: 0; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">\n                        時間割編集\n                    </h4>\n                    <div style="overflow-y: auto; flex-grow: 1;">\n                        ${o}\n                    </div>\n                    <div style="margin-top: 20px; text-align: right; flex-shrink: 0;">\n                        <button id="saveTimetableBtn" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">\n                            保存\n                        </button>\n                        <button id="closeTimetableModal" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">\n                            閉じる\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `}(e);document.body.insertAdjacentHTML("beforeend",t);const n=document.getElementById("timetable-modal");document.getElementById("saveTimetableBtn").addEventListener("click",z),document.getElementById("closeTimetableModal").addEventListener("click",()=>{n.style.display="none"})}async function z(){const e=l.slice(1,6),t=i.map(e=>e.period.toString());let n={};for(const o of e){n[o]={};for(const e of t){const t=document.getElementById(`name-${o}-${e}`),r=document.getElementById(`id-${o}-${e}`),a=t?t.value.trim():"",i=r?r.value.trim():"";a&&i&&!isNaN(parseInt(i))&&(n[o][e]={name:a,id:parseInt(i)})}}n["土"]={},n["日"]={},await async function(e){await chrome.storage.local.set({[o]:JSON.stringify(e)})}(n),document.getElementById("timetable-modal").style.display="none",await A()}function H(){confirm("解き直しモードを終了しますか？\n（ページがリロードされ、元のレビュー画面に戻ります）")&&window.location.reload()}function O(){if(!m){if(p.clear(),document.querySelectorAll("div.que").forEach(e=>{const t=e.id;if(!t)return;let n={type:null,answer:null};const o=e.querySelector(".feedback .rightanswer");let r="";if(o&&(r=o.textContent.trim()),e.classList.contains("multichoice")){n.type="multichoice";const t=e.querySelector('.answer .correct input[type="radio"], .answer .correct input[type="checkbox"]');t&&(n.answer=t.value)}else if(e.classList.contains("truefalse"))if(n.type="truefalse",r.includes("正解は「○」です")||r.toLowerCase().includes("the correct answer is 'true'"))n.answer="1";else if(r.includes("正解は「×」です")||r.toLowerCase().includes("the correct answer is 'false'"))n.answer="0";else{const t=e.querySelector('.answer .correct input[type="radio"]');t&&(n.answer=t.value)}else if(e.classList.contains("numerical")){if(n.type="numerical",r){const e=r.match(/(?:正解|The correct answer is):\s*([0-9.,]+)/i);e&&e[1]&&(n.answer=e[1].replace(",","."))}}else if(e.classList.contains("shortanswer")){if(n.type="shortanswer",r){const e=r.match(/(?:正解|The correct answer is):\s*(.*)/i);e&&e[1]&&(n.answer=e[1])}}else if(e.classList.contains("gapselect")){n.type="gapselect";const t={},r=[...(o?o.innerHTML:"").matchAll(/\[([\s\S]*?)\]/g)],a=e.querySelectorAll("select");r.length>0&&a.length>0&&a.forEach((e,n)=>{const o=e.id;if(!o)return;let a=null;if(r[n]&&r[n][1]){const t=r[n][1].replace(/<[^>]+>/g,"").trim(),o=e.querySelectorAll("option");for(const e of o)if(e.textContent.trim()===t){a=e.value;break}}null!==a&&(t[o]=a)}),n.answer=t}else if(e.classList.contains("match")){n.type="match";const t={},r={};let a=o?o.innerHTML:"";a=a.replace(/<(p|div|br)[^>]*>/gi,"|||"),a=a.replace(/<[^>]+>/g,""),a=a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">"),a.split("|||").forEach(e=>{if((e=e.trim()).includes("→")){const t=e.match(/(.+?)\s*→\s*(.+)/);if(t&&t[1]&&t[2]){let e=t[1].trim(),n=t[2].trim().replace(/,$/,"").trim();e&&n&&(e.startsWith("正解:")&&(e=e.substring(3).trim()),e&&(r[e]=n))}}}),e.querySelectorAll(".ablock .answer tr").forEach(e=>{const n=e.querySelector(".text"),o=e.querySelector(".control select");if(!n||!o)return;const a=n.textContent.trim();let i=r[a];if(!i){console.warn(`[Retake Mode] Match-Key not found for: "${a}"`);const e=Object.keys(r).find(e=>a.includes(e)||e.includes(a));if(!e)return;i=r[e],console.warn(`[Retake Mode] Fallback match found: "${e}" -> "${i}"`)}let l=null;const c=o.querySelectorAll("option");for(const e of c)if(e.textContent.trim()===i){l=e.value;break}null!==l&&(t[o.id]=l)}),n.answer=t}n.type&&null!==n.answer&&(Object.keys(n.answer).length>0||"object"!=typeof n.answer)?p.set(t,n):console.warn(`[Retake Mode] 問題 ${t} の正解を解析できませんでした。 (Type: ${e.className}, AnswerText: ${r})`)}),0===p.size)return void alert("エラー: 問題の正解をページから読み取れませんでした。");m=!0}g=new Date,document.querySelectorAll(".state, .grade, .outcome").forEach(e=>{e.style.display="none"}),document.querySelectorAll("i.fa-circle-check, i.fa-circle-xmark").forEach(e=>{e.classList.contains("retake-feedback-icon")||(e.style.display="none")}),document.querySelectorAll("div.que.numerical .ablock i.icon, div.que.shortanswer .ablock i.icon").forEach(e=>{e.classList.contains("retake-feedback-icon")||(e.style.display="none")}),document.querySelectorAll("div.que.gapselect .qtext i.icon").forEach(e=>{e.classList.contains("retake-feedback-icon")||(e.style.display="none")}),document.querySelectorAll("div.que.match .control i.icon").forEach(e=>{e.classList.contains("retake-feedback-icon")||(e.style.display="none")}),j(),document.getElementById("startRetakeBtn").style.display="none",document.getElementById("gradeRetakeBtn").style.display="inline-block",document.getElementById("resetRetakeBtn").style.display="inline-block",document.getElementById("exitRetakeBtn").style.display="block"}function j(){document.querySelectorAll("div.que").forEach(e=>{e.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(e=>{e.disabled=!1,e.checked=!1}),e.querySelectorAll('input[type="text"]').forEach(e=>{e.name&&e.name.endsWith("_answer")&&(e.disabled=!1,e.readOnly=!1,e.value="",e.classList.remove("correct","incorrect"))}),e.querySelectorAll("select").forEach(e=>{e.name&&e.name.includes(":")&&(e.disabled=!1,e.selectedIndex=0,e.classList.remove("correct","incorrect"))}),e.querySelectorAll(".state, .grade, .outcome").forEach(e=>{e.style.display="none",e.classList.contains("state")&&(e.style.color="",e.textContent="")}),e.querySelectorAll("i.fa-circle-check, i.fa-circle-xmark").forEach(e=>{e.classList.contains("retake-feedback-icon")||(e.style.display="none")}),e.querySelectorAll(".retake-feedback-icon").forEach(e=>{e.remove()});const t=e.querySelector(".ablock .icon");t&&(e.classList.contains("numerical")||e.classList.contains("shortanswer"))&&(t.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),t.style.display="none",t.setAttribute("title",""),t.setAttribute("aria-label","")),e.querySelectorAll("div.que.gapselect .qtext i.icon").forEach(e=>{e.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),e.style.display="none",e.setAttribute("title",""),e.setAttribute("aria-label","")}),e.querySelectorAll("div.que.match .control i.icon").forEach(e=>{e.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),e.style.display="none",e.setAttribute("title",""),e.setAttribute("aria-label","")})});const e=document.getElementById("retake-result");e&&(e.innerHTML=""),g=new Date}function N(){j()}function F(){const e=new Date;let t=0,n=0;p.forEach((e,o)=>{const r=document.getElementById(o);if(!r)return;const a=r.querySelector(".state"),i=r.querySelector(".outcome"),l=r.querySelector(".grade");let c=0;if(l){const e=l.textContent.match(/[0-9.]+\s*\/\s*([0-9.]+)/);e&&e[1]&&(c=parseFloat(e[1]))}t+=c;let s=0,d=!1;const u=o.split("-");if(u.length<3)return;const p=`q${u[1]}:${u[2]}_answer`,m=e=>{const t=e?"正解":"不正解";return`<span class="ms-1 retake-feedback-icon">\n                             <i class="icon fa-regular ${e?"fa-circle-check text-success":"fa-circle-xmark text-danger"} fa-fw" title="${t}" role="img" aria-label="${t}"></i>\n                         </span>`};if("multichoice"===e.type){const t=r.querySelector(`input[name="${p}"]:checked`);t&&t.value===e.answer&&(d=!0),r.querySelectorAll(`.answer input[name="${p}"]`).forEach(n=>{const o=n.value===e.answer,r=t&&n.value===t.value,a=n.closest(".r0, .r1");a&&(o?a.insertAdjacentHTML("beforeend",m(!0)):r&&!d&&a.insertAdjacentHTML("beforeend",m(!1)))})}else if("truefalse"===e.type){const t=r.querySelector(`input[name="${p}"]:checked`);t&&t.value===e.answer&&(d=!0),r.querySelectorAll(`.answer input[name="${p}"]`).forEach(n=>{const o=n.value===e.answer,r=t&&n.value===t.value,a=n.closest(".r0, .r1");a&&(o?a.insertAdjacentHTML("beforeend",m(!0)):r&&!d&&a.insertAdjacentHTML("beforeend",m(!1)))})}else if("numerical"===e.type||"shortanswer"===e.type){const t=r.querySelector(`input[name="${p}"]`),n=t?t.value.trim():"",o="numerical"===e.type?e.answer.replace(",","."):e.answer;("numerical"===e.type?n.replace(",","."):n).toLowerCase()===o.toLowerCase()&&(d=!0),t&&(t.classList.remove("correct","incorrect"),t.classList.add(d?"correct":"incorrect"));let a=t?t.nextElementSibling:null;a&&"I"===a.tagName||(a=t?t.parentElement.nextElementSibling:null),a&&"I"===a.tagName&&a.classList.contains("icon")&&(a.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),d?(a.classList.add("fa-regular","fa-circle-check","text-success"),a.setAttribute("title","正解"),a.setAttribute("aria-label","正解")):(a.classList.add("fa-regular","fa-circle-xmark","text-danger"),a.setAttribute("title","不正解"),a.setAttribute("aria-label","不正解")),a.style.display="inline-block",a.classList.add("retake-feedback-icon"))}else if("gapselect"===e.type){let t=!0,o=0;const a=r.querySelectorAll("select");let i=0;0===a.length&&(t=!1),a.forEach(n=>{if(!n.name||!n.name.includes(":"))return;i++;const r=n.id,a=e.answer[r],l=n.value;let c=void 0!==a&&l===a;c?o++:t=!1,n.classList.remove("correct","incorrect"),n.classList.add(c?"correct":"incorrect");const s=n.nextElementSibling;s&&"I"===s.tagName&&s.classList.contains("icon")&&(s.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),c?(s.classList.add("fa-regular","fa-circle-check","text-success"),s.setAttribute("title","正解"),s.setAttribute("aria-label","正解")):(s.classList.add("fa-regular","fa-circle-xmark","text-danger"),s.setAttribute("title","不正解"),s.setAttribute("aria-label","不正解")),s.style.display="inline-block",s.classList.add("retake-feedback-icon"))}),d=t,i>0?s=c*(o/i):a.length>0&&(s=c*(o/a.length)),n+=s}else if("match"===e.type){let t=!0,o=0;const a=r.querySelectorAll(".ablock .answer select");0===a.length&&(t=!1),a.forEach(n=>{const r=n.id,a=e.answer[r],i=n.value;let l=void 0!==a&&i===a;l?o++:t=!1,n.classList.remove("correct","incorrect"),n.classList.add(l?"correct":"incorrect");const c=n.closest(".control");if(c){const e=c.querySelector("i.icon");e&&(e.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),l?(e.classList.add("fa-regular","fa-circle-check","text-success"),e.setAttribute("title","正解"),e.setAttribute("aria-label","正解")):(e.classList.add("fa-regular","fa-circle-xmark","text-danger"),e.setAttribute("title","不正解"),e.setAttribute("aria-label","不正解")),e.style.display="inline-block",e.classList.add("retake-feedback-icon"))}}),d=t,a.length>0&&(s=c*(o/a.length)),n+=s}"gapselect"!==e.type&&"match"!==e.type&&d&&(s=c,n+=c),a&&(("gapselect"===e.type||"match"===e.type)&&!d&&s>0?(a.textContent="部分的に正解",a.style.color="#FF8C00"):(a.textContent=d?"正解":"不正解",a.style.color=d?"#28a745":"#dc3545"),a.style.display="block"),l&&(l.innerHTML=`${s.toFixed(2)} / ${c.toFixed(2)}`,l.style.display="block"),i&&(i.style.display="block")});const o=document.getElementById("retake-result");if(o){let r="-";if(g){const t=e.getTime()-g.getTime(),n=Math.round(t/1e3);r=`${Math.floor(n/60)} 分 ${n%60} 秒`}const a=e=>{if(!e)return"-";const t={year:"numeric",month:"long",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit",hour12:!1};try{return e.toLocaleString("ja-JP",t)}catch(t){return e.toLocaleString()}},i=t>0?n/t*100:0;let l=`\n                <h3 style="margin-top: 1.5rem; border-bottom: 1px solid #ddd; padding-bottom: 5px;">解き直し結果</h3>\n                <div class="mb-3">\n                    <table class="table generaltable generalbox quizreviewsummary mb-0">\n                       <caption class="visually-hidden">結果の概要</caption>\n                       <tbody>\n                            <tr>\n                                <th class="cell" scope="row">ステータス</th>\n                                <td class="cell">解き直し完了</td>\n                            </tr>\n                            <tr>\n                                <th class="cell" scope="row">開始日時</th>\n                                <td class="cell">${a(g)}</td>\n                            </tr>\n                            <tr>\n                                <th class="cell" scope="row">完了日時</th>\n                                <td class="cell">${a(e)}</td>\n                            </tr>\n                            <tr>\n                                <th class="cell" scope="row">継続時間</th>\n                                <td class="cell">${r}</td>\n                            </tr>\n                            <tr>\n                                <th class="cell" scope="row">評点</th>\n                                <td class="cell"><b>${n.toFixed(2)}</b> / ${t.toFixed(2)} (<b>${i.toFixed(0)}</b>%)</td>\n                            </tr>\n                       </tbody>\n                    </table>\n                </div>\n            `;Math.abs(t-n)<.001?l+='<p style="color: #028dffff; font-weight: bold; font-size: 1.1em; margin-top: 1rem;">素晴らしい！全問正解です！</p>':l+='<p style="color: #ff3131e1; font-size: 1.1em; margin-top: 1rem;">間違えた問題を確認して「リセット」でもう一度挑戦できます。</p>',o.innerHTML=l,g=new Date}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",x):x()}();