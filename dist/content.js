!function(){"use strict";const e="background_files",t="current_bg",n="moodle_custom_settings_v5",o="moodle_custom_timetable_v2",a="moodle_fast_font_cache_v2",r={headerBgColor:"#ffffff",headerTextColor:"#000000",headerStrokeColor:"#ffffff",backgroundUrl:"",backgroundType:"none",opacity:80,brightness:100,showTimetable:!0,contentOpacity:70,fontFamily:"default",customFontName:"",customFontUrl:""},i={月:{},火:{},水:{},木:{},金:{},土:{},日:{}},l=[{start:900,end:1030,period:1},{start:1040,end:1210,period:2},{start:1255,end:1425,period:3},{start:1435,end:1605,period:4},{start:1615,end:1745,period:5},{start:1755,end:1925,period:6}],s=["日","月","火","水","木","金","土"],c="body#page-my-index, body#page-course-view-topics, body#page-course-view-weeks,body#page";let d,u={},m=null,p=new Map,g=!1,b=null,y=[],f=null,h=null,x=0;try{const e=localStorage.getItem(a);e&&C(JSON.parse(e))}catch(e){console.warn("Fast font apply failed:",e)}async function v(e){!function(){const e=document.querySelector("#usernavigation .usermenu");if(!e||document.getElementById("custom-github-nav-item"))return;const t=document.createElement("li");t.classList.add("nav-item"),t.id="custom-github-nav-item",t.style.cssText="display: flex; align-items: center;",t.innerHTML='\n          <button id="githubLinkBtnV2" class="github-btn-mangesh636" title="GitHubリポジトリを開く" style="margin-right: 5px;">\n            <svg viewBox="0 0 24 24" fill="currentColor" height="20" width="20" xmlns="http://www.w3.org/2000/svg">\n              <path d="M12.001 2C6.47598 2 2.00098 6.475 2.00098 12C2.00098 16.425 4.86348 20.1625 8.83848 21.4875C9.33848 21.575 9.52598 21.275 9.52598 21.0125C9.52598 20.775 9.51348 19.9875 9.51348 19.15C7.00098 19.6125 6.35098 18.5375 6.15098 17.975C6.03848 17.6875 5.55098 16.8 5.12598 16.5625C4.77598 16.375 4.27598 15.9125 5.11348 15.9C5.90098 15.8875 6.46348 16.625 6.65098 16.925C7.55098 18.4375 8.98848 18.0125 9.56348 17.75C9.65098 17.1 9.91348 16.6625 10.201 16.4125C7.97598 16.1625 5.65098 15.3 5.65098 11.475C5.65098 10.3875 6.03848 9.4875 6.67598 8.7875C6.57598 8.5375 6.22598 7.5125 6.77598 6.1375C6.77598 6.1375 7.61348 5.875 9.52598 7.1625C10.326 6.9375 11.176 6.825 12.026 6.825C12.876 6.825 13.726 6.9375 14.526 7.1625C16.4385 5.8625 17.276 6.1375 17.276 6.1375C17.826 7.5125 17.476 8.5375 17.376 8.7875C18.0135 9.4875 18.401 10.375 18.401 11.475C18.401 15.3125 16.0635 16.1625 13.8385 16.4125C14.201 16.725 14.5135 17.325 14.5135 18.2625C14.5135 19.6 14.501 20.675 14.501 21.0125C14.501 21.275 14.6885 21.5875 15.1885 21.4875C19.259 20.1133 21.9999 16.2963 22.001 12C22.001 6.475 17.526 2 12.001 2Z"></path>\n            </svg>\n            <span>GitHub</span>\n          </button>\n        ',e.prepend(t),document.getElementById("githubLinkBtnV2").addEventListener("click",()=>{window.open("https://github.com/Miaka1020/Moodle-Custom-Extension/","_blank")})}(),function(){const e=document.querySelector("#usernavigation .usermenu");if(!e||document.getElementById("customSettingsBtn"))return;const t=document.createElement("li");t.classList.add("nav-item"),t.innerHTML='\n            <button id="customSettingsBtn" class="btn nav-link" style="\n                background: none; border: none; padding: 0.5rem 0.8rem;\n                cursor: pointer; font-size: 1.25rem; line-height: 1;\n            " title="Moodleカスタム設定">\n                <i class="fa fa-cog" aria-hidden="true"></i> </button>\n        ',e.prepend(t),document.getElementById("customSettingsBtn").addEventListener("click",async()=>{const e=await w();let t=document.getElementById("custom-settings-modal");t||(B(e),t=document.getElementById("custom-settings-modal")),S(e),t.style.display="flex"})}(),B(e),O(await N()),await $(!1),document.URL.includes("/my/")&&(h&&clearInterval(h),x=0,h=setInterval(async()=>{x++,document.querySelector('.block_timeline [data-region="event-list-content-date"]')?(clearInterval(h),h=null,function(){if(y=[],!document.URL.includes("/my/"))return;const e=document.querySelector(".block_timeline");if(!e)return;const t=e.querySelectorAll('[data-region="event-list-content-date"]'),n=new Date,o=n.getFullYear();t.forEach(e=>{const t=parseInt(e.getAttribute("data-timestamp")),a=new Date(1e3*t),r=e.nextElementSibling;r&&r.querySelectorAll('[data-region="event-list-item"]').forEach(e=>{try{const t=e.querySelector(".event-name-container small.mb-0");if(!t)return;const r=t.textContent||"";if(!(r.includes("due")||r.includes("closes")||r.includes("提出期限")||r.includes("終了")))return;const i=e.querySelector(".event-name-container a"),l=i?.textContent.trim();if(!l)return;const s=r.match(/·\s*(.*)/),c=s?s[1].trim():null;if(!c)return;const d=(e.querySelector(".timeline-name > small.text-nowrap")?.textContent||"").match(/(\d{1,2}):(\d{2})/);let u=0,m=0;d&&(u=parseInt(d[1]),m=parseInt(d[2]));const p=new Date(a.getTime());p.setHours(u,m,0,0),p.getMonth()<n.getMonth()-6?p.setFullYear(o+1):p.setFullYear(o);const g=Math.floor(p.getTime()/1e3),b=`${p.getMonth()+1}月${p.getDate()}日 ${String(u).padStart(2,"0")}:${String(m).padStart(2,"0")}`;y.push({courseName:c,assignmentName:l,dueTimestamp:g,dueDateString:b})}catch(t){console.warn("Deadline parse error:",t,e)}})})}(),function(){if(!document.URL.includes("/my/"))return;const e=document.querySelector(".block_timeline");if(!e)return;const t=e.querySelectorAll('[data-region="event-list-content-date"]'),n=new Date;n.setHours(0,0,0,0);const o=new Date(n.getTime()+6048e5);t.forEach(e=>{const t=parseInt(e.getAttribute("data-timestamp")),a=new Date(1e3*t);if(a>=n&&a<o){const t=e.nextElementSibling;t&&t.querySelectorAll('[data-region="event-list-item"]').forEach(e=>{const t=e.querySelector(".timeline-name small.mb-0")?.textContent||"";(t.includes("due")||t.includes("closes")||t.includes("提出期限")||t.includes("終了"))&&e.classList.add("deadline-highlight")})}})}(),y.length>0&&await R()):x>60&&(clearInterval(h),h=null)},200)),document.URL.includes("/mod/quiz/review.php")&&function(){if(!document.URL.includes("/mod/quiz/review.php")||document.getElementById("retake-controls"))return;const e=document.querySelector('#region-main > [role="main"]');if(!e)return;const t=document.createElement("div");t.id="retake-result";const n=document.createElement("div");n.id="retake-controls",n.className="retake-controls-card",n.innerHTML='\n            <button id="exitRetakeBtn" class="retake-btn-exit" title="解き直しを終了" style="display: none;">×</button>\n            \n            <h4>解き直し学習モード</h4>\n            <p>Moodleの成績には影響しません。何度でも問題を解き直して復習できます。</p>\n            \n            <div class="button-group">\n                <button id="startRetakeBtn" class="retake-btn retake-btn-primary">\n                解き直しモードを開始\n                </button>\n                \n                <button id="gradeRetakeBtn" class="retake-btn retake-btn-primary" style="display: none;">\n                採点\n                </button>\n                <button id="resetRetakeBtn" class="retake-btn retake-btn-secondary" style="display: none;">\n                    <i class="fa fa-refresh" aria-hidden="true"></i> リセット\n                </button>\n            </div>\n        ',e.prepend(n),e.prepend(t),document.getElementById("startRetakeBtn").addEventListener("click",H),document.getElementById("gradeRetakeBtn").addEventListener("click",V),document.getElementById("resetRetakeBtn").addEventListener("click",P),document.getElementById("exitRetakeBtn").addEventListener("click",j)}()}function k(){return new Promise((t,n)=>{if(!window.indexedDB)return t(null);const o=indexedDB.open("MoodleCustomBGDB",2);o.onupgradeneeded=t=>{d=t.target.result,d.objectStoreNames.contains(e)||d.createObjectStore(e,{keyPath:"id"})},o.onsuccess=e=>{d=e.target.result,t(d)},o.onerror=e=>{n(e.target.errorCode)}})}async function w(){let o;const a=(await chrome.storage.local.get(n))[n];if(a)try{o=JSON.parse(a)}catch(e){o=r}else o=r;if(u={...r,...o},"indexeddb"===u.backgroundUrl)try{const n=await new Promise((n,o)=>{if(!d)return n(null);const a=d.transaction([e],"readonly").objectStore(e).get(t);a.onsuccess=e=>{const t=e.target.result;if(t&&t.blob){const e=URL.createObjectURL(t.blob);n({url:e,type:t.type})}else n(null)},a.onerror=e=>o(e)});n?(m&&URL.revokeObjectURL(m),m=n.url,u.backgroundUrl=n.url,u.backgroundType=n.type.startsWith("video/")?"video":"image"):(u.backgroundUrl="",u.backgroundType="none")}catch(e){u.backgroundUrl="",u.backgroundType="none"}else""===u.backgroundUrl||u.backgroundUrl.startsWith("blob:")||(u.backgroundUrl="",u.backgroundType="none");return u}function E(e){try{localStorage.setItem(a,JSON.stringify({fontFamily:e.fontFamily,customFontName:e.customFontName,customFontUrl:e.customFontUrl}))}catch(e){console.warn("Failed to update font cache",e)}}async function I(e){m&&m!==e.backgroundUrl&&(URL.revokeObjectURL(m),m=null),E(e);let t={...e};t.backgroundUrl.startsWith("blob:")?t.backgroundUrl="indexeddb":"indexeddb"!==t.backgroundUrl&&(t.backgroundUrl="",t.backgroundType="none"),await chrome.storage.local.set({[n]:JSON.stringify(t)}),u=e}function B(n){!function(){const e=document.getElementById("modern-modal-css");e&&e.remove();const t=document.createElement("style");t.id="modern-modal-css",t.innerHTML='\n            /* オーバーレイ */\n            .modern-modal-overlay {\n                position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n                background-color: rgba(0, 0, 0, 0.85);\n                z-index: 10001; display: none;\n                justify-content: center; align-items: center;\n                animation: fadeIn 0.2s ease;\n            }\n\n            /* モーダル本体 */\n            .modern-modal-content {\n                background: #1a1b20;\n                color: #e0e0e0;\n                border-radius: 12px;\n                width: 95%; max-width: 550px; max-height: 85vh;\n                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);\n                border: 1px solid rgba(0, 119, 255, 0.3);\n                display: flex; flex-direction: column;\n                font-family: \'Segoe UI\', sans-serif;\n                overflow: hidden;\n            }\n\n            /* ヘッダー */\n            .modern-modal-header {\n                padding: 15px 25px;\n                background: linear-gradient(90deg, rgba(0, 60, 150, 0.2) 0%, transparent 100%);\n                border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n            }\n            .modern-modal-header h4 {\n                margin: 0; font-size: 1.5rem; font-weight: 700;\n                background: linear-gradient(90deg, #fff, #00d2ff);\n                -webkit-background-clip: text;\n                -webkit-text-fill-color: transparent;\n            }\n            .sub-text { margin: 5px 0 0; font-size: 0.85rem; color: #8bb9d6; }\n\n            /* ボディ */\n            .modern-modal-body {\n                padding: 25px; overflow-y: auto;\n                scrollbar-width: thin; scrollbar-color: #0056b3 transparent;\n            }\n            .modern-modal-body::-webkit-scrollbar { width: 8px; }\n            .modern-modal-body::-webkit-scrollbar-thumb { background-color: #0056b3; border-radius: 4px; }\n\n            /* グループ */\n            .settings-group {\n                background: rgba(255, 255, 255, 0.02);\n                border-radius: 8px; padding: 15px; margin-bottom: 15px;\n                border: 1px solid rgba(255, 255, 255, 0.08);\n            }\n            .group-title {\n                font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;\n                color: #00d2ff;\n                margin-bottom: 10px; font-weight: 600;\n            }\n\n            /* 入力系 */\n            .input-wrapper { margin-bottom: 15px; }\n            .input-wrapper label { display: block; font-size: 0.9rem; margin-bottom: 5px; color: #ccc; }\n            .modern-input, .modern-select {\n                width: 100%; padding: 8px 12px; background: #0f1012;\n                border: 1px solid #333; border-radius: 6px; color: #fff; transition: border-color 0.2s;\n            }\n            .modern-input:focus, .modern-select:focus { outline: none; border-color: #0077ff; background: #000; }\n            .modern-select option { background-color: #1f2937; color: #fff; }\n\n            /* カラーピッカー */\n            .color-picker-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }\n            .color-item { text-align: center; }\n            .color-item label { font-size: 0.75rem; display: block; margin-bottom: 5px; color: #aaa; }\n            .color-wrapper { height: 35px; border-radius: 6px; overflow: hidden; border: 1px solid #444; cursor: pointer; }\n            input[type="color"] { width: 100%; height: 100%; padding: 0; border: none; background: none; cursor: pointer; transform: scale(1.5); }\n\n            /* ▼▼▼ ここが修正の肝：スライダーラベルのスタイル強化 ▼▼▼ */\n            .slider-container { margin-top: 15px; }\n            \n            .slider-label { \n                display: flex; \n                justify-content: space-between; \n                align-items: center;\n                font-size: 0.85rem; \n                color: #ddd; \n                margin-bottom: 8px; \n                width: 100%; /* 幅を確保 */\n            }\n            \n            /* 数値と%をまとめるラッパー */\n            .slider-value-group {\n                display: inline-flex;\n                align-items: center;\n                justify-content: flex-end;\n                gap: 2px; /* 数字と%の間隔 */\n                font-family: monospace; /* 数字の幅を揃える */\n                font-size: 1.1em; /* 少し大きく */\n                color: #00d2ff; /* 青色にして強調 */\n            }\n            /* ▲▲▲ 修正ここまで ▲▲▲ */\n\n            .modern-range {\n                -webkit-appearance: none; width: 100%; height: 4px; background: #333; border-radius: 2px; outline: none;\n            }\n            .modern-range::-webkit-slider-thumb {\n                -webkit-appearance: none; width: 16px; height: 16px; background: #0077ff; border-radius: 50%; cursor: pointer;\n                box-shadow: 0 0 8px rgba(0, 119, 255, 0.5); transition: transform 0.1s;\n            }\n            .modern-range::-webkit-slider-thumb:hover { transform: scale(1.2); }\n\n            /* フッター・ボタン */\n            .modern-modal-footer {\n                padding: 15px 25px; background: rgba(0,0,0,0.3); border-top: 1px solid rgba(255,255,255,0.05);\n                display: flex; justify-content: flex-end; gap: 10px;\n            }\n            .modern-btn { padding: 8px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }\n            .primary-btn { background: linear-gradient(135deg, #0062ff 0%, #00b7ff 100%); color: white; }\n            .primary-btn:hover { filter: brightness(1.1); }\n            .secondary-btn { background: #333; color: #ccc; }\n            .secondary-btn:hover { background: #444; color: #fff; }\n            .full-width { width: 100%; margin-bottom: 10px; text-align: center; }\n            .modern-text-btn { background: none; border: none; cursor: pointer; font-size: 0.85rem; padding: 5px; border-radius: 4px; }\n            .modern-text-btn.danger { color: #ff4d4d; }\n            \n            .status-text { font-size: 0.8rem; color: #aaa; margin-bottom: 15px; text-align: center; }\n\n            /* トグル */\n            .toggle-switch { display: flex; align-items: center; cursor: pointer; user-select: none; }\n            .toggle-switch input { display: none; }\n            .toggle-switch .slider { width: 36px; height: 20px; background-color: #444; border-radius: 20px; position: relative; margin-right: 10px; }\n            .toggle-switch .slider:before { content: ""; position: absolute; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .2s; }\n            .toggle-switch input:checked + .slider { background-color: #0077ff; }\n            .toggle-switch input:checked + .slider:before { transform: translateX(16px); }\n            .toggle-switch .label-text { color: #ddd; font-size: 0.9rem; }\n\n            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n        ',document.head.appendChild(t)}();const o=`\n            <div id="custom-settings-modal" class="modern-modal-overlay">\n                <div id="custom-settings-content" class="modern-modal-content">\n                    <div class="modern-modal-header">\n                        <h4>Moodle Customizer</h4>\n                        <p class="sub-text">Personalize your learning environment</p>\n                    </div>\n                    \n                    <div class="modern-modal-body">\n                        <div class="settings-group">\n                            <div class="group-title">Header Style</div>\n                            <div class="color-picker-grid">\n                                <div class="color-item">\n                                    <label>背景色</label>\n                                    <div class="color-wrapper"><input type="color" id="headerBgColorInput" value="${n.headerBgColor}"></div>\n                                </div>\n                                <div class="color-item">\n                                    <label>文字色</label>\n                                    <div class="color-wrapper"><input type="color" id="headerTextColorInput" value="${n.headerTextColor}"></div>\n                                </div>\n                                <div class="color-item">\n                                    <label>枠線色</label>\n                                    <div class="color-wrapper"><input type="color" id="headerStrokeColorInput" value="${n.headerStrokeColor}"></div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="settings-group">\n                            <div class="group-title">Background Media</div>\n                            <input type="file" id="backgroundFileInput" accept="image/*,video/*" style="display: none;">\n                            <button id="selectBackgroundBtn" class="modern-btn primary-btn full-width"><i class="fa fa-folder-open"></i> ファイルを選択 (Image/Video)</button>\n                            <p id="currentBackgroundInfo" class="status-text"></p>\n                            \n                            <div class="radio-group" style="display:flex; justify-content:center; gap:20px; margin-bottom:10px;">\n                                <label class="radio-label" style="color:#ccc;">\n                                    <input type="radio" id="bg-type-video" name="bg-type" value="video" ${"video"===n.backgroundType?"checked":""} disabled> 動画\n                                </label>\n                                <label class="radio-label" style="color:#ccc;">\n                                    <input type="radio" id="bg-type-image" name="bg-type" value="image" ${"image"===n.backgroundType?"checked":""} disabled> 画像\n                                </label>\n                            </div>\n\n                            <div class="slider-container">\n                                <div class="slider-label">\n                                    <span>透明度</span>\n                                    <div class="slider-value-group">\n                                        <span id="opacityValue">${n.opacity}</span>%\n                                    </div>\n                                </div>\n                                <input type="range" id="opacityRange" min="0" max="100" value="${n.opacity}" class="modern-range">\n                            </div>\n                            <div class="slider-container">\n                                <div class="slider-label">\n                                    <span>明度</span>\n                                    <div class="slider-value-group">\n                                        <span id="brightnessValue">${n.brightness}</span>%\n                                    </div>\n                                </div>\n                                <input type="range" id="brightnessRange" min="0" max="200" value="${n.brightness}" class="modern-range">\n                            </div>\n                        </div>\n                        \n                        <div class="settings-group">\n                            <div class="group-title">Typography</div>\n                            <div class="input-wrapper">\n                                <label>プリセットフォント</label>\n                                <select id="fontFamilySelect" class="modern-select">\n                                    <option value="default">Moodle標準 (Default)</option>\n                                    <option disabled>--- System Fonts ---</option>\n                                    <option value="meiryo">メイリオ</option>\n                                    <option value="yugothic">游ゴシック</option>\n                                    <option value="biz-gothic">BIZ UDPゴシック</option>\n                                    <option disabled>--- Google Web Fonts ---</option>\n                                    <option value="notosans">Noto Sans JP</option>\n                                    <option value="zenmaru">Zen 丸ゴシック</option>\n                                    <option value="sawarabi">さわらび明朝</option>\n                                    <option value="mochiy">Mochiy Pop One</option>\n                                    <option value="dotgothic">DotGothic16</option>\n                                    <option value="rampart">Rampart One</option>\n                                </select>\n                            </div>\n                            <div class="input-wrapper">\n                                <label>カスタムフォント名</label>\n                                <input type="text" id="customFontNameInput" class="modern-input" placeholder="例: Impact" value="${n.customFontName||""}">\n                            </div>\n                            <div class="input-wrapper">\n                                <label>WebフォントURL</label>\n                                <input type="text" id="customFontUrlInput" class="modern-input" placeholder="例: https://fonts.googleapis.com/..." value="${n.customFontUrl||""}">\n                            </div>\n                        </div>\n\n                        <div class="settings-group">\n                            <div class="group-title">Content Area</div>\n                            <div class="slider-container">\n                                <div class="slider-label">\n                                    <span>ブロック透明度</span>\n                                    <div class="slider-value-group">\n                                        <span id="contentOpacityValue">${n.contentOpacity}</span>%\n                                    </div>\n                                </div>\n                                <input type="range" id="contentOpacityRange" min="0" max="100" value="${n.contentOpacity}" class="modern-range">\n                            </div>\n                        </div>\n\n                        <div class="settings-group">\n                            <div class="group-title">Widgets</div>\n                            <label class="toggle-switch">\n                                <input type="checkbox" id="showTimetableCheckbox" ${n.showTimetable?"checked":""}>\n                                <span class="slider"></span>\n                                <span class="label-text">ダッシュボードに時間割を表示</span>\n                            </label>\n                        </div>\n                        \n                        <div style="text-align: right; margin-top: 10px;">\n                            <button id="resetSettingsBtn" class="modern-text-btn danger"><i class="fa fa-trash"></i> 設定を初期化</button>\n                        </div>\n                    </div>\n\n                    <div class="modern-modal-footer">\n                        <button id="closeSettingsModal" class="modern-btn secondary-btn">閉じる</button>\n                        <button id="saveSettingsBtn" class="modern-btn primary-btn glow">保存して適用</button>\n                    </div>\n                </div>\n            </div>\n        `;document.body.insertAdjacentHTML("beforeend",o),function(){const n=document.getElementById("custom-settings-modal"),o=document.getElementById("saveSettingsBtn"),i=document.getElementById("closeSettingsModal"),l=document.getElementById("resetSettingsBtn"),s=document.getElementById("headerBgColorInput"),c=document.getElementById("headerTextColorInput"),p=document.getElementById("headerStrokeColorInput"),g=document.getElementById("opacityRange"),b=document.getElementById("brightnessRange"),y=document.getElementById("contentOpacityRange"),f=document.getElementById("fontFamilySelect"),h=document.getElementById("customFontNameInput"),x=document.getElementById("customFontUrlInput"),v=document.getElementById("backgroundFileInput"),E=document.getElementById("selectBackgroundBtn");function B(){T({...u,headerBgColor:s.value,headerTextColor:c.value,headerStrokeColor:p.value})}function F(){C({...u,fontFamily:f.value,customFontName:h.value,customFontUrl:x.value})}s.addEventListener("input",B),c.addEventListener("input",B),p.addEventListener("input",B),g.addEventListener("input",L),b.addEventListener("input",L),y&&y.addEventListener("input",e=>{document.getElementById("contentOpacityValue").textContent=e.target.value,M(parseInt(e.target.value))}),f&&f.addEventListener("change",F),h&&h.addEventListener("input",F),x&&x.addEventListener("input",F),E&&E.addEventListener("click",()=>{v.click()}),v&&v.addEventListener("change",n=>{if(n.target.files.length>0){const o=n.target.files[0],a=o.type.startsWith("video/")?"video":"image";!async function(n,o){m&&(URL.revokeObjectURL(m),m=null);try{await(a=n,r=n.type,new Promise((n,o)=>{if(!d)return o("DB not initialized");const i=d.transaction([e],"readwrite").objectStore(e),l={id:t,blob:a,type:r},s=i.put(l);s.onsuccess=()=>n(),s.onerror=e=>o(e)}));const i=URL.createObjectURL(n);m=i,u.backgroundUrl=i,u.backgroundType=o,L();const l=document.getElementById("custom-settings-modal");l&&"flex"===l.style.display&&(document.getElementById("currentBackgroundInfo").innerHTML="<b>現在の背景</b>: ローカルファイル (IndexedDB経由・永続化済み)",document.getElementById("bg-type-video").checked="video"===o,document.getElementById("bg-type-image").checked="image"===o),alert(`背景ファイル ${n.name} をプレビュー適用しました。\n「保存」ボタンを押して永続化してください。`)}catch(e){console.error("IndexedDB Save Error:",e),alert("エラー: ファイルの保存中に問題が発生しました。")}var a,r}(o,a),n.target.value=""}}),o&&o.addEventListener("click",async()=>{const e={...u,headerBgColor:s.value,headerTextColor:c.value,headerStrokeColor:p.value,opacity:parseInt(g.value),brightness:parseInt(b.value),showTimetable:document.getElementById("showTimetableCheckbox").checked,contentOpacity:parseInt(y.value),fontFamily:document.getElementById("fontFamilySelect").value,customFontName:document.getElementById("customFontNameInput").value,customFontUrl:document.getElementById("customFontUrlInput").value};await I(e),n.style.display="none",$(!0)}),i&&i.addEventListener("click",async()=>{const e=await w();T(e),q(e),M(e.contentOpacity),C(e),n.style.display="none"}),l&&l.addEventListener("click",async()=>{if(confirm("全てのカスタム設定を初期値に戻しますか？（時間割の内容はリセットされません）")){m&&(URL.revokeObjectURL(m),m=null);try{if(localStorage.removeItem(a),d){d.transaction([e],"readwrite").objectStore(e).clear()}else if(await k(),d){d.transaction([e],"readwrite").objectStore(e).clear()}}catch(e){console.warn("Failed to clear IndexedDB:",e)}await I(r),S(r),$(!0),alert("カスタム設定をリセットし、反映しました。")}})}()}function S(e){document.getElementById("headerBgColorInput").value=e.headerBgColor,document.getElementById("headerTextColorInput").value=e.headerTextColor,document.getElementById("headerStrokeColorInput").value=e.headerStrokeColor;const t=document.getElementById("currentBackgroundInfo"),n=document.getElementById("bg-type-video"),o=document.getElementById("bg-type-image");n.checked="video"===e.backgroundType,o.checked="image"===e.backgroundType,e.backgroundUrl.startsWith("blob:")?t.innerHTML="現在の背景: ローカルファイル (IndexedDB経由・永続化済み)":t.innerHTML="現在の背景: なし (ファイルを選択してください)",document.getElementById("opacityRange").value=e.opacity,document.getElementById("opacityValue").textContent=e.opacity,document.getElementById("brightnessRange").value=e.brightness,document.getElementById("brightnessValue").textContent=e.brightness,document.getElementById("showTimetableCheckbox").checked=e.showTimetable,document.getElementById("contentOpacityRange").value=e.contentOpacity,document.getElementById("contentOpacityValue").textContent=e.contentOpacity,document.getElementById("fontFamilySelect").value=e.fontFamily||"default",document.getElementById("customFontNameInput").value=e.customFontName||"",document.getElementById("customFontUrlInput").value=e.customFontUrl||""}function L(){const e=document.getElementById("opacityRange"),t=document.getElementById("brightnessRange");if(!e||!t)return;const n=parseInt(e.value),o=parseInt(t.value);document.getElementById("opacityValue").textContent=n,document.getElementById("brightnessValue").textContent=o,q({...u,opacity:n,brightness:o})}async function $(e=!0){e&&await w();const t=u;C(t),function(){if(document.querySelector(c)){if(!document.getElementById("background-video")){const e=document.createElement("video");e.id="background-video",e.loop=!0,e.autoplay=!0,e.muted=!0,e.playsInline=!0,e.style.cssText="\n                position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n                object-fit: cover; z-index: -100; display: none;\n                transition: opacity 0.5s ease, filter 0.5s ease;\n            ",document.body.prepend(e),e.oncanplaythrough=()=>{e.play().catch(e=>console.warn("Video autoplay blocked:",e))},e.onerror=e=>{u.backgroundUrl.startsWith("blob:")&&"video"===u.backgroundType&&console.error("Failed to load background VIDEO (Blob/IndexedDB).",e)}}if(!document.getElementById("background-image-container")){const e=document.createElement("div");e.id="background-image-container",e.style.cssText="\n                position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n                background-size: cover; background-position: center center;\n                background-repeat: no-repeat; z-index: -100; display: none;\n                transition: opacity 0.5s ease, filter 0.5s ease;\n            ",document.body.prepend(e)}}}(),T(t),q(t),M(t.contentOpacity),await R()}function C(e){let t=document.getElementById("custom-font-style");t||(t=document.createElement("style"),t.id="custom-font-style",(document.head||document.documentElement).appendChild(t));const n={default:{name:"",url:""},meiryo:{name:'"Meiryo", "メイリオ", "Hiragino Kaku Gothic ProN", sans-serif',url:""},yugothic:{name:'"Yu Gothic", "游ゴシック", "YuGothic", sans-serif',url:""},"biz-gothic":{name:'"BIZ UDPGothic", "BIZ UDPゴシック", sans-serif',url:""},notosans:{name:'"Noto Sans JP", sans-serif',url:"https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap"},zenmaru:{name:'"Zen Maru Gothic", sans-serif',url:"https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700&display=swap"},sawarabi:{name:'"Sawarabi Mincho", serif',url:"https://fonts.googleapis.com/css2?family=Sawarabi+Mincho&display=swap"},dotgothic:{name:'"DotGothic16", sans-serif',url:"https://fonts.googleapis.com/css2?family=DotGothic16&display=swap"},mochiy:{name:'"Mochiy Pop One", sans-serif',url:"https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&display=swap"},rampart:{name:'"Rampart One", cursive',url:"https://fonts.googleapis.com/css2?family=Rampart+One&display=swap"},antique:{name:'"Zen Antique Soft", sans-serif',url:"https://fonts.googleapis.com/css2?family=Kiwi+Maru&family=Monomaniac+One&family=RocknRoll+One&family=Zen+Antique+Soft&display=swap"},RocknRoll:{name:'"RocknRoll One", sans-serif',url:"https://fonts.googleapis.com/css2?family=Kiwi+Maru&family=Monomaniac+One&family=RocknRoll+One&family=Zen+Antique+Soft&display=swap"}};let o="",a="";e.customFontName&&""!==e.customFontName.trim()?(o=`"${e.customFontName}", sans-serif`,e.customFontUrl&&""!==e.customFontUrl.trim()&&(a=e.customFontUrl)):n[e.fontFamily]&&(o=n[e.fontFamily].name,a=n[e.fontFamily].url);let r="";o&&(a&&(r+=`@import url('${a}');\n`),r+=`\n                body, div, p, span, a, li, td, th, h1, h2, h3, h4, h5, h6, button, input, textarea, select, .block, .card {\n                    font-family: ${o} !important;\n                }\n                /* アイコンフォント保護 */\n                .fa, .fa-*, .icon, [class*="icon"], .fa-solid, .fa-regular, .fa-brands {\n                    font-family: "FontAwesome", "Font Awesome 6 Free", "Font Awesome 6 Brands" !important;\n                }\n            `),r+='\n           .count-container, \n            .badge, \n            .notification-count,\n            [data-region="count-container"] {\n                font-family: -apple-system, BlinkMacSystemFont, Roboto, Arial, sans-serif !important;\n                font-weight: bold !important;\n                font-size: 10px !important;\n                line-height: 16px !important;     /* ここを1.2から16pxに変更（高さと合わせて垂直中央揃えを確実に） */\n                letter-spacing: 0.5px !important; /* 少し文字間隔を広げてつぶれ防止 */\n                text-shadow: none !important;     /* 影を消してクッキリさせる */\n                display: inline-flex !important;\n                align-items: center !important;\n                justify-content: center !important;\n                min-width: 16px !important;\n                height: 16px !important;\n                padding: 0 4px !important;        /* パディングを微調整 */\n                border-radius: 10px !important;   /* 完全な丸みに */\n                box-sizing: border-box !important;\n            }\n\n            /* 通知0件の非表示対応 */\n            .count-container.hidden,\n            [data-region="count-container"].hidden,\n            .notification-count.hidden,\n            .count-container:empty {\n                display: none !important;\n            }\n        ',t.innerHTML=r}function T(e){let t=document.getElementById("custom-header-style");t||(t=document.createElement("style"),t.id="custom-header-style",(document.head||document.documentElement).appendChild(t));const n=`\n            -1px -1px 0 ${e.headerStrokeColor}, 1px -1px 0 ${e.headerStrokeColor},\n            -1px  1px 0 ${e.headerStrokeColor}, 1px  1px 0 ${e.headerStrokeColor}\n        `;t.innerHTML=`\n            .navbar.fixed-top.navbar-light.bg-white, .navbar {\n                background-color: ${e.headerBgColor} !important;\n                background-image: none !important;\n                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);\n                border-bottom: none !important;\n            }\n            .navbar-brand, .navbar-nav .nav-link, #customSettingsBtn {\n                color: ${e.headerTextColor} !important;\n                text-shadow: ${n};\n            }\n            .usernavigation .btn, .usernavigation .usermenu .btn {\n                color: ${e.headerTextColor} !important;\n                text-shadow: none !important;\n            }\n            \n            button.github-btn-mangesh636 {\n                 color: ${e.headerTextColor} !important;\n                 border: 1px solid ${e.headerTextColor} !important;\n            }\n            button.github-btn-mangesh636 svg {\n                 fill: ${e.headerTextColor} !important;\n            }\n        `}function q(e={}){const t={...u,...e},n=document.getElementById("background-video"),o=document.getElementById("background-image-container"),a=document.querySelector(c);if(!a)return;a.style.overflowX="hidden";const r=t.opacity/100,i=t.brightness/100;n&&o&&("video"===t.backgroundType&&t.backgroundUrl?(n.src=t.backgroundUrl,n.style.display="block",n.style.opacity=r.toString(),n.style.filter=`brightness(${i})`,o.style.display="none",o.style.backgroundImage="none"):"image"===t.backgroundType&&t.backgroundUrl?(o.style.backgroundImage=`url("${t.backgroundUrl}")`,o.style.display="block",o.style.opacity=r.toString(),o.style.filter=`brightness(${i})`,n.style.display="none",n.src=""):(n.style.display="none",n.src="",o.style.display="none",o.style.backgroundImage="none"))}function M(e){const t=e/100;let n=document.getElementById("custom-content-style");n||(n=document.createElement("style"),n.id="custom-content-style",(document.head||document.documentElement).appendChild(n));const o=Math.min(t+.2,1);n.innerHTML=`\n            .block, .card:not(.custom-card-style), .card-body, .card,\n            #secondary-navigation d-print-none, #page-content,\n            #region-main, #region-main-box, .bg-white, .main-inner {\n                background-color: rgba(255, 255, 255, ${t}) !important;\n            }\n            .card.custom-card-style {\n                background-color: rgba(255, 255, 255, ${o}) !important;\n                border: 1px solid rgba(255, 255, 255, 0.9) !important;\n            }\n        `}function F(e){return"string"!=typeof e?"":e.normalize("NFKC").replace(/\s| /g,"").replace(/（.*）$|\(.*\)$/,"")}function A(e){if(e<=0)return'<span style="color: #6c757d; font-weight: bold;">[ 期限切れ ]</span>';const t=Math.floor(e/86400),n=Math.floor(e%86400/3600),o=Math.floor(e%3600/60),a=Math.floor(e%60);let r=[],i="#333";return t>0?(r.push(`<b>${t}</b>日`),r.push(`<b>${n}</b>時間`),r.push(`<b>${o}</b>分`),t<=3&&(i="#E67E22")):n>0?(r.push(`<b>${n}</b>時間`),r.push(`<b>${o}</b>分`),r.push(`<b>${a}</b>秒`),i="#E67E22"):(r.push(`<b>${o}</b>分`),r.push(`<b>${a}</b>秒`),i="#dc3545"),`<span style="color: ${i}; font-weight: bold; font-size: 0.95em;">あと ${r.join(" ")}</span>`}function U(){const e=document.querySelectorAll(".custom-countdown-timer"),t=Math.floor(Date.now()/1e3);if(0===e.length&&f)return clearInterval(f),void(f=null);e.forEach(e=>{const n=parseInt(e.dataset.dueTimestamp,10);if(isNaN(n))return;const o=n-t;o>86400&&""!==e.innerHTML?t%60==0&&(e.innerHTML=A(o)):e.innerHTML=A(o)})}async function R(){const e=document.querySelector("#block-region-content");let t=document.getElementById("customTimetableWidget");if(document.URL.includes("/my/")&&e)if(u.showTimetable){const n=await N();t||(t=document.createElement("div"),t.id="customTimetableWidget",t.classList.add("card","mb-3","custom-card-style"),t.style.cssText="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); position: relative;",t.innerHTML='\n                    <div class="card-header"><h5 class="mb-0">カスタム時間割</h5></div>\n                    <div class="card-body" style="padding: 0;"></div>\n                ',e.prepend(t));const o=t.querySelector(".card-body");if(o){o.innerHTML=function(e,t){const n=new Date,o=s[n.getDay()],{periodNumber:a,status:r,course:i}=function(e){const t=new Date,n=s[t.getDay()],o=100*t.getHours()+t.getMinutes();for(const t of l)if(o>=t.start&&o<=t.end){const o=t.period.toString();return e[n]&&e[n][o]?{periodNumber:o,status:"授業中",course:e[n][o]}:{periodNumber:o,status:"空きコマ"}}for(let e=0;e<l.length-1;e++)if(o>l[e].end&&o<l[e+1].start)return{periodNumber:null,status:"休み時間"};return{periodNumber:null,status:"授業時間外"}}(e);let c=`\n            <div style="padding: 15px;">\n                <h4 style="margin-top: 0; display: flex; justify-content: space-between; align-items: center;">\n                    週間時間割\n                    <button id="editTimetableBtn" style="font-size: 0.7em; padding: 5px 10px; border: 1px solid #ccc; background-color: #f8f9fa; cursor: pointer; border-radius: 4px;">編集</button>\n                </h4>\n                <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px;">\n                    現在:\n                    ${"授業中"===r?`<span style="color: #dc3545;">${a}講時 - ${i.name}</span> <a href="${z(i.id)}" target="_self" style="font-size: 0.8em; margin-left: 10px;">[コースへ]</a>`:`<span style="color: #6c757d;">${r} ${a?`(${a}講時)`:""}</span>`}\n                </div>\n                <hr style="margin: 5px 0 15px 0;">\n                <table id="customTimetableTable" style="width: 100%; border-collapse: collapse; text-align: left; font-size: 0.95em;">\n                    <thead>\n                        <tr>\n                            <th style="padding: 8px; border-bottom: 2px solid #ccc;">時間</th>\n                            ${s.slice(1,6).map(e=>`<th style="padding: 8px; border-bottom: 1px solid #ccc; ${e===o?"color: #dc3545;":""}">${e}</th>`).join("")}\n                        </tr>\n                    </thead>\n                    <tbody>\n        `;for(const n of l){const r=n.period.toString(),i=`${Math.floor(n.start/100)}:${(n.start%100).toString().padStart(2,"0")}〜`;c+=`<tr><td style="padding: 8px; border-bottom: 1px solid #eee;">${r} (${i})</td>`;for(let n=1;n<=5;n++){const i=s[n],l=e[i]?e[i][r]:null;if(c+=`<td style="padding: 8px; ${i===o&&r===a?"background-color: rgba(14, 114, 181, 0.1); font-weight: bold; border-bottom: 3px solid #eee;":"border-bottom: 1px solid #eee;"}">`,l){c+=`<a href="${z(l.id)}" target="_self" style="color: #007bff; text-decoration: none;">${l.name}</a>`;const e=F(l.name),n=t.filter(t=>F(t.courseName).includes(e)).sort((e,t)=>e.dueTimestamp-t.dueTimestamp);n.length>0&&(c+="\n                            <ul style=\"\n                                font-size: 0.85em; \n                                color: #dc3545;\n                                margin: 5px 0 0 10px; \n                                padding-left: 10px; \n                                list-style-type: '!! ';\n                                line-height: 1.4;\n                                font-weight: 500;\n                            \">\n                        ",n.forEach(e=>{c+=`<li>\n                                <b>${e.assignmentName}</b>\n                                <div \n                                    class="custom-countdown-timer" \n                                    data-due-timestamp="${e.dueTimestamp}"\n                                >\n                                    </div>\n                                <span style="display: block; font-size: 0.9em; color: #6c757d;">\n                                    (締め切り: ${e.dueDateString})\n                                </span>\n                            </li>`}),c+="</ul>")}else c+='<span style="color: #6c757d;">-</span>';c+="</td>"}c+="</tr>"}return c+='\n                    </tbody>\n                </table>\n                <p style="font-size: 0.8em; color: #999; margin-top: 20px;">※コース名をクリックすると直接コースページへ移動します。</p>\n            </div>\n        ',c}(n,y),f&&clearInterval(f),U(),f=setInterval(U,1e3);const e=document.getElementById("editTimetableBtn");e&&e.addEventListener("click",async()=>{let e=document.getElementById("timetable-modal");e&&e.remove(),O(await N()),document.getElementById("timetable-modal").style.display="flex"})}}else t&&t.remove();else t&&t.remove()}function z(e){return`https://polite.do-johodai.ac.jp/moodle/course/view.php?id=${e}`}async function N(){let e;const t=(await chrome.storage.local.get(o))[o];if(t)try{e=JSON.parse(t)}catch(t){e=i}else e=i,chrome.storage.local.set({[o]:JSON.stringify(i)});return e}function O(e){if(document.getElementById("timetable-modal"))return;const t=function(e){const t=s.slice(1,6),n=l.map(e=>e.period.toString());let o=`\n            <p style="margin-bottom: 15px;">科目名とMoodleのコースIDを入力してください。（IDはURL <code>course/view.php?id=XXX</code> のXXX部分です）</p>\n            <div id="timetable-edit-grid" style="display: grid; grid-template-columns: 80px repeat(5, 1fr); gap: 10px; font-size: 0.9em;">\n                <div style="font-weight: bold;">時間</div>\n                ${t.map(e=>`<div style="font-weight: bold; text-align: center;">${e}</div>`).join("")}\n        `;for(const a of n){const n=l.find(e=>e.period.toString()===a),r=n?`${Math.floor(n.start/100)}:${(n.start%100).toString().padStart(2,"0")}`:"";o+=`<div style="font-weight: bold; line-height: 1.2;">${a}講時<br>(${r})</div>`;for(const n of t){const t=e[n]&&e[n][a]?e[n][a]:null;o+=`\n                    <div>\n                        <input type="text" id="name-${n}-${a}" placeholder="科目名" value="${t?t.name:""}" style="width: 100%; margin-bottom: 5px; padding: 4px;">\n                        <input type="number" id="id-${n}-${a}" placeholder="コースID" value="${t?t.id:""}" style="width: 100%; padding: 4px;">\n                    </div>\n                `}}return o+="</div>",`\n            <div id="timetable-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 10000; display: none; justify-content: center; align-items: center;">\n                <div id="timetable-modal-content" style="background-color: white; padding: 30px; border-radius: 8px; width: 95%; max-width: 900px; max-height: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; display: flex; flex-direction: column;">\n                    <h4 style="margin-top: 0; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">\n                        時間割編集\n                    </h4>\n                    <div style="overflow-y: auto; flex-grow: 1;">\n                        ${o}\n                    </div>\n                    <div style="margin-top: 20px; text-align: right; flex-shrink: 0;">\n                        <button id="saveTimetableBtn" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">\n                            保存\n                        </button>\n                        <button id="closeTimetableModal" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">\n                            閉じる\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `}(e);document.body.insertAdjacentHTML("beforeend",t);const n=document.getElementById("timetable-modal");document.getElementById("saveTimetableBtn").addEventListener("click",D),document.getElementById("closeTimetableModal").addEventListener("click",()=>{n.style.display="none"})}async function D(){const e=s.slice(1,6),t=l.map(e=>e.period.toString());let n={};for(const o of e){n[o]={};for(const e of t){const t=document.getElementById(`name-${o}-${e}`),a=document.getElementById(`id-${o}-${e}`),r=t?t.value.trim():"",i=a?a.value.trim():"";r&&i&&!isNaN(parseInt(i))&&(n[o][e]={name:r,id:parseInt(i)})}}n["土"]={},n["日"]={},await async function(e){await chrome.storage.local.set({[o]:JSON.stringify(e)})}(n),document.getElementById("timetable-modal").style.display="none",await R()}function j(){confirm("解き直しモードを終了しますか？\n（ページがリロードされ、元のレビュー画面に戻ります）")&&window.location.reload()}function H(){if(!g){if(p.clear(),document.querySelectorAll("div.que").forEach(e=>{const t=e.id;if(!t)return;let n={type:null,answer:null};const o=e.querySelector(".feedback .rightanswer");let a="";if(o&&(a=o.textContent.trim()),e.classList.contains("multichoice")){n.type="multichoice";const t=e.querySelector('.answer .correct input[type="radio"], .answer .correct input[type="checkbox"]');t&&(n.answer=t.value)}else if(e.classList.contains("truefalse"))if(n.type="truefalse",a.includes("正解は「○」です")||a.toLowerCase().includes("the correct answer is 'true'"))n.answer="1";else if(a.includes("正解は「×」です")||a.toLowerCase().includes("the correct answer is 'false'"))n.answer="0";else{const t=e.querySelector('.answer .correct input[type="radio"]');t&&(n.answer=t.value)}else if(e.classList.contains("numerical")){if(n.type="numerical",a){const e=a.match(/(?:正解|The correct answer is):\s*([0-9.,]+)/i);e&&e[1]&&(n.answer=e[1].replace(",","."))}}else if(e.classList.contains("shortanswer")){if(n.type="shortanswer",a){const e=a.match(/(?:正解|The correct answer is):\s*(.*)/i);e&&e[1]&&(n.answer=e[1])}}else if(e.classList.contains("gapselect")){n.type="gapselect";const t={},a=[...(o?o.innerHTML:"").matchAll(/\[([\s\S]*?)\]/g)],r=e.querySelectorAll("select");a.length>0&&r.length>0&&r.forEach((e,n)=>{const o=e.id;if(!o)return;let r=null;if(a[n]&&a[n][1]){const t=a[n][1].replace(/<[^>]+>/g,"").trim(),o=e.querySelectorAll("option");for(const e of o)if(e.textContent.trim()===t){r=e.value;break}}null!==r&&(t[o]=r)}),n.answer=t}else if(e.classList.contains("match")){n.type="match";const t={},a={};let r=o?o.innerHTML:"";r=r.replace(/<(p|div|br)[^>]*>/gi,"|||"),r=r.replace(/<[^>]+>/g,""),r=r.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">"),r.split("|||").forEach(e=>{if((e=e.trim()).includes("→")){const t=e.match(/(.+?)\s*→\s*(.+)/);if(t&&t[1]&&t[2]){let e=t[1].trim(),n=t[2].trim().replace(/,$/,"").trim();e&&n&&(e.startsWith("正解:")&&(e=e.substring(3).trim()),e&&(a[e]=n))}}}),e.querySelectorAll(".ablock .answer tr").forEach(e=>{const n=e.querySelector(".text"),o=e.querySelector(".control select");if(!n||!o)return;const r=n.textContent.trim();let i=a[r];if(!i){const e=Object.keys(a).find(e=>r.includes(e)||e.includes(r));if(!e)return;i=a[e]}let l=null;const s=o.querySelectorAll("option");for(const e of s)if(e.textContent.trim()===i){l=e.value;break}null!==l&&(t[o.id]=l)}),n.answer=t}n.type&&null!==n.answer&&(Object.keys(n.answer).length>0||"object"!=typeof n.answer)&&p.set(t,n)}),0===p.size)return void alert("エラー: 問題の正解をページから読み取れませんでした。");g=!0}b=new Date,document.querySelectorAll(".state, .grade, .outcome").forEach(e=>{e.style.display="none"}),document.querySelectorAll("i.fa-circle-check, i.fa-circle-xmark").forEach(e=>{e.classList.contains("retake-feedback-icon")||(e.style.display="none")}),document.querySelectorAll("div.que.numerical .ablock i.icon, div.que.shortanswer .ablock i.icon").forEach(e=>{e.classList.contains("retake-feedback-icon")||(e.style.display="none")}),document.querySelectorAll("div.que.gapselect .qtext i.icon").forEach(e=>{e.classList.contains("retake-feedback-icon")||(e.style.display="none")}),document.querySelectorAll("div.que.match .control i.icon").forEach(e=>{e.classList.contains("retake-feedback-icon")||(e.style.display="none")}),_(),document.getElementById("startRetakeBtn").style.display="none",document.getElementById("gradeRetakeBtn").style.display="inline-block",document.getElementById("resetRetakeBtn").style.display="inline-block",document.getElementById("exitRetakeBtn").style.display="block"}function _(){document.querySelectorAll("div.que").forEach(e=>{e.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(e=>{e.disabled=!1,e.checked=!1}),e.querySelectorAll('input[type="text"]').forEach(e=>{e.name&&e.name.endsWith("_answer")&&(e.disabled=!1,e.readOnly=!1,e.value="",e.classList.remove("correct","incorrect"))}),e.querySelectorAll("select").forEach(e=>{e.name&&e.name.includes(":")&&(e.disabled=!1,e.selectedIndex=0,e.classList.remove("correct","incorrect"))}),e.querySelectorAll(".state, .grade, .outcome").forEach(e=>{e.style.display="none",e.classList.contains("state")&&(e.style.color="",e.textContent="")}),e.querySelectorAll("i.fa-circle-check, i.fa-circle-xmark").forEach(e=>{e.classList.contains("retake-feedback-icon")||(e.style.display="none")}),e.querySelectorAll(".retake-feedback-icon").forEach(e=>{e.remove()});const t=e.querySelector(".ablock .icon");t&&(e.classList.contains("numerical")||e.classList.contains("shortanswer"))&&(t.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),t.style.display="none",t.setAttribute("title",""),t.setAttribute("aria-label","")),e.querySelectorAll("div.que.gapselect .qtext i.icon").forEach(e=>{e.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),e.style.display="none",e.setAttribute("title",""),e.setAttribute("aria-label","")}),e.querySelectorAll("div.que.match .control i.icon").forEach(e=>{e.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),e.style.display="none",e.setAttribute("title",""),e.setAttribute("aria-label","")})});const e=document.getElementById("retake-result");e&&(e.innerHTML=""),b=new Date}function P(){_()}function V(){const e=new Date;let t=0,n=0;p.forEach((e,o)=>{const a=document.getElementById(o);if(!a)return;const r=a.querySelector(".state"),i=a.querySelector(".outcome"),l=a.querySelector(".grade");let s=0;if(l){const e=l.textContent.match(/[0-9.]+\s*\/\s*([0-9.]+)/);e&&e[1]&&(s=parseFloat(e[1]))}t+=s;let c=0,d=!1;const u=o.split("-");if(u.length<3)return;const m=`q${u[1]}:${u[2]}_answer`,p=e=>{const t=e?"正解":"不正解";return`<span class="ms-1 retake-feedback-icon">\n                             <i class="icon fa-regular ${e?"fa-circle-check text-success":"fa-circle-xmark text-danger"} fa-fw" title="${t}" role="img" aria-label="${t}"></i>\n                         </span>`};if("multichoice"===e.type){const t=a.querySelector(`input[name="${m}"]:checked`);t&&t.value===e.answer&&(d=!0),a.querySelectorAll(`.answer input[name="${m}"]`).forEach(n=>{const o=n.value===e.answer,a=t&&n.value===t.value,r=n.closest(".r0, .r1");r&&(o?r.insertAdjacentHTML("beforeend",p(!0)):a&&!d&&r.insertAdjacentHTML("beforeend",p(!1)))})}else if("truefalse"===e.type){const t=a.querySelector(`input[name="${m}"]:checked`);t&&t.value===e.answer&&(d=!0),a.querySelectorAll(`.answer input[name="${m}"]`).forEach(n=>{const o=n.value===e.answer,a=t&&n.value===t.value,r=n.closest(".r0, .r1");r&&(o?r.insertAdjacentHTML("beforeend",p(!0)):a&&!d&&r.insertAdjacentHTML("beforeend",p(!1)))})}else if("numerical"===e.type||"shortanswer"===e.type){const t=a.querySelector(`input[name="${m}"]`),n=t?t.value.trim():"",o="numerical"===e.type?e.answer.replace(",","."):e.answer;("numerical"===e.type?n.replace(",","."):n).toLowerCase()===o.toLowerCase()&&(d=!0),t&&(t.classList.remove("correct","incorrect"),t.classList.add(d?"correct":"incorrect"));let r=t?t.nextElementSibling:null;r&&"I"===r.tagName||(r=t?t.parentElement.nextElementSibling:null),r&&"I"===r.tagName&&r.classList.contains("icon")&&(r.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),d?(r.classList.add("fa-regular","fa-circle-check","text-success"),r.setAttribute("title","正解"),r.setAttribute("aria-label","正解")):(r.classList.add("fa-regular","fa-circle-xmark","text-danger"),r.setAttribute("title","不正解"),r.setAttribute("aria-label","不正解")),r.style.display="inline-block",r.classList.add("retake-feedback-icon"))}else if("gapselect"===e.type){let t=!0,o=0;const r=a.querySelectorAll("select");let i=0;0===r.length&&(t=!1),r.forEach(n=>{if(!n.name||!n.name.includes(":"))return;i++;const a=n.id,r=e.answer[a],l=n.value;let s=void 0!==r&&l===r;s?o++:t=!1,n.classList.remove("correct","incorrect"),n.classList.add(s?"correct":"incorrect");const c=n.nextElementSibling;c&&"I"===c.tagName&&c.classList.contains("icon")&&(c.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),s?(c.classList.add("fa-regular","fa-circle-check","text-success"),c.setAttribute("title","正解"),c.setAttribute("aria-label","正解")):(c.classList.add("fa-regular","fa-circle-xmark","text-danger"),c.setAttribute("title","不正解"),c.setAttribute("aria-label","不正解")),c.style.display="inline-block",c.classList.add("retake-feedback-icon"))}),d=t,i>0?c=s*(o/i):r.length>0&&(c=s*(o/r.length)),n+=c}else if("match"===e.type){let t=!0,o=0;const r=a.querySelectorAll(".ablock .answer select");0===r.length&&(t=!1),r.forEach(n=>{const a=n.id,r=e.answer[a],i=n.value;let l=void 0!==r&&i===r;l?o++:t=!1,n.classList.remove("correct","incorrect"),n.classList.add(l?"correct":"incorrect");const s=n.closest(".control");if(s){const e=s.querySelector("i.icon");e&&(e.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),l?(e.classList.add("fa-regular","fa-circle-check","text-success"),e.setAttribute("title","正解"),e.setAttribute("aria-label","正解")):(e.classList.add("fa-regular","fa-circle-xmark","text-danger"),e.setAttribute("title","不正解"),e.setAttribute("aria-label","不正解")),e.style.display="inline-block",e.classList.add("retake-feedback-icon"))}}),d=t,r.length>0&&(c=s*(o/r.length)),n+=c}"gapselect"!==e.type&&"match"!==e.type&&d&&(c=s,n+=s),r&&(("gapselect"===e.type||"match"===e.type)&&!d&&c>0?(r.textContent="部分的に正解",r.style.color="#FF8C00"):(r.textContent=d?"正解":"不正解",r.style.color=d?"#28a745":"#dc3545"),r.style.display="block"),l&&(l.innerHTML=`${c.toFixed(2)} / ${s.toFixed(2)}`,l.style.display="block"),i&&(i.style.display="block")});const o=document.getElementById("retake-result");if(o){let a="-";if(b){const t=e.getTime()-b.getTime(),n=Math.round(t/1e3);a=`${Math.floor(n/60)} 分 ${n%60} 秒`}const r=e=>{if(!e)return"-";const t={year:"numeric",month:"long",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit",hour12:!1};try{return e.toLocaleString("ja-JP",t)}catch(t){return e.toLocaleString()}},i=t>0?n/t*100:0;let l=`\n                <h3 style="margin-top: 1.5rem; border-bottom: 1px solid #ddd; padding-bottom: 5px;">解き直し結果</h3>\n                <div class="mb-3">\n                    <table class="table generaltable generalbox quizreviewsummary mb-0">\n                       <caption class="visually-hidden">結果の概要</caption>\n                       <tbody>\n                            <tr>\n                                <th class="cell" scope="row">ステータス</th>\n                                <td class="cell">解き直し完了</td>\n                            </tr>\n                            <tr>\n                                <th class="cell" scope="row">開始日時</th>\n                                <td class="cell">${r(b)}</td>\n                            </tr>\n                            <tr>\n                                <th class="cell" scope="row">完了日時</th>\n                                <td class="cell">${r(e)}</td>\n                            </tr>\n                            <tr>\n                                <th class="cell" scope="row">継続時間</th>\n                                <td class="cell">${a}</td>\n                            </tr>\n                            <tr>\n                                <th class="cell" scope="row">評点</th>\n                                <td class="cell"><b>${n.toFixed(2)}</b> / ${t.toFixed(2)} (<b>${i.toFixed(0)}</b>%)</td>\n                            </tr>\n                       </tbody>\n                    </table>\n                </div>\n            `;Math.abs(t-n)<.001?l+='<p style="color: #028dffff; font-weight: bold; font-size: 1.1em; margin-top: 1rem;">素晴らしい！全問正解です！</p>':l+='<p style="color: #ff3131e1; font-size: 1.1em; margin-top: 1rem;">間違えた問題を確認して「リセット」でもう一度挑戦できます。</p>',o.innerHTML=l,b=new Date}}!async function(){!function(){const e=document.createElement("style");e.innerHTML=`\n            /* ヘッダーの透明化 */\n            #page-header, .page-context-header, #page {\n                background-color: transparent !important;\n                border-bottom: none !important;\n            }\n\n            /* ヘッダーのドロップダウンなど */\n            .navbar-nav .nav-item .nav-link:hover,\n            .navbar-nav .nav-item.open > .nav-link {\n                background-color: rgba(0, 0, 0, 0.3) !important;\n                border-radius: 4px;\n            }\n            .navbar-nav .nav-item.dropdown .dropdown-menu {\n                background-color: #ffffff !important;\n                box-shadow: 0 5px 10px rgba(0,0,0,0.2);\n            }\n            .navbar-nav .nav-item.dropdown .dropdown-menu a.dropdown-item {\n                color: #000000 !important;\n                text-shadow: none !important;\n            }\n            .page-context-header .page-header-headings h1,\n            .page-context-header a {\n                color: #000000 !important;\n            }\n            #usernavigation .usermenu {\n                 display: flex;\n                 align-items: center;\n            }\n            #customSettingsBtn {\n                 margin-right: 5px;\n            }\n\n            /* 背景とコンテンツ */\n            ${c} {\n                background-color: #f0f2f5 !important;\n                overflow-x: hidden !important;\n            }\n            #background-video, #background-image-container {\n                 transition: opacity 0.5s ease, filter 0.5s ease;\n            }\n            #page, #page-wrapper {\n                background-color: transparent !important;\n                z-index: 1;\n                position: relative;\n            }\n            .main-inner, .secondary-navigation d-print-none, .moremenu navigation observed, .nav more-nav nav-tabs, .card-footer border-0 bg-white w-100 {\n                background-color:  rgba(255, 255, 255, 1) !important;\n            }\n            :is(#secondary-navigation d-print-none, #page-content, #region-main, #region-main-box, .block) {\n                background-color: transparent !important;\n                z-index: 1;\n                position: relative;\n            }\n            .section {\n                 border-bottom: 2px solid rgba(255, 255, 255, 0.4) !important;\n                 margin-bottom: 10px !important;\n            }\n            .card-footer, .bg-white, .form-control, .page-item, .pagination mb-0, .pagination, .secondary-navigation, .secondary-navigation, .card-foote {\n                background-color: transparent !important;\n            }\n            :is(nav, .primary-navigation, .secondary-navigation, .nav, .nav-tabs, .moremenu, .course-section-header, .section-item) {\n                background-color: transparent !important;\n            }\n            .block * { color: #000000; }\n            .block a, .card a { color: #0d6efd; }\n\n            /* その他 */\n            .deadline-highlight {\n                border: 1px solid #ff4d4d !important;\n                background-color: rgba(255, 240, 240, 0.3) !important;\n                box-shadow: 0 0 8px rgba(255, 0, 0, 0.5) !important;\n            }\n            .block, .card:not(.custom-card-style) {\n                border: 0px solid rgba(255, 255, 255, 0.8) !important;\n                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);\n                transition: box-shadow 0.3s ease-in-out, background-color 0.3s ease;\n                z-index: 1;\n                position: relative;\n            }\n            .card.custom-card-style {\n                border: 1px solid rgba(255, 255, 255, 0.9) !important;\n            }\n            #customTimetableTable th {\n                 border-bottom-color: #aaa !important;\n                 border-bottom-width: 2px !important;\n                 border-left: 2px solid #ccc !important;\n            }\n            #customTimetableTable td {\n                 border-bottom-color: #f0f0f0 !important;\n                 border-bottom-width: 2px !important;\n                 border-left: 2px solid #f0f0f0 !important;\n            }\n            .section {\n                 border-bottom: 2px solid rgba(255, 255, 255, 0.4) !important;\n                 margin-bottom: 1px !important;\n            }\n            .section-item {\n                border: none !important;\n            }\n\n            /* ★★★ GitHub Button V2 Styles */\n            button.github-btn-mangesh636 {\n              background: transparent;\n              position: relative;\n              padding: 5px 10px; \n              display: flex;\n              align-items: center;\n              font-size: 15px; \n              font-weight: 600;\n              text-decoration: none;\n              cursor: pointer;\n              border: 1px solid rgb(36, 41, 46);\n              border-radius: 25px;\n              outline: none;\n              overflow: hidden;\n              color: rgb(36, 41, 46);\n              transition: color 0.3s 0.1s ease-out, border-color 0.3s 0.1s ease-out;\n              text-align: center;\n              height: 38px; \n            }\n\n            button.github-btn-mangesh636 span {\n              margin: 0 5px; \n            }\n\n            button.github-btn-mangesh636 svg {\n              transition: fill 0.3s 0.1s ease-out;\n            }\n\n            button.github-btn-mangesh636::before {\n              position: absolute;\n              top: 0;\n              left: 0;\n              right: 0;\n              bottom: 0;\n              margin: auto;\n              content: "";\n              border-radius: 50%;\n              display: block;\n              width: 20em;\n              height: 20em;\n              left: -5em;\n              text-align: center;\n              transition: box-shadow 0.5s ease-out;\n              z-index: -1;\n            }\n\n            button.github-btn-mangesh636:hover {\n              color: #fff !important; \n              border: 1px solid rgb(36, 41, 46) !important;\n            }\n            \n            button.github-btn-mangesh636:hover svg {\n               fill: #fff !important; \n            }\n\n            button.github-btn-mangesh636:hover::before {\n              box-shadow: inset 0 0 0 10em rgb(36, 41, 46);\n            }\n              /* --- Quiz Retake Mode Styles (v2) --- */\n            .retake-controls-card {\n                background-color: #ffffff;\n                border: 1px solid #ddd;\n                border-radius: 8px;\n                padding: 20px;\n                margin-bottom: 20px;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.08);\n                position: relative; \n            }\n            .retake-controls-card h4 {\n                margin-top: 0;\n                color: #005A9C; \n                font-weight: 600;\n                border-bottom: 1px solid #eee;\n                padding-bottom: 10px;\n                margin-bottom: 10px;\n                display: flex;\n                align-items: center;\n                gap: 8px; \n            }\n            .retake-controls-card p {\n                font-size: 0.95em;\n                color: #555;\n                margin-bottom: 20px;\n            }\n            .retake-controls-card .button-group {\n                display: flex;\n                gap: 12px;\n                flex-wrap: wrap;\n            }\n            .retake-btn {\n                padding: 10px 18px;\n                border: none;\n                border-radius: 5px;\n                cursor: pointer;\n                font-size: 0.95em; \n                font-weight: 600; \n                transition: all 0.2s ease;\n                text-decoration: none;\n                display: inline-flex; \n                align-items: center;\n                gap: 6px; \n                text-align: center;\n                line-height: 1.2;\n            }\n            .retake-btn-primary {\n                background-color: #007bff; \n                color: white;\n            }\n            .retake-btn-primary:hover {\n                background-color: #0056b3;\n                box-shadow: 0 2px 5px rgba(0,0,0,0.15);\n                transform: translateY(-1px);\n            }\n            .retake-btn-secondary {\n                background-color: #f8f9fa;\n                color: #333;\n                border: 1px solid #ccc;\n            }\n            .retake-btn-secondary:hover {\n                background-color: #e9ecef;\n                border-color: #bbb;\n            }\n            .retake-btn-exit {\n                position: absolute;\n                top: 15px;\n                right: 15px;\n                background: none;\n                border: none;\n                font-size: 1.5rem;\n                color: #888;\n                cursor: pointer;\n                padding: 5px;\n                line-height: 1;\n                transition: color 0.2s ease;\n            }\n            .retake-btn-exit:hover {\n                color: #333;\n            }\n        `,(document.head||document.documentElement).appendChild(e)}(),await k();const e=await w();localStorage.getItem(a)||E(e),document.body?v(e):document.addEventListener("DOMContentLoaded",()=>v(e))}()}();