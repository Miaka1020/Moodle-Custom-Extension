!function(){"use strict";const e="background_files",t="current_bg",n="moodle_custom_settings_v5",a="moodle_custom_timetable_v2",o="moodle_fast_font_cache_v2",r="darkmode_enabled_v1",i="darkmode_settings_v1";let d=[],l=null;const s={headerBgColor:"#ffffff",headerTextColor:"#000000",headerStrokeColor:"#ffffff",backgroundUrl:"",backgroundType:"none",opacity:80,brightness:100,showTimetable:!0,enableCustomLayout:!1,contentOpacity:70,fontFamily:"default",customFontName:"",customFontUrl:"",darkModeMode:"off",darkModeBrightness:100,darkModeContrast:100,darkModeGrayscale:0,darkModeSepia:0},c={月:{},火:{},水:{},木:{},金:{},土:{},日:{}},m=[{start:900,end:1030,period:1},{start:1040,end:1210,period:2},{start:1255,end:1425,period:3},{start:1435,end:1605,period:4},{start:1615,end:1745,period:5},{start:1755,end:1925,period:6}],u=["日","月","火","水","木","金","土"],p="body#page-my-index, body#page-course-view-topics, body#page-course-view-weeks,body#page";let g,b={},h=null,y=new Map,f=!1,k=null,v=[],x=null,w=null,E=0;try{const e=localStorage.getItem(o);e&&j(JSON.parse(e))}catch(e){console.warn("Fast font apply failed:",e)}try{const e=localStorage.getItem(r)||"off",t=window.matchMedia("(prefers-color-scheme: dark)").matches,n="on"===e||"auto"===e&&t;if(n&&"loading"===document.readyState){const e="\n        /* Hide everything momentarily to prevent white flash */\n        /* Fix: Make visibility:hidden depend on dark-fouc-mask class */\n        html:not(.dark-fouc-mask-ready) { \n            visibility: hidden !important; \n            background-color: #303030 !important;\n        }\n        /* Class to display after Dark Reader loads. Added in init() or navigation */\n        html.dark-fouc-mask-ready { \n            visibility: visible !important; \n        }\n    ",t=document.createElement("style");t.id="extreme-fouc-fix",t.textContent=e,(document.head||document.documentElement).prepend(t),document.documentElement.classList.add("dark-fouc-mask")}else n&&document.documentElement.classList.add("dark-fouc-mask")}catch(e){}function B(){const e=document.getElementById("moodle-custom-loading-screen");if(!e)return;const t=500-(Date.now()-l);if(t>0)return void setTimeout(()=>{B()},t);e.style.pointerEvents="none",e.style.opacity="0",setTimeout(()=>{e.remove()},300);const n=document.getElementById("darkmode-loading-screen");n&&(n.style.pointerEvents="none",n.style.opacity="0",setTimeout(()=>{n.remove()},300)),document.documentElement.classList.remove("dark-fouc-mask")}function I(e){!function(e){let t=document.getElementById("darkreader-settings-data");t||(t=document.createElement("script"),t.id="darkreader-settings-data",t.type="application/json",document.head.appendChild(t)),t.textContent=JSON.stringify(e);let n=document.getElementById("darkreader-library-script");n||(n=document.createElement("script"),n.id="darkreader-library-script",n.src=chrome.runtime.getURL("darkreader.js"),n.setAttribute("data-skip-loader","true"),document.head.appendChild(n));let a=document.getElementById("dr-init-bridge-script");a&&a.remove(),a=document.createElement("script"),a.id="dr-init-bridge-script",a.src=chrome.runtime.getURL("dr_init_bridge.js"),document.head.appendChild(a)}(e)}async function M(e){!function(){const e=document.querySelector("#usernavigation .usermenu");if(!e||document.getElementById("custom-github-nav-item"))return;const t=document.createElement("li");t.classList.add("nav-item"),t.id="custom-github-nav-item",t.style.cssText="display: flex; align-items: center;",t.innerHTML='\n          <button id="githubLinkBtnV2" class="github-btn-mangesh636" title="GitHubリポジトリを開く" style="margin-right: 5px;">\n            <svg viewBox="0 0 24 24" fill="currentColor" height="20" width="20" xmlns="http://www.w3.org/2000/svg">\n              <path d="M12.001 2C6.47598 2 2.00098 6.475 2.00098 12C2.00098 16.425 4.86348 20.1625 8.83848 21.4875C9.33848 21.575 9.52598 21.275 9.52598 21.0125C9.52598 20.775 9.51348 19.9875 9.51348 19.15C7.00098 19.6125 6.35098 18.5375 6.15098 17.975C6.03848 17.6875 5.55098 16.8 5.12598 16.5625C4.77598 16.375 4.27598 15.9125 5.11348 15.9C5.90098 15.8875 6.46348 16.625 6.65098 16.925C7.55098 18.4375 8.98848 18.0125 9.56348 17.75C9.65098 17.1 9.91348 16.6625 10.201 16.4125C7.97598 16.1625 5.65098 15.3 5.65098 11.475C5.65098 10.3875 6.03848 9.4875 6.67598 8.7875C6.57598 8.5375 6.22598 7.5125 6.77598 6.1375C6.77598 6.1375 7.61348 5.875 9.52598 7.1625C10.326 6.9375 11.176 6.825 12.026 6.825C12.876 6.825 13.726 6.9375 14.526 7.1625C16.4385 5.8625 17.276 6.1375 17.276 6.1375C17.826 7.5125 17.476 8.5375 17.376 8.7875C18.0135 9.4875 18.401 10.375 18.401 11.475C18.401 15.3125 16.0635 16.1625 13.8385 16.4125C14.201 16.725 14.5135 17.325 14.5135 18.2625C14.5135 19.6 14.501 20.675 14.501 21.0125C14.501 21.275 14.6885 21.5875 15.1885 21.4875C19.259 20.1133 21.9999 16.2963 22.001 12C22.001 6.475 17.526 2 12.001 2Z"></path>\n            </svg>\n            <span>GitHub</span>\n          </button>\n        ',e.prepend(t),document.getElementById("githubLinkBtnV2").addEventListener("click",()=>{window.open("https://github.com/Miaka1020/Moodle-Custom-Extension/","_blank")})}(),function(){const e=document.querySelector("#usernavigation .usermenu");if(!e||document.getElementById("customSettingsBtn"))return;const t=document.createElement("li");t.classList.add("nav-item"),t.innerHTML='\n            <button id="customSettingsBtn" class="btn nav-link" style="\n                background: none; border: none; padding: 0.5rem 0.8rem;\n                cursor: pointer; font-size: 1.25rem; line-height: 1;\n            " title="Moodleカスタム設定">\n                <i class="icon fa fa-cog" aria-hidden="true"></i> </button>\n        ',e.prepend(t),document.getElementById("customSettingsBtn").addEventListener("click",async()=>{const e=await T();let t=document.getElementById("custom-settings-modal");t||(R(e),t=document.getElementById("custom-settings-modal")),A(e),t.style.display="flex",document.body.style.overflow="hidden"})}(),R(e),J(await G()),await D(!1),document.URL.includes("/my/")&&(w&&clearInterval(w),E=0,w=setInterval(async()=>{E++,document.querySelector('.block_timeline [data-region="event-list-content-date"]')?(clearInterval(w),w=null,function(){if(v=[],!document.URL.includes("/my/"))return;const e=document.querySelector(".block_timeline");if(!e)return;const t=e.querySelectorAll('[data-region="event-list-content-date"]'),n=new Date,a=n.getFullYear();t.forEach(e=>{const t=parseInt(e.getAttribute("data-timestamp"));if(isNaN(t))return;const o=new Date(1e3*t),r=e.nextElementSibling;r&&r.querySelectorAll('[data-region="event-list-item"]').forEach(e=>{try{const t=e.querySelector(".event-name-container a");if(!t)return;const r=t.textContent.trim();let i=null;const d=e.querySelector(".event-name-container small.mb-0");if(d){const e=d.textContent.trim(),t=e.split(/[·・]/);i=t.length>1?t[t.length-1].trim():e}if(!i)return;const l=e.querySelector(".timeline-name > small.text-nowrap");let s=0,c=0;if(l){const e=l.textContent.trim().match(/(\d{1,2}):(\d{2})/);e&&(s=parseInt(e[1]),c=parseInt(e[2]))}const m=new Date(o.getTime());m.setHours(s,c,0,0),m.getMonth()<n.getMonth()-6?m.setFullYear(a+1):m.setFullYear(a);const u=Math.floor(m.getTime()/1e3),p=`${m.getMonth()+1}/${m.getDate()} ${String(s).padStart(2,"0")}:${String(c).padStart(2,"0")}`;v.push({courseName:i,assignmentName:r,dueTimestamp:u,dueDateString:p})}catch(e){console.warn("Deadline parse error:",e)}})}),console.log(`Moodle Customizer: ${v.length} deadlines found.`,v)}(),function(){if(!document.URL.includes("/my/"))return;const e=document.querySelector(".block_timeline");if(!e)return;const t=e.querySelectorAll('[data-region="event-list-content-date"]'),n=new Date;n.setHours(0,0,0,0);const a=new Date(n.getTime()+6048e5);t.forEach(e=>{const t=parseInt(e.getAttribute("data-timestamp")),o=new Date(1e3*t);if(o>=n&&o<a){const t=e.nextElementSibling;t&&t.querySelectorAll('[data-region="event-list-item"]').forEach(e=>{const t=e.querySelector(".event-name-container small.mb-0")?.textContent||"";(t.includes("due")||t.includes("closes")||t.includes("提出期限")||t.includes("終了"))&&e.classList.add("deadline-highlight")})}})}(),v.length>0&&await V()):E>60&&(clearInterval(w),w=null)},200)),document.URL.includes("/mod/quiz/review.php")&&function(){if(!document.URL.includes("/mod/quiz/review.php")||document.getElementById("retake-controls"))return;const e=document.querySelector('#region-main > [role="main"]');if(!e)return;const t=document.createElement("div");t.id="retake-result";const n=document.createElement("div");n.id="retake-controls",n.className="retake-controls-card",n.innerHTML='\n            <button id="exitRetakeBtn" class="retake-btn-exit" title="解き直しを終了" style="display: none;">×</button>\n            <h4>解き直し学習モード</h4>\n            <p>Moodleの成績には影響しません。何度でも問題を解き直して復習できます。</p>\n            <div class="button-group">\n                <button id="startRetakeBtn" class="retake-btn retake-btn-primary">\n                解き直しモードを開始\n                </button>\n                <button id="gradeRetakeBtn" class="retake-btn retake-btn-primary" style="display: none;">\n                採点\n                </button>\n                <button id="resetRetakeBtn" class="retake-btn retake-btn-secondary" style="display: none;">\n                    <i class="fa fa-refresh" aria-hidden="true"></i> リセット\n                </button>\n            </div>\n        ',e.prepend(n),e.prepend(t),document.getElementById("startRetakeBtn").addEventListener("click",Q),document.getElementById("gradeRetakeBtn").addEventListener("click",ne),document.getElementById("resetRetakeBtn").addEventListener("click",te),document.getElementById("exitRetakeBtn").addEventListener("click",K)}(),function(){const e=["nav.navbar .navbar-brand",".navbar-brand","#page-header .navbar-brand","header .site-name a"];for(const t of e){const e=document.querySelector(t);if(e&&e.textContent.trim().length>0)return e.innerHTML='POLITE<sup style="font-size: 0.9em; top: -0.4em; margin-left: 2px;">+</sup>',e.style.fontWeight="700",e.style.letterSpacing="1.5px",e.style.display="inline-flex",e.style.alignItems="center",void console.log('Moodle Customizer: Site title changed to "POLITE+".')}console.warn("Moodle Customizer: Site title element not found.")}(),function(){const e=['a[href*="course/view.php"]','a[href*="/my/"]','a[href*="/mod/"]',"#nav-drawer a",".list-group-item-action",".navbar-nav .nav-link","a.btn"];document.addEventListener("click",t=>{let n=t.target.closest(e.join(","));if(n&&"A"===n.tagName){const e=n.getAttribute("href");!e||e.startsWith("#")||e.startsWith("javascript")||(document.documentElement.classList.contains("dark-fouc-mask")||"on"===b.darkModeMode||"auto"===b.darkModeMode&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&(document.documentElement.classList.add("dark-fouc-mask"),window.scrollTo(0,0))}},!0)}()}function S(){const e=document.querySelectorAll('a[href*="course/view.php?id="]'),t=new Map;e.forEach(e=>{const n=e.getAttribute("href").match(/id=(\d+)/);if(n){const a=n[1];let o=e.textContent.trim();o||(o=e.getAttribute("title")||e.getAttribute("aria-label")||""),o&&o.length>2&&!t.has(a)&&(["コース","詳細","Course","Grades","Competencies","成績","詳細を見る"].includes(o)||t.set(a,o))}}),d=Array.from(t,([e,t])=>({id:e,name:t})),console.log(`Moodle Customizer: ${d.length} courses scanned.`)}function C(e){return"string"!=typeof e?"":e.toLowerCase().normalize("NFKC").replace(/\s| |　/g,"").replace(/（.*）$|\(.*\)$/,"")}function L(e){const t=document.getElementById("dashboard-fullwidth-layout-css");t&&(document.URL.includes("/my/")&&!document.URL.includes("/my/courses.php")?t.innerHTML=e?"\n                /* 1. Force release page width limit */\n                @media (min-width: 992px) {\n                    body.limitedwidth #page.drawers .main-inner,\n                    .header-maxwidth {\n                        max-width: 98% !important; \n                        width: 98% !important;\n                        margin-left: auto !important;\n                        margin-right: auto !important;\n                    }\n                }\n\n                /* 2. Dashboard block layout (Grid layout) */\n                @media (min-width: 1200px) {\n                    #block-region-content {\n                        display: grid !important;\n                        grid-template-columns: 1fr 1fr !important; \n                        gap: 20px !important;\n                        align-items: start !important;\n                    }\n\n                    /* --- Block placement specifications --- */\n\n                    /* Priority 1: Announcements (Top, Full width) */\n                    section.block_site_announcements,\n                    section.block_news_items {\n                        grid-column: 1 / -1 !important;\n                        order: 1 !important;\n                    }\n\n                    /* Priority 2: Left: Custom Timetable */\n                    div#customTimetableWidget {\n                        grid-column: 1 / 2 !important; \n                        order: 2 !important;\n                        margin-bottom: 0 !important;\n                        height: auto !important;\n                    }\n\n                    /* Priority 3: Right: Timeline */\n                    section.block_timeline {\n                        grid-column: 2 / 3 !important; \n                        order: 3 !important;\n                        margin-bottom: 0 !important;\n                        height: auto !important;\n                    }\n                    /* Adjust timeline content to prevent cutoff */\n                    section.block_timeline .card-body {\n                        max-height: 600px !important; \n                        overflow-y: auto !important;\n                    }\n\n                    /* Priority 4: Other content (Bottom, Full width) */\n                    section.block_myoverview,\n                    section.block_recentlyaccesseditems,\n                    section.block_recentlyaccessedcourses {\n                        grid-column: 1 / -1 !important; \n                        order: 10 !important;\n                    }\n\n                    /* Priority 5: Calendar at the bottom */\n                    section.block_calendar_month {\n                        grid-column: 1 / -1 !important; \n                        order: 100 !important; \n                    }\n                    \n                    /* Disable invisible elements causing layout breakage */\n                    #block-region-content > :not(.block):not(#customTimetableWidget) {\n                        display: none !important;\n                    }\n                }\n            ":"":t.innerHTML="")}function $(){return new Promise((t,n)=>{if(!window.indexedDB)return t(null);const a=indexedDB.open("MoodleCustomBGDB",2);a.onupgradeneeded=t=>{g=t.target.result,g.objectStoreNames.contains(e)||g.createObjectStore(e,{keyPath:"id"})},a.onsuccess=e=>{g=e.target.result,t(g)},a.onerror=e=>{n(e.target.errorCode)}})}async function T(){const a=await chrome.storage.local.get(n),o=await chrome.storage.local.get(i);let d,l={};const c=localStorage.getItem(r);if(a[n])try{d=JSON.parse(a[n])}catch(e){console.error("Error parsing settings:",e),d=s}else d=s;if(o[i])try{l=JSON.parse(o[i])}catch(e){console.error("Error parsing darkmode settings:",e),l={}}if(c&&(l.darkModeMode=c),b={...s,...d,...l},"indexeddb"===b.backgroundUrl||b.backgroundUrl.startsWith("blob:")){const n=await new Promise((n,a)=>{if(!g)return n(null);const o=g.transaction([e],"readonly").objectStore(e).get(t);o.onsuccess=e=>{const t=e.target.result;if(t&&t.blob){const e=URL.createObjectURL(t.blob);n({url:e,type:t.type})}else n(null)},o.onerror=e=>a(e)});n&&n.url?(h=n.url,b.localBackgroundUrl=n.url,b.backgroundType=n.type.startsWith("video/")?"video":"image",b.backgroundUrl="indexeddb"):(console.warn("Background file not found in DB. Resetting to none."),b.backgroundUrl="",b.backgroundType="none")}return b}function q(e){try{localStorage.setItem(o,JSON.stringify({fontFamily:e.fontFamily,customFontName:e.customFontName,customFontUrl:e.customFontUrl}))}catch(e){console.warn("Failed to update font cache",e)}}async function F(e){h&&h!==e.backgroundUrl&&(URL.revokeObjectURL(h),h=null),q(e);const{darkModeMode:t,darkModeBrightness:a,darkModeContrast:o,darkModeGrayscale:d,darkModeSepia:l,...s}=e;let c={...s};const m=c.backgroundUrl,u=c.backgroundType;m.startsWith("blob:")||"indexeddb"===m?(c.backgroundUrl="indexeddb",c.backgroundType=u):m.startsWith("http")?(c.backgroundUrl=m,c.backgroundType=u):(c.backgroundUrl="",c.backgroundType="none");const p={darkModeMode:t,darkModeBrightness:a,darkModeContrast:o,darkModeGrayscale:d,darkModeSepia:l};localStorage.setItem(r,t),await chrome.storage.local.set({[n]:JSON.stringify(c)}),await chrome.storage.local.set({[i]:JSON.stringify(p)}),b=e}function R(n){!function(){const e=document.getElementById("modern-modal-css");e&&e.remove();const t=document.createElement("style");t.id="modern-modal-css",t.innerHTML='\n            /* White base design CSS */\n            .modern-modal-overlay { \n                position: fixed; top: 0; left: 0; width: 100%; height: 100%; \n                background-color: rgba(0, 0, 0, 0.5); \n                z-index: 2147483647; \n                display: none; \n                justify-content: center; align-items: center; \n                animation: fadeIn 0.2s ease;\n                \n                /* 【修正点】イベント透過防止とスクロール連鎖防止 */\n                pointer-events: auto !important;\n                overscroll-behavior: contain;\n            }\n            .modern-modal-content { \n                background: #ffffff; \n                color: #333333; \n                border-radius: 12px; width: 95%; max-width: 550px; max-height: 85vh; \n                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); \n                border: 1px solid #e0e0e0; \n                display: flex; flex-direction: column; font-family: \'Segoe UI\', sans-serif; \n                overflow: hidden; \n                \n                /* 【修正点】コンテンツ自体のイベントを確実に有効化 */\n                pointer-events: auto !important;\n            }\n            /* ... (以下、元のCSSと同じため省略なしで記述する場合は元のコードを使用) ... */\n            .modern-modal-header { \n                padding: 15px 25px; \n                background: #f8f9fa; \n                border-bottom: 1px solid #e0e0e0; \n            }\n            .modern-modal-header h4 { \n                margin: 0; font-size: 1.5rem; font-weight: 700; \n                color: #0056b3; \n                background: none; -webkit-background-clip: unset; -webkit-text-fill-color: unset; \n            }\n            .sub-text { \n                margin: 5px 0 0; font-size: 0.85rem; \n                color: #6c757d; \n            }\n            .modern-modal-body { \n                padding: 25px; overflow-y: auto; \n                scrollbar-width: thin; scrollbar-color: #007bff transparent; \n            }\n            .modern-modal-body::-webkit-scrollbar { width: 8px; }\n            .modern-modal-body::-webkit-scrollbar-thumb { background-color: #007bff; border-radius: 4px; }\n            \n            .settings-group { \n                background: #f8f8f8; \n                border-radius: 8px; padding: 15px; margin-bottom: 15px; \n                border: 1px solid #e0e0e0; \n            }\n            .group-title { \n                font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; \n                color: #007bff; \n                margin-bottom: 10px; font-weight: 600; \n            }\n            .input-wrapper { margin-bottom: 15px; }\n            .input-wrapper label { \n                display: block; font-size: 0.9rem; margin-bottom: 5px; \n                color: #555; \n            }\n            .modern-input, .modern-select { \n                width: 100%; padding: 8px 12px; \n                background: #ffffff; \n                border: 1px solid #ccc; \n                border-radius: 6px; \n                color: #333; \n                transition: border-color 0.2s; \n            }\n            .modern-input:focus, .modern-select:focus { \n                outline: none; \n                border-color: #007bff; \n                background: #fff; \n            }\n            .modern-select option { \n                background-color: #ffffff; \n                color: #333; \n            }\n            .color-picker-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }\n            .color-item { text-align: center; }\n            .color-item label { font-size: 0.75rem; display: block; margin-bottom: 5px; color: #777; }\n            .color-wrapper { height: 35px; border-radius: 6px; overflow: hidden; border: 1px solid #ccc; cursor: pointer; }\n            input[type="color"] { width: 100%; height: 100%; padding: 0; border: none; background: none; cursor: pointer; transform: scale(1.5); }\n            .slider-container { margin-top: 15px; }\n            .slider-label { display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: #333; margin-bottom: 8px; width: 100%; }\n            .slider-value-group { display: inline-flex; align-items: center; justify-content: flex-end; gap: 2px; font-family: monospace; font-size: 1.1em; color: #007bff; }\n            .modern-range { -webkit-appearance: none; width: 100%; height: 4px; background: #ccc; border-radius: 2px; outline: none; }\n            .modern-range::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #007bff; border-radius: 50%; cursor: pointer; box-shadow: 0 0 8px rgba(0, 119, 255, 0.5); transition: transform 0.1s; }\n            .modern-range::-webkit-slider-thumb:hover { transform: scale(1.2); }\n            \n            .modern-modal-footer { \n                padding: 15px 25px; \n                background: #f8f9fa; \n                border-top: 1px solid #e0e0e0; \n                display: flex; justify-content: flex-end; gap: 10px; \n            }\n            .modern-btn { padding: 8px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }\n            .primary-btn { \n                background: linear-gradient(135deg, #007bff 0%, #00b7ff 100%); \n                color: white; \n            }\n            .secondary-btn { \n                background: #e0e0e0; \n                color: #333; \n            }\n            .secondary-btn:hover { background: #ccc; color: #000; }\n            .status-text { font-size: 0.8rem; color: #777; margin-bottom: 15px; text-align: center; }\n            .toggle-switch .slider { background-color: #ccc; } \n            .toggle-switch .slider:before { background-color: white; }\n            .toggle-switch input:checked + .slider { background-color: #007bff; } \n            .toggle-switch .label-text { color: #333; }\n            .modern-text-btn.danger { color: #dc3545; } \n            \n            .full-width { width: 100%; margin-bottom: 10px; text-align: center; }\n            .modern-text-btn { background: none; border: none; cursor: pointer; font-size: 0.85rem; padding: 5px; border-radius: 4px; }\n            \n            .toggle-switch { display: flex; align-items: center; cursor: pointer; user-select: none; }\n            .toggle-switch input { display: none; }\n            .toggle-switch .slider { width: 36px; height: 20px; background-color: #ccc; border-radius: 20px; position: relative; margin-right: 10px; }\n            .toggle-switch .slider:before { content: ""; position: absolute; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .2s; }\n            .toggle-switch input:checked + .slider { background-color: #0077ff; }\n            .toggle-switch input:checked + .slider:before { transform: translateX(16px); }\n            .toggle-switch .label-text { color: #333; font-size: 0.9rem; }\n            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n        ',document.head.appendChild(t)}();const a=`\n            <div id="custom-settings-modal" class="modern-modal-overlay">\n                <div id="custom-settings-content" class="modern-modal-content">\n                    <div class="modern-modal-header">\n                        <h4>Moodle Customizer</h4>\n                        <p class="sub-text">Personalize your learning environment</p>\n                    </div>\n                    \n                    <div class="modern-modal-body">\n                        <div class="settings-group">\n                            <div class="group-title">Dark Mode (Beta)</div>\n                            <div class="input-wrapper">\n                                <label>モード</label>\n                                <select id="darkModeModeSelect" class="modern-select">\n                                    <option value="off" ${"off"===n.darkModeMode?"selected":""}>オフ</option>\n                                    <option value="on" ${"on"===n.darkModeMode?"selected":""}>常にオン</option>\n                                    <option value="auto" ${"auto"===n.darkModeMode?"selected":""}>システム設定に従う</option>\n                                </select>\n                            </div>\n                            <div class="slider-container">\n                                <div class="slider-label">\n                                    <span>明るさ (Brightness)</span>\n                                    <div class="slider-value-group">\n                                        <span id="darkModeBrightnessValue">${n.darkModeBrightness}</span>%\n                                    </div>\n                                </div>\n                                <input type="range" id="darkModeBrightnessRange" min="0" max="150" value="${n.darkModeBrightness}" class="modern-range">\n                            </div>\n                            <div class="slider-container">\n                                <div class="slider-label">\n                                    <span>コントラスト (Contrast)</span>\n                                    <div class="slider-value-group">\n                                        <span id="darkModeContrastValue">${n.darkModeContrast}</span>%\n                                    </div>\n                                </div>\n                                <input type="range" id="darkModeContrastRange" min="0" max="150" value="${n.darkModeContrast}" class="modern-range">\n                            </div>\n                            <div class="slider-container">\n                                <div class="slider-label">\n                                    <span>グレースケール (Grayscale)</span>\n                                    <div class="slider-value-group">\n                                        <span id="darkModeGrayscaleValue">${n.darkModeGrayscale}</span>%\n                                    </div>\n                                </div>\n                                <input type="range" id="darkModeGrayscaleRange" min="0" max="100" value="${n.darkModeGrayscale}" class="modern-range">\n                            </div>\n                            <div class="slider-container">\n                                <div class="slider-label">\n                                    <span>セピア (Sepia)</span>\n                                    <div class="slider-value-group">\n                                        <span id="darkModeSepiaValue">${n.darkModeSepia}</span>%\n                                    </div>\n                                </div>\n                                <input type="range" id="darkModeSepiaRange" min="0" max="100" value="${n.darkModeSepia}" class="modern-range">\n                            </div>\n                        </div>\n                        <div class="settings-group">\n                            <div class="group-title">Header Style</div>\n                            <div class="color-picker-grid">\n                                <div class="color-item">\n                                    <label>背景色</label>\n                                    <div class="color-wrapper"><input type="color" id="headerBgColorInput" value="${n.headerBgColor}"></div>\n                                </div>\n                                <div class="color-item">\n                                    <label>文字色</label>\n                                    <div class="color-wrapper"><input type="color" id="headerTextColorInput" value="${n.headerTextColor}"></div>\n                                </div>\n                                <div class="color-item">\n                                    <label>枠線色</label>\n                                    <div class="color-wrapper"><input type="color" id="headerStrokeColorInput" value="${n.headerStrokeColor}"></div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="settings-group">\n                            <div class="group-title">Background Media</div>\n                            <input type="file" id="backgroundFileInput" accept="image/*,video/*" style="display: none;">\n                            <button id="selectBackgroundBtn" class="modern-btn primary-btn full-width"><i class="fa fa-folder-open"></i> ファイルを選択 (Image/Video)</button>\n                            <p id="currentBackgroundInfo" class="status-text"></p>\n                            <div class="radio-group" style="display:flex; justify-content:center; gap:20px; margin-bottom:10px;">\n                                <label class="radio-label" style="color:#333;">\n                                    <input type="radio" id="bg-type-video" name="bg-type" value="video" ${"video"===n.backgroundType?"checked":""} disabled> 動画\n                                </label>\n                                <label class="radio-label" style="color:#333;">\n                                    <input type="radio" id="bg-type-image" name="bg-type" value="image" ${"image"===n.backgroundType?"checked":""} disabled> 画像\n                                </label>\n                            </div>\n                            <div class="slider-container">\n                                <div class="slider-label">\n                                    <span>透明度</span>\n                                    <div class="slider-value-group">\n                                        <span id="opacityValue">${n.opacity}</span>%\n                                    </div>\n                                </div>\n                                <input type="range" id="opacityRange" min="0" max="100" value="${n.opacity}" class="modern-range">\n                            </div>\n                            <div class="slider-container">\n                                <div class="slider-label">\n                                    <span>明度</span>\n                                    <div class="slider-value-group">\n                                        <span id="brightnessValue">${n.brightness}</span>%\n                                    </div>\n                                </div>\n                                <input type="range" id="brightnessRange" min="0" max="200" value="${n.brightness}" class="modern-range">\n                            </div>\n                        </div>\n                        <div class="settings-group">\n                            <div class="group-title">Typography</div>\n                            <div class="input-wrapper">\n                                <label>プリセットフォント</label>\n                                <select id="fontFamilySelect" class="modern-select">\n                                    <option value="default">Moodle標準 (Default)</option>\n                                    <option disabled>--- System Fonts ---</option>\n                                    <option value="meiryo">メイリオ</option>\n                                    <option value="yugothic">游ゴシック</option>\n                                    <option value="biz-gothic">BIZ UDPゴシック</option>\n                                    <option disabled>--- Google Web Fonts ---</option>\n                                    <option value="notosans">Noto Sans JP</option>\n                                    <option value="zenmaru">Zen 丸ゴシック</option>\n                                    <option value="sawarabi">さわらび明朝</option>\n                                    <option value="mochiy">Mochiy Pop One</option>\n                                    <option value="dotgothic">DotGothic16</option>\n                                    <option value="rampart">Rampart One</option>\n                                </select>\n                            </div>\n                            <div class="input-wrapper">\n                                <label>カスタムフォント名</label>\n                                <input type="text" id="customFontNameInput" class="modern-input" placeholder="例: Impact" value="${n.customFontName||""}">\n                            </div>\n                            <div class="input-wrapper">\n                                <label>WebフォントURL</label>\n                                <input type="text" id="customFontUrlInput" class="modern-input" placeholder="例: https://fonts.googleapis.com/..." value="${n.customFontUrl||""}">\n                            </div>\n                        </div>\n                        <div class="settings-group">\n                            <div class="group-title">Content Area</div>\n                            <div class="slider-container">\n                                <div class="slider-label">\n                                    <span>ブロック透明度</span>\n                                    <div class="slider-value-group">\n                                        <span id="contentOpacityValue">${n.contentOpacity}</span>%\n                                    </div>\n                                </div>\n                                <input type="range" id="contentOpacityRange" min="0" max="100" value="${n.contentOpacity}" class="modern-range">\n                            </div>\n                        </div>\n                        <div class="settings-group">\n                            <div class="group-title">Widgets</div>\n                            <label class="toggle-switch" style="margin-bottom: 10px;">\n                                <input type="checkbox" id="enableCustomLayoutCheckbox" ${n.enableCustomLayout?"checked":""}>\n                                <span class="slider"></span>\n                                <span class="label-text">ダッシュボードのレイアウトを拡張 (PC用)</span>\n                            </label>\n                            <label class="toggle-switch">\n                                <input type="checkbox" id="showTimetableCheckbox" ${n.showTimetable?"checked":""}>\n                                <span class="slider"></span>\n                                <span class="label-text">ダッシュボードに時間割を表示</span>\n                            </label>\n                        </div>\n                        <div style="text-align: right; margin-top: 10px;">\n                            <button id="resetSettingsBtn" class="modern-text-btn danger"><i class="fa fa-trash"></i> 設定を初期化</button>\n                        </div>\n                    </div>\n                    <div class="modern-modal-footer">\n                        <button id="closeSettingsModal" class="modern-btn secondary-btn">閉じる</button>\n                        <button id="saveSettingsBtn" class="modern-btn primary-btn glow">保存して適用</button>\n                    </div>\n                </div>\n            </div>\n        `;document.body.insertAdjacentHTML("beforeend",a),function(){const n=document.getElementById("custom-settings-modal"),a=document.getElementById("saveSettingsBtn"),r=document.getElementById("closeSettingsModal"),i=document.getElementById("resetSettingsBtn"),d=document.getElementById("headerBgColorInput"),l=document.getElementById("headerTextColorInput"),c=document.getElementById("headerStrokeColorInput"),m=document.getElementById("opacityRange"),u=document.getElementById("brightnessRange"),p=document.getElementById("contentOpacityRange"),y=document.getElementById("fontFamilySelect"),f=document.getElementById("customFontNameInput"),k=document.getElementById("customFontUrlInput"),v=document.getElementById("backgroundFileInput"),x=document.getElementById("selectBackgroundBtn"),w=document.getElementById("enableCustomLayoutCheckbox"),E=document.getElementById("darkModeModeSelect"),B=document.getElementById("darkModeBrightnessRange"),M=document.getElementById("darkModeContrastRange"),S=document.getElementById("darkModeGrayscaleRange"),C=document.getElementById("darkModeSepiaRange");function q(){O({...b,headerBgColor:d.value,headerTextColor:l.value,headerStrokeColor:c.value})}function R(){j({...b,fontFamily:y.value,customFontName:f.value,customFontUrl:k.value})}d.addEventListener("input",q),l.addEventListener("input",q),c.addEventListener("input",q),m.addEventListener("input",z),u.addEventListener("input",z),E.addEventListener("change",U),B.addEventListener("input",U),M.addEventListener("input",U),S.addEventListener("input",U),C.addEventListener("input",U),p&&p.addEventListener("input",e=>{document.getElementById("contentOpacityValue").textContent=e.target.value,H(parseInt(e.target.value))}),y&&y.addEventListener("change",R),f&&f.addEventListener("input",R),k&&k.addEventListener("input",R),x&&x.addEventListener("click",()=>{v.click()}),v&&v.addEventListener("change",n=>{if(n.target.files.length>0){const a=n.target.files[0],o=a.type.startsWith("video/")?"video":"image";!async function(n,a){h&&(URL.revokeObjectURL(h),h=null);try{await(o=n,r=n.type,new Promise((n,a)=>{if(!g)return a("DB not initialized");const i=g.transaction([e],"readwrite").objectStore(e),d={id:t,blob:o,type:r},l=i.put(d);l.onsuccess=()=>n(),l.onerror=e=>a(e)}));const i=URL.createObjectURL(n);h=i,b.backgroundUrl=i,b.backgroundType=a,z();const d=document.getElementById("custom-settings-modal");d&&"flex"===d.style.display&&(document.getElementById("currentBackgroundInfo").innerHTML="<b>現在の背景</b>: ローカルファイル (IndexedDB経由・永続化済み)",document.getElementById("bg-type-video").checked="video"===a,document.getElementById("bg-type-image").checked="image"===a),alert(`背景ファイル ${n.name} をプレビュー適用しました。\n「保存」ボタンを押して永続化してください。`)}catch(e){console.error("IndexedDB Save Error:",e),alert("エラー: ファイルの保存中に問題が発生しました。")}var o,r}(a,o),n.target.value=""}}),a&&a.addEventListener("click",async()=>{const e={...b,headerBgColor:d.value,headerTextColor:l.value,headerStrokeColor:c.value,opacity:parseInt(m.value),brightness:parseInt(u.value),showTimetable:document.getElementById("showTimetableCheckbox").checked,enableCustomLayout:w.checked,contentOpacity:parseInt(p.value),fontFamily:document.getElementById("fontFamilySelect").value,customFontName:document.getElementById("customFontNameInput").value,customFontUrl:document.getElementById("customFontUrlInput").value,darkModeMode:E.value,darkModeBrightness:parseInt(B.value),darkModeContrast:parseInt(M.value),darkModeGrayscale:parseInt(S.value),darkModeSepia:parseInt(C.value)};await F(e),n.style.display="none",document.body.style.overflow="",D(!0)}),r&&r.addEventListener("click",async()=>{const e=await T();O(e),_(e),H(e.contentOpacity),j(e),N(e),L(e.enableCustomLayout),n.style.display="none",document.body.style.overflow=""});const W=document.getElementById("custom-settings-content");W&&W.addEventListener("click",e=>{e.stopPropagation()}),i&&i.addEventListener("click",async()=>{if(confirm("全てのカスタム設定を初期値に戻しますか？（時間割の内容はリセットされません）")){h&&(URL.revokeObjectURL(h),h=null);try{if(localStorage.removeItem(o),g){g.transaction([e],"readwrite").objectStore(e).clear()}else if(await $(),g){g.transaction([e],"readwrite").objectStore(e).clear()}}catch(e){console.warn("Failed to clear IndexedDB:",e)}I({darkModeMode:"off"}),await F(s),A(s),D(!0),alert("カスタム設定をリセットし、反映しました。")}})}()}function A(e){document.getElementById("headerBgColorInput").value=e.headerBgColor,document.getElementById("headerTextColorInput").value=e.headerTextColor,document.getElementById("headerStrokeColorInput").value=e.headerStrokeColor;const t=document.getElementById("currentBackgroundInfo"),n=document.getElementById("bg-type-video"),a=document.getElementById("bg-type-image"),o=n.closest("label"),r=a.closest("label");o&&(o.style.color="#333"),r&&(r.style.color="#333"),n.checked="video"===e.backgroundType,a.checked="image"===e.backgroundType,e.backgroundUrl.startsWith("blob:")?t.innerHTML="現在の背景: ローカルファイル (IndexedDB経由・永続化済み)":t.innerHTML="現在の背景: なし (ファイルを選択してください)",document.getElementById("opacityRange").value=e.opacity,document.getElementById("opacityValue").textContent=e.opacity,document.getElementById("brightnessRange").value=e.brightness,document.getElementById("brightnessValue").textContent=e.brightness,document.getElementById("showTimetableCheckbox").checked=e.showTimetable,document.getElementById("enableCustomLayoutCheckbox").checked=e.enableCustomLayout,document.getElementById("contentOpacityRange").value=e.contentOpacity,document.getElementById("contentOpacityValue").textContent=e.contentOpacity,document.getElementById("fontFamilySelect").value=e.fontFamily||"default",document.getElementById("customFontNameInput").value=e.customFontName||"",document.getElementById("customFontUrlInput").value=e.customFontUrl||"",document.getElementById("darkModeModeSelect").value=e.darkModeMode,document.getElementById("darkModeBrightnessRange").value=e.darkModeBrightness,document.getElementById("darkModeBrightnessValue").textContent=e.darkModeBrightness,document.getElementById("darkModeContrastRange").value=e.darkModeContrast,document.getElementById("darkModeContrastValue").textContent=e.darkModeContrast,document.getElementById("darkModeGrayscaleRange").value=e.darkModeGrayscale,document.getElementById("darkModeGrayscaleValue").textContent=e.darkModeGrayscale,document.getElementById("darkModeSepiaRange").value=e.darkModeSepia,document.getElementById("darkModeSepiaValue").textContent=e.darkModeSepia}function z(){const e=document.getElementById("opacityRange"),t=document.getElementById("brightnessRange");if(!e||!t)return;const n=parseInt(e.value),a=parseInt(t.value);document.getElementById("opacityValue").textContent=n,document.getElementById("brightnessValue").textContent=a,_({...b,opacity:n,brightness:a})}function U(){const e=document.getElementById("darkModeModeSelect"),t=document.getElementById("darkModeBrightnessRange"),n=document.getElementById("darkModeContrastRange"),a=document.getElementById("darkModeGrayscaleRange"),o=document.getElementById("darkModeSepiaRange"),r={darkModeMode:e.value,darkModeBrightness:parseInt(t.value),darkModeContrast:parseInt(n.value),darkModeGrayscale:parseInt(a.value),darkModeSepia:parseInt(o.value)};document.getElementById("darkModeBrightnessValue").textContent=r.darkModeBrightness,document.getElementById("darkModeContrastValue").textContent=r.darkModeContrast,document.getElementById("darkModeGrayscaleValue").textContent=r.darkModeGrayscale,document.getElementById("darkModeSepiaValue").textContent=r.darkModeSepia,N({...b,...r})}async function D(e=!0){e&&await T();const t=b;j(t),function(){if(document.querySelector(p)){if(!document.getElementById("background-video")){const e=document.createElement("video");e.id="background-video",e.loop=!0,e.autoplay=!0,e.muted=!0,e.playsInline=!0,e.style.cssText="\n                position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n                object-fit: cover; z-index: -100; display: none;\n                transition: opacity 0.5s ease;\n                will-change: transform, opacity;\n                transform: translate3d(0, 0, 0); \n                backface-visibility: hidden;   \n                pointer-events: none;       \n            ",document.body.prepend(e),e.oncanplaythrough=()=>{e.play().catch(e=>console.warn("Video autoplay blocked:",e))},e.onerror=e=>{b.backgroundUrl.startsWith("blob:")&&"video"===b.backgroundType&&console.error("Failed to load background VIDEO (Blob/IndexedDB).",e)}}if(!document.getElementById("background-dim-overlay")){const e=document.createElement("div");e.id="background-dim-overlay",e.style.cssText="\n                position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n                pointer-events: none; z-index: -99; display: block;\n                transition: background-color 0.3s ease;\n            ",document.body.prepend(e)}if(!document.getElementById("background-image-container")){const e=document.createElement("div");e.id="background-image-container",e.style.cssText="\n                position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n                background-size: cover; background-position: center center;\n                background-repeat: no-repeat; z-index: -100; display: none;\n                transition: opacity 0.5s ease, filter 0.5s ease;\n            ",document.body.prepend(e)}}}(),O(t),_(t),H(t.contentOpacity),N(t),function(){let e=document.getElementById("darkreader-fixup-style");e||(e=document.createElement("style"),e.id="darkreader-fixup-style",document.head.appendChild(e)),e.textContent='\n            /* Dark Reader Fixup CSS (Integrated into moodle-custom-styles.css) */\n            html[data-darkreader-scheme="dark"] #page-content,\n            html[data-darkreader-scheme="dark"] #page-wrapper,\n            html[data-darkreader-scheme="dark"] #page-header,\n            html[data-darkreader-scheme="dark"] #region-main-box,\n            html[data-darkreader-scheme="dark"] .card,\n            html[data-darkreader-scheme="dark"] .block,\n            html[data-darkreader-scheme="dark"] .list-group-item,\n            html[data-darkreader-scheme="dark"] .que,\n            html[data-darkreader-scheme="dark"] .bg-white,\n            html[data-darkreader-scheme="dark"] .context-header-settings-menu,\n            html[data-darkreader-scheme="dark"] .page-context-header,\n            html[data-darkreader-scheme="dark"] .page-header-wrapper,\n            html[data-darkreader-scheme="dark"] .drawer-content,\n            html[data-darkreader-scheme="dark"] #customTimetableWidget card-body,\n            html[data-darkreader-scheme="dark"] .yui3-js-enabled,\n            html[data-darkreader-scheme="dark"] #page-my-index,\n            html[data-darkreader-scheme="dark"] #page-wrapper,\n            html[data-darkreader-scheme="dark"] .w-100,\n            html[data-darkreader-scheme="dark"] #page-course-view-topics,\n            html[data-darkreader-scheme="dark"] #region-main,\n            html[data-darkreader-scheme="dark"] .card-body .p-3,\n            html[data-darkreader-scheme="dark"] .card-body.p-3,\n            html[data-darkreader-scheme="dark"] .card-body.pt-3,\n            html[data-darkreader-scheme="dark"] .card-text,\n            html[data-darkreader-scheme="dark"] .sr-only\n            {\n                background-color: transparent !important;\n            }\n            html[data-darkreader-scheme="dark"] .card *, \n            html[data-darkreader-scheme="dark"] .block * {\n                color: var(--darkreader-neutral-text, #e8e6e3) !important;\n            }\n        '}(),L(t.enableCustomLayout),await V(),document.body.style.setProperty("visibility","visible","important"),B()}function N(e){I(e)}function j(e){let t=document.getElementById("custom-font-style");t||(t=document.createElement("style"),t.id="custom-font-style",(document.head||document.documentElement).appendChild(t));const n={default:{name:"",url:""},meiryo:{name:'"Meiryo", "メイリオ", "Hiragino Kaku Gothic ProN", sans-serif',url:""},yugothic:{name:'"Yu Gothic", "游ゴシック", "YuGothic", sans-serif',url:""},"biz-gothic":{name:'"BIZ UDPGothic", "BIZ UDPゴシック", sans-serif',url:""},notosans:{name:'"Noto Sans JP", sans-serif',url:"https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap"},zenmaru:{name:'"Zen Maru Gothic", sans-serif',url:"https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700&display=swap"},sawarabi:{name:'"Sawarabi Mincho", serif',url:"https://fonts.googleapis.com/css2?family=Sawarabi+Mincho&display=swap"},mochiy:{name:'"Mochiy Pop One", sans-serif',url:"https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&display=swap"},dotgothic:{name:'"DotGothic16", sans-serif',url:"https://fonts.googleapis.com/css2?family=DotGothic16&display=swap"},rampart:{name:'"Rampart One", cursive',url:"https://fonts.googleapis.com/css2?family=Rampart+One&display=swap"}};let a="",o="";e.customFontName&&""!==e.customFontName.trim()?(a=`"${e.customFontName}", sans-serif`,e.customFontUrl&&""!==e.customFontUrl.trim()&&(o=e.customFontUrl)):n[e.fontFamily]&&(a=n[e.fontFamily].name,o=n[e.fontFamily].url);let r="";a&&(o&&(r+=`@import url('${o}');\n`),r+=`\n                body, div, p, span, a, li, td, th, h1, h2, h3, h4, h5, h6, button, input, textarea, select, .block, .card {\n                    font-family: ${a} !important;\n                }\n                .fa, .fa-*, .icon, [class*="icon"], .fa-solid, .fa-regular, .fa-brands {\n                    font-family: "FontAwesome", "Font Awesome 6 Free", "Font Awesome 6 Brands" !important;\n                }\n            `),r+='\n           .count-container, \n            .badge, \n            .notification-count,\n            [data-region="count-container"] {\n                font-family: -apple-system, BlinkMacSystemFont, Roboto, Arial, sans-serif !important;\n                font-weight: bold !important;\n                font-size: 10px !important;\n                line-height: 16px !important;\n                letter-spacing: 0.5px !important;\n                text-shadow: none !important;\n                display: inline-flex !important;\n                align-items: center !important;\n                justify-content: center !important;\n                min-width: 16px !important;\n                height: 16px !important;\n                padding: 0 4px !important;\n                border-radius: 10px !important;\n                box-sizing: border-box !important;\n            }\n            .count-container.hidden,\n            [data-region="count-container"].hidden,\n            .notification-count.hidden,\n            .count-container:empty {\n                display: none !important;\n            }\n        ',t.innerHTML=r}function O(e){let t=document.getElementById("custom-header-style");t||(t=document.createElement("style"),t.id="custom-header-style",(document.head||document.documentElement).appendChild(t));const n=`\n            -1px -1px 0 ${e.headerStrokeColor}, 1px -1px 0 ${e.headerStrokeColor},\n            -1px  1px 0 ${e.headerStrokeColor}, 1px  1px 0 ${e.headerStrokeColor}\n        `;t.innerHTML=`\n            .navbar.fixed-top.navbar-light.bg-white, .navbar {\n                background-color: ${e.headerBgColor} !important;\n                background-image: none !important;\n                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);\n                border-bottom: none !important;\n            }\n            .navbar-brand, .navbar-nav .nav-link, #customSettingsBtn {\n                color: ${e.headerTextColor} !important;\n                text-shadow: ${n};\n            }\n            .usernavigation .btn, .usernavigation .usermenu .btn {\n                color: ${e.headerTextColor} !important;\n                text-shadow: none !important;\n            }\n            button.github-btn-mangesh636 {\n                 color: ${e.headerTextColor} !important;\n                 border: 1px solid ${e.headerTextColor} !important;\n            }\n            button.github-btn-mangesh636 svg {\n                 fill: ${e.headerTextColor} !important;\n            }\n        `}function _(e={}){const t={...b,...e},n=document.getElementById("background-video"),a=document.getElementById("background-image-container"),o=document.getElementById("background-dim-overlay"),r=document.querySelector(p);if(!r)return;r.style.overflowX="hidden";const i=t.opacity/100;let d="rgba(0,0,0,0)";o&&(t.brightness<100?d=`rgba(0, 0, 0, ${(100-t.brightness)/100})`:t.brightness>100&&(d=`rgba(255, 255, 255, ${Math.min((t.brightness-100)/100,1)})`),o.style.backgroundColor=d);const l=t.localBackgroundUrl||t.backgroundUrl;if(!l||"indexeddb"===l&&!t.localBackgroundUrl)return n&&(n.style.display="none"),void(a&&(a.style.display="none"));n&&a&&("video"===t.backgroundType&&l?(n.src=l,n.style.display="block",n.style.opacity=i.toString(),n.style.filter="none",a.style.display="none",a.style.backgroundImage="none"):"image"===t.backgroundType&&l?(a.style.backgroundImage=`url("${l}")`,a.style.display="block",a.style.opacity=i.toString(),a.style.filter=`brightness(${t.brightness/100})`,n.style.display="none",n.src=""):(n.style.display="none",n.src="",a.style.display="none",a.style.backgroundImage="none"))}function H(e){const t=e/100;let n=document.getElementById("custom-content-style");n||(n=document.createElement("style"),n.id="custom-content-style",(document.head||document.documentElement).appendChild(n));const a="255, 255, 255",o="24, 26, 27",r=`rgba(${a}, ${t})`,i=`rgba(${o}, ${t})`,d=`rgba(${a}, ${t})`,l=`rgba(${o}, ${t})`,s=`rgba(${a}, ${t})`,c=`rgba(${o}, ${t})`;n.innerHTML=`\n            /* =========================================\n               1. Light Mode (Default) Settings\n               ========================================= */\n            .main-inner {\n                background-color: ${s} !important;\n                border-radius: 8px;\n                box-shadow: 0 0 15px rgba(0,0,0,0.1);\n            }\n            \n             .block:not(#customTimetableWidget) .card-body,\n             .block:not(#customTimetableWidget) .card:not(.custom-card-style),\n             .block:not(#customTimetableWidget),\n             .course-section .section-item,\n             .list-group-item,\n             .list-group-item.list-group-item-action:active,\n             .block-myoverview .dropdown-menu,\n             .block_calendar_month .calendarmonth,\n             #customTimetableWidget .card-body,\n             .header.d-flex.flex-wrap.p-1,\n             .input-group.searchbar.w-100,\n             .mb-1.me-1.flex-grow-1,\n             .col-md-6.col-sm-8.col-12.mb-1.d-flex.justify-content-end.nav-search,\n             #calendar-course-filter-1,\n             .sr-only\n         { \n                background-color: ${r} !important;\n            }\n            \n            .card.custom-card-style, \n            .block.card.custom-card-style\n         {\n                background-color: ${d} !important;\n                border: 1px solid rgba(255, 255, 255, 0.9) !important;\n            }\n\n            /* Fix quiz option alignment (Centering with Flexbox) */\n            .que .answer div.r0, \n            .que .answer div.r1 {\n                display: flex !important;\n                align-items: center !important; /* Vertical center alignment */\n                margin-bottom: 6px !important;\n            }\n            .que .answer input[type="radio"], \n            .que .answer input[type="checkbox"] {\n                margin-top: 0 !important;\n                margin-bottom: 0 !important;\n                margin-right: 8px !important; /* Spacing from label */\n                cursor: pointer;\n            }\n            .que .answer label {\n                margin-bottom: 0 !important;\n                line-height: 1.4 !important;\n                cursor: pointer;\n                padding-top: 2px !important; /* Font tweak */\n            }\n\n            /* Empty cells in timetable */\n            .timetable-empty-cell {\n                color: #ccc;\n                font-size: 1.2em;\n                display: block;\n                text-align: center;\n            }\n\n            /* Deadline card design in timetable */\n            .timetable-deadline-container {\n                margin-top: 6px;\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n                max-width: 100%;\n                overflow: hidden; \n            }\n\n            .timetable-deadline-card {\n                background-color: rgba(255, 255, 255, 0.7);\n                border-left: 3px solid #ccc;\n                padding: 4px 6px;\n                border-radius: 0 4px 4px 0;\n                font-size: 0.85em;\n                box-shadow: 0 1px 2px rgba(0,0,0,0.05);\n                max-width: 100%; \n                overflow: hidden;\n            }\n            .deadline-row-top {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                margin-bottom: 2px;\n                min-width: 0; \n            }\n            .deadline-name {\n                font-weight: bold;\n                color: #333;\n                font-size: 0.95em;\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                max-width: 100%;\n                display: block; \n                flex: 1; /* 余白を埋める */\n            }\n            .deadline-row-bottom {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                font-size: 0.85em;\n                margin-top: 2px;\n            }\n            .deadline-date {\n                color: #888;\n                font-size: 0.8em;\n                white-space: nowrap;\n                margin-left: 5px;\n            }\n\n            /* Timer color settings (Light Mode) */\n            .timer-safe { color: #00796b !important; font-weight: bold; } \n            .timer-warning { color: #f9a825 !important; font-weight: bold; } \n            .timer-danger { color: #e64a19 !important; font-weight: bold; } \n            .timer-critical { color: #d32f2f !important; font-weight: 900; } \n            .timer-expired { color: #757575 !important; }\n\n            .timetable-deadline-card:has(.timer-safe) { border-left-color: #00796b; }\n            .timetable-deadline-card:has(.timer-warning) { border-left-color: #f9a825; }\n            .timetable-deadline-card:has(.timer-danger) { border-left-color: #e64a19; }\n            .timetable-deadline-card:has(.timer-critical) { border-left-color: #d32f2f; }\n\n\n            /* =========================================\n               2. Dark Mode (Enabled via Dark Reader) Settings\n               ========================================= */\n            html[data-darkreader-scheme="dark"] .main-inner {\n                background-color: ${c} !important;\n                box-shadow: none !important;\n            }\n            \n            html[data-darkreader-scheme="dark"] .block:not(#customTimetableWidget) .card-body,\n            html[data-darkreader-scheme="dark"] .block:not(#customTimetableWidget) .card:not(.custom-card-style),\n            html[data-darkreader-scheme="dark"] .block:not(#customTimetableWidget),\n            html[data-darkreader-scheme="dark"] .course-section .section-item,\n            html[data-darkreader-scheme="dark"] .list-group-item,\n            html[data-darkreader-scheme="dark"] .list-group-item.list-group-item-action:active,\n            html[data-darkreader-scheme="dark"] .block-myoverview .dropdown-menu,\n            html[data-darkreader-scheme="dark"] .block_calendar_month .calendarmonth,\n            html[data-darkreader-scheme="dark"] #customTimetableWidget .card-body,\n            html[data-darkreader-scheme="dark"] .header.d-flex.flex-wrap.p-1,\n            html[data-darkreader-scheme="dark"] .input-group.searchbar.w-100,\n            html[data-darkreader-scheme="dark"] .mb-1.me-1.flex-grow-1,\n            html[data-darkreader-scheme="dark"] .col-md-6.col-sm-8.col-12.mb-1.d-flex.justify-content-end.nav-search,\n            html[data-darkreader-scheme="dark"] #calendar-course-filter-1,\n            html[data-darkreader-scheme="dark"] .sr-only {\n                background-color: ${i} !important;\n                color: #e8e6e3 !important; \n            }\n\n            html[data-darkreader-scheme="dark"] .card.custom-card-style, \n            html[data-darkreader-scheme="dark"] .block.card.custom-card-style {\n                background-color: ${l} !important;\n                border: 1px solid rgba(255, 255, 255, 0.2) !important;\n            }\n\n            /* Dark Mode Text Color Fix */\n            \n            html[data-darkreader-scheme="dark"] #customTimetableWidget {\n                 color: #e0e0e0 !important;\n            }\n            \n            html[data-darkreader-scheme="dark"] .timetable-deadline-card {\n                background-color: rgba(50, 50, 50, 0.7) !important;\n                border-left: 3px solid #777 !important;\n            }\n            html[data-darkreader-scheme="dark"] #customTimetableWidget .deadline-name {\n                color: #ffffff !important; \n            }\n            html[data-darkreader-scheme="dark"] #customTimetableWidget a {\n                color: #82b1ff !important;\n            }\n            \n            html[data-darkreader-scheme="dark"] #customTimetableTable th,\n            html[data-darkreader-scheme="dark"] #customTimetableTable td {\n                color: #cccccc !important;\n                border-bottom: 1px solid #444 !important;\n            }\n             html[data-darkreader-scheme="dark"] #customTimetableTable tr[style*="background-color: #f8f9fa"] {\n                background-color: rgba(255, 255, 255, 0.05) !important;\n            }\n\n            html[data-darkreader-scheme="dark"] #customTimetableWidget .deadline-date {\n                color: #aaa !important;\n            }\n            \n            /* Dim hyphens in empty cells */\n            html[data-darkreader-scheme="dark"] .timetable-empty-cell {\n                color: #555 !important;\n            }\n\n            /* Timer color settings (Dark Mode) */\n            html[data-darkreader-scheme="dark"] #customTimetableWidget .timer-safe { color: #80cbc4 !important; }\n            html[data-darkreader-scheme="dark"] #customTimetableWidget .timer-warning { color: #fff176 !important; }\n            html[data-darkreader-scheme="dark"] #customTimetableWidget .timer-danger { color: #ff8a80 !important; } \n            html[data-darkreader-scheme="dark"] #customTimetableWidget .timer-critical { color: #ff5252 !important; } \n            \n            html[data-darkreader-scheme="dark"] .timetable-deadline-card:has(.timer-safe) { border-left-color: #80cbc4 !important; }\n            html[data-darkreader-scheme="dark"] .timetable-deadline-card:has(.timer-warning) { border-left-color: #fff176 !important; }\n            html[data-darkreader-scheme="dark"] .timetable-deadline-card:has(.timer-danger) { border-left-color: #ff8a80 !important; }\n            html[data-darkreader-scheme="dark"] .timetable-deadline-card:has(.timer-critical) { border-left-color: #ff5252 !important; }\n\n\n            html[data-darkreader-scheme="dark"] .deadline-highlight {\n                background-color: rgba(100, 20, 20, 0.5) !important; \n                border: 1px solid #ff6b6b !important; \n                box-shadow: 0 0 10px rgba(255, 50, 50, 0.2) !important;\n                color: #ffcccc !important; \n            }\n\n        \n            /*3. Forced Transparency Areas (Common)*/\n\n            .bg-white,\n            .navbar, \n            .secondary-navigation,\n            .primary-navigation,\n            .nav.more-nav,\n            .nav-tabs .nav-link,\n            .nav-tabs .nav-item,\n            .course-tabs,\n            .context-header-settings-menu,\n            .usermenu .dropdown-menu,\n            .course-content, \n            #page-content,\n            #page,\n            #page-wrapper,\n            .main-content,\n            #region-main,\n            .pagelayout-mydashboard #region-main, \n            #region-main-box > div:first-child,\n            .pagelayout-incourse .nav-tabs, \n            .btn.btn-icon:not(.custom-card-style),\n            .coursemenubtn,\n            .activityiconcontainer,\n            .card-footer, \n            .page-item, \n            .pagination.mb-0, \n            .pagination,\n            .card-body.pe-1.course-info-container,\n            .form-control.withclear.rounded,\n            .w-100\n             {\n                background-color: transparent !important;\n            }\n            \n            html[data-darkreader-scheme="dark"] .bg-white,\n            html[data-darkreader-scheme="dark"] .navbar,\n            html[data-darkreader-scheme="dark"] #page,\n            html[data-darkreader-scheme="dark"] #region-main,\n            html[data-darkreader-scheme="dark"] .w-100 {\n                background-color: transparent !important;\n            }\n\n            .section {\n                 border-bottom: none !important;\n                 margin-bottom: 1rem !important; \n            }\n            .section-item {\n                border: 1px solid rgba(0, 0, 0, 0.05) !important;\n            }\n           \n            html[data-darkreader-scheme="dark"] .section-item {\n                border: 1px solid rgba(255, 255, 255, 0.1) !important;\n            }\n\n            html[data-darkreader-scheme="dark"] #customTimetableTable thead tr,\n            html[data-darkreader-scheme="dark"] #customTimetableTable th,\n            html[data-darkreader-scheme="dark"] #customTimetableTable td:first-child {\n                background-color: transparent !important;\n            }\n        `}function W(e){return`https://polite.do-johodai.ac.jp/moodle/course/view.php?id=${e}`}async function G(){let e;const t=(await chrome.storage.local.get(a))[a];if(t)try{e=JSON.parse(t)}catch(t){e=c}return e||c}async function P(e){await chrome.storage.local.set({[a]:JSON.stringify(e)})}async function V(){if(!document.URL.includes("/my/")||!b.showTimetable){const e=document.getElementById("customTimetableWidget");return void(e&&e.remove())}let e=document.getElementById("customTimetableWidget");const t=document.querySelector("#block-region-content");if(!t)return;if(!e){e=document.createElement("div"),e.id="customTimetableWidget",e.classList.add("card","mb-3","block","custom-card-style"),e.style.cssText="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); position: relative;";const n=document.querySelector(".block_timeline");n?t.insertBefore(e,n):t.prepend(e)}const n=await G();let a=e.querySelector(".card-body");a||(a=document.createElement("div"),a.classList.add("card-body"),e.appendChild(a)),a.innerHTML=function(e,t){const n=new Date,a=u[n.getDay()],{periodNumber:o,status:r,course:i}=function(e){const t=new Date,n=u[t.getDay()],a=100*t.getHours()+t.getMinutes();for(const t of m)if(a>=t.start&&a<=t.end){const a=t.period.toString();return e[n]&&e[n][a]?{periodNumber:a,status:"授業中",course:e[n][a]}:{periodNumber:a,status:"空きコマ"}}for(let e=0;e<m.length-1;e++)if(a>m[e].end&&a<m[e+1].start)return{periodNumber:null,status:"休み時間"};return{periodNumber:null,status:"授業時間外"}}(e);let d=`\n            <div style="padding: 12px 15px;">\n                <h4 style="margin-top: 0; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; border-bottom: 2px solid #eee; padding-bottom: 8px;">\n                    週間時間割\n                    <button id="editTimetableBtn" style="font-size: 0.75em; padding: 5px 10px; border: 1px solid #ddd; background-color: #fff; cursor: pointer; border-radius: 4px; color: #555; transition: all 0.2s;">編集</button>\n                </h4>\n                <div style="font-size: 0.9em; font-weight: bold; margin-bottom: 15px;">\n                    現在:\n                    ${"授業中"===r?`<span style="color: #dc3545;">${o}講時 - ${i.name}</span> <a href="${W(i.id)}" target="_self" style="font-size: 0.85em; margin-left: 10px; color: #007bff; text-decoration: none;">[コースへ]</a>`:`<span style="color: #6c757d;">${r} ${o?`(${o}講時)`:""}</span>`}\n                </div>\n                <table id="customTimetableTable" style="table-layout: fixed; width: 100%; border-collapse: separate; border-spacing: 0; text-align: left; font-size: 0.9em; border: 1px solid #eee; border-radius: 6px; overflow: hidden;">\n                    <thead>\n                        <tr style="">\n                            <th style="padding: 8px; border-bottom: 1px solid #ddd; white-space: nowrap; color: #555; width: 7%;">時間</th>\n                            ${u.slice(1,6).map(e=>`<th style="padding: 8px; border-bottom: 1px solid #ddd; text-align:center; width: 18.6%; color: #555; ${e===a?"background-color: rgba(220, 53, 69, 0.08); color: #dc3545; font-weight:bold;":""}">${e}</th>`).join("")}\n                        </tr>\n                    </thead>\n                    <tbody>\n        `;for(const n of m){const r=n.period.toString(),i=Math.floor(n.start/100),l=(n.start%100).toString().padStart(2,"0"),s=Math.floor(n.end/100),c=(n.end%100).toString().padStart(2,"0");d+=`<tr><td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 0.85em; color: #777; background-color: transparent; white-space: nowrap;">${r}<br><span style="font-size:0.8em; opacity:0.8;">(${i}:${l}～${s}:${c})</span></td>`;for(let n=1;n<=5;n++){const i=u[n],l=e[i]?e[i][r]:null;if(d+=`<td style="${i===a&&r===o?"padding: 6px; background-color: rgba(230, 240, 255, 0.5); border-bottom: 1px solid #ddd; position: relative; vertical-align: top;":"padding: 6px; border-bottom: 1px solid #eee; position: relative; vertical-align: top;"}">`,l){d+=`<a href="${W(l.id)}" target="_self" title="${l.name}" style="color: #0d6efd; text-decoration: none; display:block; font-weight: 600; font-size: 0.95em; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${l.name}</a>`;const e=C(l.name),n=(t||[]).filter(t=>{const n=C(t.courseName);return n.includes(e)||e.includes(n)}).sort((e,t)=>e.dueTimestamp-t.dueTimestamp);n.length>0&&(d+='<div class="timetable-deadline-container">',n.forEach(e=>{d+=`\n                                <div class="timetable-deadline-card">\n                                    <div class="deadline-row-top">\n                                        <span class="deadline-name" title="${e.assignmentName}">${e.assignmentName}</span>\n                                    </div>\n                                    <div class="deadline-row-bottom">\n                                        <span class="custom-countdown-timer deadline-timer" data-due-timestamp="${e.dueTimestamp}"></span>\n                                        <span class="deadline-date">${e.dueDateString}まで</span>\n                                    </div>\n                                </div>`}),d+="</div>")}else d+='<span class="timetable-empty-cell">-</span>';d+="</td>"}d+="</tr>"}return d+="\n                    </tbody>\n                </table>\n            </div>\n        ",d}(n,v),x&&clearInterval(x),X(),x=setInterval(()=>{document.hidden||X()},1e3);const o=document.getElementById("editTimetableBtn");o&&o.addEventListener("click",async()=>{S();let e=document.getElementById("timetable-modal");e&&e.remove(),J(await G()),document.getElementById("timetable-modal").style.display="flex"}),H(b.contentOpacity)}function J(e){if(document.getElementById("timetable-modal"))return;const t=function(e){const t=u.slice(1,6),n=m.map(e=>e.period.toString());let a=`\n            <div class="modal-alert-message">\n                <strong>予測変換の候補が少ない場合:</strong>\n                <p style="margin: 5px 0 0 0; font-size:0.95em;">\n                    Moodleの仕様により、現在画面に表示されているコースしか取得できません。<br>\n                    編集ボタンを押す前に、ダッシュボードの「コース概要」の左下で「すべて表示」に切り替えてから、全コースを画面に表示させてください。\n                </p>\n            </div>\n            <p style="margin-bottom: 15px; font-size: 0.9em;">\n                <b>使い方:</b> 科目名を入力すると候補が表示されます。候補をクリックするとIDが自動入力されます。<br>\n                データが消えるのが心配な場合は「書き出し」でバックアップを保存してください。\n            </p>\n            <div id="timetable-edit-grid" style="display: grid; grid-template-columns: 80px repeat(5, 1fr); gap: 8px; font-size: 0.85em;">\n                <div style="font-weight: bold; text-align: center;">時間</div>\n                ${t.map(e=>`<div style="font-weight: bold; text-align: center;">${e}</div>`).join("")}\n        `;for(const o of n){const n=m.find(e=>e.period.toString()===o);let r="";n&&(r=`${Math.floor(n.start/100)}:${(n.start%100).toString().padStart(2,"0")}～${Math.floor(n.end/100)}:${(n.end%100).toString().padStart(2,"0")}`),a+=`<div style="font-weight: bold; line-height: 1.2; text-align:center;">${o}<br><span style="font-size:0.75em">${r}</span></div>`;for(const n of t){const t=e[n]&&e[n][o]?e[n][o]:null;a+=`\n                    <div class="input-wrapper-relative">\n                        <input type="text" class="course-name-input" data-day="${n}" data-period="${o}" id="name-${n}-${o}" placeholder="科目名" value="${t?t.name:""}" style="width: 100%; margin-bottom: 2px; padding: 4px; border:1px solid #ccc; border-radius:3px;" autocomplete="off">\n                        <ul class="suggestion-list" id="suggest-${n}-${o}"></ul>\n                        <input type="number" id="id-${n}-${o}" placeholder="ID" value="${t?t.id:""}" style="width: 100%; padding: 4px; border:1px solid #eee; border-radius:3px; font-size:0.9em; background:#f9f9f9;">\n                    </div>\n                `}}return a+="</div>",`\n            <div id="timetable-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 10000; display: none; justify-content: center; align-items: center;">\n                <div id="timetable-modal-content" style="background-color: white; padding: 25px; border-radius: 8px; width: 95%; max-width: 950px; max-height: 95%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; display: flex; flex-direction: column;">\n                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">\n                        <h4 style="margin:0;">時間割編集</h4>\n                        <div>\n                            <button id="exportTimetableBtn" style="padding: 6px 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 0.9em;">\n                                <i class="fa fa-download"></i> 書き出し\n                            </button>\n                            <button id="importTimetableBtn" style="padding: 6px 12px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">\n                                <i class="fa fa-upload"></i> 読み込み\n                            </button>\n                            <input type="file" id="importTimetableInput" accept=".json" style="display:none;">\n                        </div>\n                    </div>\n                    \n                    <div style="overflow-y: auto; flex-grow: 1; padding-right: 5px;">\n                        ${a}\n                    </div>\n                    \n                    <div style="margin-top: 20px; text-align: right; flex-shrink: 0; border-top: 1px solid #eee; padding-top: 15px;">\n                        <button id="saveTimetableBtn" style="padding: 10px 30px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; font-weight:bold;">\n                            保存して適用\n                        </button>\n                        <button id="closeTimetableModal" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">\n                            キャンセル\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `}(e);document.body.insertAdjacentHTML("beforeend",t);const n=document.getElementById("timetable-modal");!function(){const e=document.createElement("style");e.innerHTML='\n            /* Suggestion list design */\n            .suggestion-list {\n                position: absolute;\n                top: 100%;\n                left: 0;\n                right: 0;\n                background: white;\n                border: 1px solid #ccc;\n                border-radius: 0 0 4px 4px;\n                list-style: none;\n                padding: 0;\n                margin: 0;\n                max-height: 200px; /* Height adjustment */\n                overflow-y: auto;\n                z-index: 2147483647; /* Fix occlusion with max Z-INDEX */\n                box-shadow: 0 4px 6px rgba(0,0,0,0.15);\n                display: none;\n                text-align: left;\n            }\n            .suggestion-list li {\n                padding: 8px 10px;\n                cursor: pointer;\n                font-size: 0.9em;\n                border-bottom: 1px solid #eee;\n                color: #333;\n                background: #fff;\n            }\n            .suggestion-list li:last-child {\n                border-bottom: none;\n            }\n            .suggestion-list li:hover {\n                background-color: #e9ecef;\n                color: #0056b3;\n            }\n            .input-wrapper-relative {\n                position: relative;\n            }\n            /* Styles for alert messages */\n            .modal-alert-message {\n                padding: 10px;\n                background-color: #fff3cd; \n                color: #856404; \n                border: 1px solid #ffeeba;\n                border-radius: 4px;\n                margin-bottom: 15px;\n                font-size: 0.9em;\n                line-height: 1.4;\n            }\n            .modal-alert-message strong {\n                color: #dc3545; /* Highlight in red */\n            }\n            /* DarkReader overrides */\n            html[data-darkreader-scheme="dark"] .modern-modal-content {\n                background-color: #1c1c1c !important;\n                color: #d1d1d1 !important;\n            }\n            html[data-darkreader-scheme="dark"] .modern-modal-header {\n                background: #252525 !important;\n                border-bottom-color: #333 !important;\n            }\n            html[data-darkreader-scheme="dark"] .modern-modal-footer {\n                background: #252525 !important;\n                border-top-color: #333 !important;\n            }\n            html[data-darkreader-scheme="dark"] .settings-group {\n                background: #252525 !important;\n                border-color: #333 !important;\n            }\n            html[data-darkreader-scheme="dark"] .modern-input, \n            html[data-darkreader-scheme="dark"] .modern-select {\n                background: #333 !important;\n                color: #d1d1d1 !important;\n                border-color: #555 !important;\n            }\n            html[data-darkreader-scheme="dark"] .modern-range::-webkit-slider-thumb {\n                background: #0099ff !important; \n            }\n            html[data-darkreader-scheme="dark"] .toggle-switch .slider {\n                background-color: #555 !important; \n            }\n            html[data-darkreader-scheme="dark"] .toggle-switch input:checked + .slider {\n                background-color: #007bff !important; \n            }\n            html[data-darkreader-scheme="dark"] .toggle-switch .label-text { \n                color: #d1d1d1 !important; \n            }\n            html[data-darkreader-scheme="dark"] .modal-alert-message {\n                background-color: #584f3e !important; \n                color: #f7e6b7 !important; \n                border-color: #807357 !important;\n            }\n        ',document.head.appendChild(e)}(),document.getElementById("saveTimetableBtn").addEventListener("click",Z),document.getElementById("closeTimetableModal").addEventListener("click",()=>{n.style.display="none"}),document.getElementById("exportTimetableBtn").addEventListener("click",async()=>{const e=await G(),t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download="moodle_timetable_backup.json",o.click(),URL.revokeObjectURL(a)}),document.getElementById("importTimetableBtn").addEventListener("click",()=>{document.getElementById("importTimetableInput").click()}),document.getElementById("importTimetableInput").addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;const a=new FileReader;a.onload=async e=>{try{const t=JSON.parse(e.target.result);await P(t),alert("時間割データを読み込みました。画面を更新します。"),n.remove(),J(t),document.getElementById("timetable-modal").style.display="flex"}catch(e){alert("ファイルの読み込みに失敗しました。正しいJSONファイルか確認してください。")}},a.readAsText(t),e.target.value=""}),n.querySelectorAll(".course-name-input").forEach(e=>{const t=e.dataset.day,n=e.dataset.period,a=document.getElementById(`suggest-${t}-${n}`),o=document.getElementById(`id-${t}-${n}`);e.addEventListener("input",()=>{const t=e.value.toLowerCase().trim();if(t.length<1)return void(a.style.display="none");const n=C(t),r=d.filter(e=>C(e.name).includes(n));r.length>0?(a.innerHTML=r.map(e=>`<li data-id="${e.id}" data-name="${e.name}">${e.name} <span style="color:#888; font-size:0.8em;">(ID:${e.id})</span></li>`).join(""),a.style.display="block",a.querySelectorAll("li").forEach(t=>{t.addEventListener("click",()=>{e.value=t.dataset.name,o.value=t.dataset.id,a.style.display="none"})})):a.style.display="none"}),e.addEventListener("blur",()=>{setTimeout(()=>{a.style.display="none"},200)}),e.addEventListener("focus",()=>{e.value.trim().length>0&&e.dispatchEvent(new Event("input"))})})}async function Z(){const e=u.slice(1,6),t=m.map(e=>e.period.toString());let n={};for(const a of e){n[a]={};for(const e of t){const t=document.getElementById(`name-${a}-${e}`),o=document.getElementById(`id-${a}-${e}`),r=t?t.value.trim():"",i=o?o.value.trim():"";r&&i&&!isNaN(parseInt(i))&&(n[a][e]={name:r,id:parseInt(i)})}}n["土"]={},n["日"]={},await P(n),document.getElementById("timetable-modal").style.display="none",await V()}function Y(e){if(e<=0)return'<span class="timer-expired">[ 期限切れ ]</span>';const t=Math.floor(e/86400),n=Math.floor(e%86400/3600),a=Math.floor(e%3600/60),o=Math.floor(e%60);let r=[],i="timer-safe";return t>0?(r.push(`<b>${t}</b>日`),r.push(`<b>${n}</b>時間`),r.push(`<b>${a}</b>分`),t<=3&&(i="timer-warning"),t<=1&&(i="timer-danger")):n>0?(r.push(`<b>${n}</b>時間`),r.push(`<b>${a}</b>分`),r.push(`<b>${o}</b>秒`),i="timer-danger"):(r.push(`<b>${a}</b>分`),r.push(`<b>${o}</b>秒`),i="timer-critical"),`<span class="${i}">あと ${r.join(" ")}</span>`}function X(){const e=document.querySelectorAll(".custom-countdown-timer"),t=Math.floor(Date.now()/1e3);if(0===e.length&&x)return clearInterval(x),void(x=null);e.forEach(e=>{const n=parseInt(e.dataset.dueTimestamp,10);if(isNaN(n))return;const a=n-t;a>86400&&""!==e.innerHTML?t%60==0&&(e.innerHTML=Y(a)):e.innerHTML=Y(a)})}function K(){confirm("解き直しモードを終了しますか？\n（ページがリロードされ、元のレビュー画面に戻ります")&&window.location.reload()}function Q(){if(!f){if(y.clear(),document.querySelectorAll("div.que").forEach(e=>{const t=e.id;if(!t)return;let n={type:null,answer:null};const a=e.querySelector(".feedback .rightanswer");let o="";if(a&&(o=a.textContent.trim()),e.classList.contains("multichoice")){n.type="multichoice";const t=e.querySelector('.answer .correct input[type="radio"], .answer .correct input[type="checkbox"]');t&&(n.answer=t.value)}else if(e.classList.contains("truefalse"))if(n.type="truefalse",o.includes("正解は「○」です")||o.toLowerCase().includes("the correct answer is 'true'"))n.answer="1";else if(o.includes("正解は「×」です")||o.toLowerCase().includes("the correct answer is 'false'"))n.answer="0";else{const t=e.querySelector('.answer .correct input[type="radio"]');t&&(n.answer=t.value)}else if(e.classList.contains("numerical")){if(n.type="numerical",o){const e=o.match(/(?:正解|The correct answer is):\s*([0-9.,]+)/i);e&&e[1]&&(n.answer=e[1].replace(",","."))}}else if(e.classList.contains("shortanswer")){if(n.type="shortanswer",o){const e=o.match(/(?:正解|The correct answer is):\s*(.*)/i);e&&e[1]&&(n.answer=e[1])}}else if(e.classList.contains("gapselect")){n.type="gapselect";const t={},o=[...(a?a.innerHTML:"").matchAll(/\[([\s\S]*?)\]/g)],r=e.querySelectorAll("select");o.length>0&&r.length>0&&r.forEach((e,n)=>{const a=e.id;if(!a)return;let r=null;if(o[n]&&o[n][1]){const t=o[n][1].replace(/<[^>]+>/g,"").trim(),a=e.querySelectorAll("option");for(const e of a)if(e.textContent.trim()===t){r=e.value;break}}null!==r&&(t[a]=r)}),n.answer=t}else if(e.classList.contains("match")){n.type="match";const t={},o={};let r=a?a.innerHTML:"";r=r.replace(/<(p|div|br)[^>]*>/gi,"|||"),r=r.replace(/<[^>]+>/g,""),r=r.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">"),r.split("|||").forEach(e=>{if((e=e.trim()).includes("→")){const t=e.match(/(.+?)\s*→\s*(.+)/);if(t&&t[1]&&t[2]){let e=t[1].trim(),n=t[2].trim().replace(/,$/,"").trim();e&&n&&(e.startsWith("正解:")&&(e=e.substring(3).trim()),e&&(o[e]=n))}}}),e.querySelectorAll(".ablock .answer tr").forEach(e=>{const n=e.querySelector(".text"),a=e.querySelector(".control select");if(!n||!a)return;const r=n.textContent.trim();let i=o[r];if(!i){const e=Object.keys(o).find(e=>r.includes(e)||e.includes(r));if(!e)return;i=o[e]}let d=null;const l=a.querySelectorAll("option");for(const e of l)if(e.textContent.trim()===i){d=e.value;break}null!==d&&(t[a.id]=d)}),n.answer=t}n.type&&null!==n.answer&&(Object.keys(n.answer).length>0||"object"!=typeof n.answer)&&y.set(t,n)}),0===y.size)return void alert("エラー: 問題の正解をページから読み取れませんでした。");f=!0}k=new Date,document.querySelectorAll(".state, .grade, .outcome").forEach(e=>{e.style.display="none"}),document.querySelectorAll("i.fa-circle-check, i.fa-circle-xmark").forEach(e=>{e.classList.contains("retake-feedback-icon")||(e.style.display="none")}),document.querySelectorAll("div.que.numerical .ablock i.icon, div.que.shortanswer .ablock i.icon").forEach(e=>{e.classList.contains("retake-feedback-icon")||(e.style.display="none")}),document.querySelectorAll("div.que.gapselect .qtext i.icon").forEach(e=>{e.classList.contains("retake-feedback-icon")||(e.style.display="none")}),document.querySelectorAll("div.que.match .control i.icon").forEach(e=>{e.classList.contains("retake-feedback-icon")||(e.style.display="none")}),ee(),document.getElementById("startRetakeBtn").style.display="none",document.getElementById("gradeRetakeBtn").style.display="inline-block",document.getElementById("resetRetakeBtn").style.display="inline-block",document.getElementById("exitRetakeBtn").style.display="block"}function ee(){document.querySelectorAll("div.que").forEach(e=>{e.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(e=>{e.disabled=!1,e.checked=!1}),e.querySelectorAll('input[type="text"]').forEach(e=>{e.name&&e.name.endsWith("_answer")&&(e.disabled=!1,e.readOnly=!1,e.value="",e.classList.remove("correct","incorrect"))}),e.querySelectorAll("select").forEach(e=>{e.name&&e.name.includes(":")&&(e.disabled=!1,e.selectedIndex=0,e.classList.remove("correct","incorrect"))}),e.querySelectorAll(".state, .grade, .outcome").forEach(e=>{e.style.display="none",e.classList.contains("state")&&(e.style.color="",e.textContent="")}),e.querySelectorAll("i.fa-circle-check, i.fa-circle-xmark").forEach(e=>{e.classList.contains("retake-feedback-icon")||(e.style.display="none")}),e.querySelectorAll(".retake-feedback-icon").forEach(e=>{e.remove()});const t=e.querySelector(".ablock .icon");t&&(e.classList.contains("numerical")||e.classList.contains("shortanswer"))&&(t.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),t.style.display="none",t.setAttribute("title",""),t.setAttribute("aria-label","")),e.querySelectorAll("div.que.gapselect .qtext i.icon").forEach(e=>{e.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),e.style.display="none",e.setAttribute("title",""),e.setAttribute("aria-label","")}),e.querySelectorAll("div.que.match .control i.icon").forEach(e=>{e.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),e.style.display="none",e.setAttribute("title",""),e.setAttribute("aria-label","")})});const e=document.getElementById("retake-result");e&&(e.innerHTML=""),k=new Date}function te(){ee()}function ne(){const e=new Date;let t=0,n=0;y.forEach((e,a)=>{const o=document.getElementById(a);if(!o)return;const r=o.querySelector(".state"),i=o.querySelector(".outcome"),d=o.querySelector(".grade");let l=0;if(d){const e=d.textContent.match(/[0-9.]+\s*\/\s*([0-9.]+)/);e&&e[1]&&(l=parseFloat(e[1]))}t+=l;let s=0,c=!1;const m=a.split("-");if(m.length<3)return;const u=`q${m[1]}:${m[2]}_answer`,p=e=>{const t=e?"fa-circle-check text-success":"fa-circle-xmark text-danger",n=e?"正解":"不正解",a=document.createElement("span");return a.className="ms-1 retake-feedback-icon",a.innerHTML=`<i class="icon fa-regular ${t} fa-fw" title="${n}" role="img" aria-label="${n}"></i>`,a};if("multichoice"===e.type||"truefalse"===e.type){const t=o.querySelector(`input[name="${u}"]:checked`),n=o.querySelectorAll(`.answer input[name="${u}"]`);c=t&&t.value===e.answer,n.forEach(n=>{const a=n.value===e.answer,o=t&&n.value===t.value,r=n.closest(".r0, .r1");if(r){if(r.querySelectorAll(".retake-feedback-icon").forEach(e=>e.remove()),a){const e=p(!0);r.appendChild(e)}else if(o&&!c){const e=p(!1);r.appendChild(e)}n.disabled=!0}})}else if("numerical"===e.type||"shortanswer"===e.type){const t=o.querySelector(`input[name="${u}"]`),n=t?t.value.trim():"",a="numerical"===e.type?e.answer.replace(",","."):e.answer;("numerical"===e.type?n.replace(",","."):n).toLowerCase()===a.toLowerCase()&&(c=!0),t&&(t.classList.remove("correct","incorrect"),t.classList.add(c?"correct":"incorrect"),t.disabled=!0);let r=t?t.nextElementSibling:null;r&&"I"===r.tagName||(r=t?t.parentElement.nextElementSibling:null),r&&"I"===r.tagName&&r.classList.contains("icon")&&(r.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),c?(r.classList.add("fa-regular","fa-circle-check","text-success"),r.setAttribute("title","正解"),r.setAttribute("aria-label","正解")):(r.classList.add("fa-regular","fa-circle-xmark","text-danger"),r.setAttribute("title","不正解"),r.setAttribute("aria-label","不正解")),r.style.display="inline-block",r.classList.add("retake-feedback-icon"))}else if("gapselect"===e.type){let t=!0,a=0;const r=o.querySelectorAll("select");let i=0;0===r.length&&(t=!1),r.forEach(n=>{if(!n.name||!n.name.includes(":"))return;i++,n.disabled=!0;const o=n.id,r=e.answer[o],d=n.value;let l=void 0!==r&&d===r;l?a++:t=!1,n.classList.remove("correct","incorrect"),n.classList.add(l?"correct":"incorrect");const s=n.nextElementSibling;s&&"I"===s.tagName&&s.classList.contains("icon")&&(s.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),l?(s.classList.add("fa-regular","fa-circle-check","text-success"),s.setAttribute("title","正解"),s.setAttribute("aria-label","正解")):(s.classList.add("fa-regular","fa-circle-xmark","text-danger"),s.setAttribute("title","不正解"),s.setAttribute("aria-label","不正解")),s.style.display="inline-block",s.classList.add("retake-feedback-icon"))}),c=t,i>0?s=l*(a/i):r.length>0&&(s=l*(a/r.length)),n+=s}else if("match"===e.type){let t=!0,a=0;const r=o.querySelectorAll(".ablock .answer select");0===r.length&&(t=!1),r.forEach(n=>{n.disabled=!0;const o=n.id,r=e.answer[o],i=n.value;let d=void 0!==r&&i===r;d?a++:t=!1,n.classList.remove("correct","incorrect"),n.classList.add(d?"correct":"incorrect");const l=n.closest(".control");if(l){const e=l.querySelector("i.icon");e&&(e.classList.remove("fa-regular","fa-circle-check","text-success","fa-circle-xmark","text-danger"),d?(e.classList.add("fa-regular","fa-circle-check","text-success"),e.setAttribute("title","正解"),e.setAttribute("aria-label","正解")):(e.classList.add("fa-regular","fa-circle-xmark","text-danger"),e.setAttribute("title","不正解"),e.setAttribute("aria-label","不正解")),e.style.display="inline-block",e.classList.add("retake-feedback-icon"))}}),c=t,r.length>0&&(s=l*(a/r.length)),n+=s}"gapselect"!==e.type&&"match"!==e.type&&c&&(s=l,n+=l),r&&(("gapselect"===e.type||"match"===e.type)&&!c&&s>0?(r.textContent="部分的に正解",r.style.color="#FF8C00"):(r.textContent=c?"正解":"不正解",r.style.color=c?"#28a745":"#dc3545"),r.style.display="block"),d&&(d.innerHTML=`${s.toFixed(2)} / ${l.toFixed(2)}`,d.style.display="block"),i&&(i.style.display="block")});const a=document.getElementById("retake-result");if(a){let o="-";if(k){const t=e.getTime()-k.getTime(),n=Math.round(t/1e3);o=`${Math.floor(n/60)} 分 ${n%60} 秒`}const r=e=>{if(!e)return"-";const t={year:"numeric",month:"long",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit",hour12:!1};try{return e.toLocaleString("ja-JP",t)}catch(t){return e.toLocaleString()}},i=t>0?n/t*100:0;let d=`\n                <h3 style="margin-top: 1.5rem; border-bottom: 1px solid #ddd; padding-bottom: 5px;">解き直し結果</h3>\n                <div class="mb-3">\n                    <table class="table generaltable generalbox quizreviewsummary mb-0">\n                       <caption class="visually-hidden">結果の概要</caption>\n                       <tbody>\n                            <tr>\n                                <th class="cell" scope="row">ステータス</th>\n                                <td class="cell">解き直し完了</td>\n                            </tr>\n                            <tr>\n                                <th class="cell" scope="row">開始日時</th>\n                                <td class="cell">${r(k)}</td>\n                            </tr>\n                            <tr>\n                                <th class="cell" scope="row">完了日時</th>\n                                <td class="cell">${r(e)}</td>\n                            </tr>\n                            <tr>\n                                <th class="cell" scope="row">継続時間</th>\n                                <td class="cell">${o}</td>\n                            </tr>\n                            <tr>\n                                <th class="cell" scope="row">評点</th>\n                                <td class="cell"><b>${n.toFixed(2)}</b> / ${t.toFixed(2)} (<b>${i.toFixed(0)}</b>%)</td>\n                            </tr>\n                       </tbody>\n                    </table>\n                </div>\n            `;Math.abs(t-n)<.001?d+='<p style="color: #028dffff; font-weight: bold; font-size: 1.1em; margin-top: 1rem;">素晴らしい！全問正解です！</p>\n                    <div style="text-align: center; margin-top: 15px;">\n                    <img src="https://placehold.co/150x150/dff4d8/357a32?text=PERFECT%21" alt="Perfect Score" style="border-radius: 50%; max-width: 100%;">\n                    </div>':d+='<p style="color: #ff3131e1; font-size: 1.1em; margin-top: 1rem;">間違えた問題を確認して「リセット」でもう一度挑戦できます。</p>',a.innerHTML=d,k=new Date}}document.addEventListener("DOMContentLoaded",()=>{!async function(){l=Date.now(),function(){const e=document.createElement("style");e.id="dashboard-fullwidth-layout-css",document.head.appendChild(e)}(),await $();const e=await T();"on"===e.darkModeMode||"auto"===e.darkModeMode&&window.matchMedia("(prefers-color-scheme: dark)").matches?(function(){if(!document.getElementById("moodle-custom-loading-screen")){const e=document.createElement("div");e.id="moodle-custom-loading-screen";const t="https://raw.githubusercontent.com/Miaka1020/Moodle-Custom-Extension/main/assets/Loading2.png";e.innerHTML=`\n                <div class="loading-content">\n                    <img src="${t}" alt="" class="custom-loading-img">\n                    <div class="loading-bar-container">\n                        <div class="loading-bar-fill"></div>\n                    </div>\n                </div>\n            `,document.body.appendChild(e)}}(),setTimeout(()=>{const e=document.getElementById("moodle-custom-loading-screen");e&&"1"===e.style.opacity&&(console.warn("Dark Reader loading timed out. Forcing removal of loading screen."),B())},2e3)):(document.body.classList.remove("dark-mode-fouc-temp"),document.documentElement.classList.remove("dark-fouc-mask")),localStorage.getItem(o)||q(e),I(e),document.body?M(e):document.addEventListener("DOMContentLoaded",()=>M(e)),setTimeout(S,2e3),window.printAvailableCourses=function(){console.log("--- Moodle Customizer: availableCourses ---"),console.log(d),console.log("------------------------------------------")}}()})}();