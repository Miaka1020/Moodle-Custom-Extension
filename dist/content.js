!function(){"use strict";const e="background_files",t="current_bg",n="moodle_custom_settings_v4",o="moodle_custom_timetable_v2",r={headerBgColor:"#ffffff",headerTextColor:"#000000",headerStrokeColor:"#ffffff",backgroundUrl:"",backgroundType:"none",opacity:80,brightness:100,showTimetable:!0,contentOpacity:70},a={月:{},火:{},水:{},木:{},金:{},土:{},日:{}},i=[{start:900,end:1030,period:1},{start:1040,end:1210,period:2},{start:1255,end:1425,period:3},{start:1435,end:1605,period:4},{start:1615,end:1745,period:5},{start:1755,end:1925,period:6}],d=["日","月","火","水","木","金","土"],l="body#page-my-index, body#page-course-view-topics, body#page-course-view-weeks,body#page";let c,s={},p=null;async function g(){let o;const a=(await chrome.storage.local.get(n))[n];if(a)try{o=JSON.parse(a)}catch(e){console.error("設定データのパースに失敗。デフォルトを使用します。",e),o=r}else o=r;if(s={...r,...o},"indexeddb"===s.backgroundUrl)try{const n=await new Promise((n,o)=>{if(!c)return n(null);const r=c.transaction([e],"readonly").objectStore(e).get(t);r.onsuccess=e=>{const t=e.target.result;if(t&&t.blob){const e=URL.createObjectURL(t.blob);n({url:e,type:t.type})}else n(null)},r.onerror=e=>o(e)});n?(p&&URL.revokeObjectURL(p),p=n.url,s.backgroundUrl=n.url,s.backgroundType=n.type.startsWith("video/")?"video":"image"):(s.backgroundUrl="",s.backgroundType="none")}catch(e){console.error("Failed to load file from IndexedDB:",e),s.backgroundUrl="",s.backgroundType="none"}else""===s.backgroundUrl||s.backgroundUrl.startsWith("blob:")||(s.backgroundUrl="",s.backgroundType="none");return s}async function m(e){p&&p!==e.backgroundUrl&&(URL.revokeObjectURL(p),p=null);let t={...e};t.backgroundUrl.startsWith("blob:")?t.backgroundUrl="indexeddb":"indexeddb"!==t.backgroundUrl&&(t.backgroundUrl="",t.backgroundType="none"),await chrome.storage.local.set({[n]:JSON.stringify(t)}),s=e}function u(n){const o=`\n            <div id="custom-settings-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 10001; display: none; justify-content: center; align-items: center;">\n                <div id="custom-settings-content" style="background-color: white; padding: 30px; border-radius: 8px; width: 95%; max-width: 600px; max-height: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; display: flex; flex-direction: column;">\n                    <h4 style="margin-top: 0; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">\n                       Moodle カスタム設定\n                    </h4>\n                    <div style="overflow-y: auto; flex-grow: 1;">\n\n                        <fieldset style="border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 4px;">\n                            <legend style="font-weight: bold; padding: 0 10px; width: auto; margin-left: -5px;">ヘッダー設定</legend>\n                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: center;">\n                                <label for="headerBgColorInput" style="font-weight: 500;">背景色:</label>\n                                <input type="color" id="headerBgColorInput" value="${n.headerBgColor}" style="height: 35px; width: 100%; border: 1px solid #ccc; padding: 2px;">\n                                <label for="headerTextColorInput" style="font-weight: 500;">文字色:</label>\n                                <input type="color" id="headerTextColorInput" value="${n.headerTextColor}" style="height: 35px; width: 100%; border: 1px solid #ccc; padding: 2px;">\n                                <label for="headerStrokeColorInput" style="font-weight: 500;">文字枠線色:</label>\n                                <input type="color" id="headerStrokeColorInput" value="${n.headerStrokeColor}" style="height: 35px; width: 100%; border: 1px solid #ccc; padding: 2px;">\n                            </div>\n                        </fieldset>\n\n                        <fieldset style="border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 4px;">\n                            <legend style="font-weight: bold; padding: 0 10px; width: auto; margin-left: -5px;">ページ背景設定 (画像/動画)</legend>\n                            <input type="file" id="backgroundFileInput" accept="image/*,video/*" style="display: none;">\n                            <button id="selectBackgroundBtn" style="padding: 8px 15px; background-color: #0062caff; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%; margin-bottom: 15px;">\n                                ファイルを選択する (IndexedDB)\n                            </button>\n                            <p id="currentBackgroundInfo" style="font-size: 0.9em; color: #6c757d;"></p>\n                            <p style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">※画像・動画ともに大容量でも保存可能です。</p>\n                            <hr>\n                            <div style="margin-bottom: 15px;">\n                                <label style="display: block; margin-bottom: 5px;">背景種別（現在の設定）:</label>\n                                <input type="radio" id="bg-type-video" name="bg-type" value="video" ${"video"===n.backgroundType?"checked":""} disabled>\n                                <label for="bg-type-video" style="margin-right: 15px;">動画</label>\n                                <input type="radio" id="bg-type-image" name="bg-type" value="image" ${"image"===n.backgroundType?"checked":""} disabled>\n                                <label for="bg-type-image">画像</label>\n                            </div>\n                            <div style="margin-top: 20px;">\n                                <label for="opacityRange" style="display: block; margin-bottom: 5px; font-weight: bold;">背景の透明度: <span id="opacityValue">${n.opacity}</span>%</label>\n                                <input type="range" id="opacityRange" min="0" max="100" value="${n.opacity}" style="width: 100%;">\n                            </div>\n                            <div style="margin-top: 15px;">\n                                <label for="brightnessRange" style="display: block; margin-bottom: 5px; font-weight: bold;">背景の明度: <span id="brightnessValue">${n.brightness}</span>%</label>\n                                <input type="range" id="brightnessRange" min="0" max="200" value="${n.brightness}" style="width: 100%;">\n                                <small style="color: #6c757d;">(100%が標準)</small>\n                            </div>\n                        </fieldset>\n\n                        <fieldset style="border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 4px;">\n                            <legend style="font-weight: bold; padding: 0 10px; width: auto; margin-left: -5px;">コンテンツブロック背景設定</legend>\n                            <div style="margin-top: 15px;">\n                                <label for="contentOpacityRange" style="display: block; margin-bottom: 5px; font-weight: bold;">ブロックの透明度: <span id="contentOpacityValue">${n.contentOpacity}</span>%</label>\n                                <input type="range" id="contentOpacityRange" min="0" max="100" value="${n.contentOpacity}" style="width: 100%;">\n                                <small style="color: #6c757d;">(0%で完全透明、100%で白が不透明)</small>\n                            </div>\n                        </fieldset>\n\n                        <fieldset style="border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 4px;">\n                             <legend style="font-weight: bold; padding: 0 10px; width: auto; margin-left: -5px;">ウィジェット設定</legend>\n                             <div style="margin-bottom: 15px;">\n                                <input type="checkbox" id="showTimetableCheckbox" ${n.showTimetable?"checked":""}>\n                                <label for="showTimetableCheckbox" style="font-weight: bold; margin-left: 5px;">ダッシュボードにカスタム時間割を表示</label>\n                            </div>\n                        </fieldset>\n\n                        <div style="text-align: right; margin-top: 10px;">\n                            <button id="resetSettingsBtn" style="padding: 8px 15px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">\n                                設定をリセット\n                            </button>\n                        </div>\n                    </div>\n                    <div style="margin-top: 20px; text-align: right; flex-shrink: 0; border-top: 1px solid #eee; padding-top: 15px;">\n                        <button id="saveSettingsBtn" style="padding: 10px 20px; background-color: #0077ff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">\n                            保存\n                        </button>\n                        <button id="closeSettingsModal" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">\n                            閉じる\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `;document.body.insertAdjacentHTML("beforeend",o),function(){const n=document.getElementById("custom-settings-modal"),o=document.getElementById("saveSettingsBtn"),a=document.getElementById("closeSettingsModal"),i=document.getElementById("resetSettingsBtn"),d=document.getElementById("headerBgColorInput"),l=document.getElementById("headerTextColorInput"),u=document.getElementById("headerStrokeColorInput"),v=document.getElementById("opacityRange"),k=document.getElementById("brightnessRange"),w=document.getElementById("contentOpacityRange"),B=document.getElementById("backgroundFileInput"),I=document.getElementById("selectBackgroundBtn");function E(){h({...s,headerBgColor:d.value,headerTextColor:l.value,headerStrokeColor:u.value})}d.addEventListener("input",E),l.addEventListener("input",E),u.addEventListener("input",E),v.addEventListener("input",y),k.addEventListener("input",y),w&&w.addEventListener("input",e=>{document.getElementById("contentOpacityValue").textContent=e.target.value,f(parseInt(e.target.value))}),I&&I.addEventListener("click",()=>{B.click()}),B&&B.addEventListener("change",n=>{if(n.target.files.length>0){const o=n.target.files[0],r=o.type.startsWith("video/")?"video":"image";!async function(n,o){p&&(URL.revokeObjectURL(p),p=null);try{await(r=n,a=n.type,new Promise((n,o)=>{if(!c)return o("DB not initialized");const i=c.transaction([e],"readwrite").objectStore(e),d={id:t,blob:r,type:a},l=i.put(d);l.onsuccess=()=>n(),l.onerror=e=>o(e)}));const i=URL.createObjectURL(n);p=i,s.backgroundUrl=i,s.backgroundType=o,y();const d=document.getElementById("custom-settings-modal");d&&"flex"===d.style.display&&(document.getElementById("currentBackgroundInfo").innerHTML="**現在の背景**: ローカルファイル (IndexedDB経由・永続化済み)",document.getElementById("bg-type-video").checked="video"===o,document.getElementById("bg-type-image").checked="image"===o),alert(`背景ファイル ${n.name} をプレビュー適用しました。\n「保存」ボタンを押して永続化してください。`)}catch(e){console.error("IndexedDB Save Error:",e),alert("エラー: ファイルの保存中に問題が発生しました。")}var r,a}(o,r),n.target.value=""}}),o&&o.addEventListener("click",async()=>{const e={...s,headerBgColor:d.value,headerTextColor:l.value,headerStrokeColor:u.value,opacity:parseInt(v.value),brightness:parseInt(k.value),showTimetable:document.getElementById("showTimetableCheckbox").checked,contentOpacity:parseInt(w.value)};await m(e),n.style.display="none",$(!0)}),a&&a.addEventListener("click",async()=>{const e=await g();h(e),x(e),f(e.contentOpacity),n.style.display="none"}),i&&i.addEventListener("click",async()=>{if(confirm("全てのカスタム設定を初期値に戻しますか？（時間割の内容はリセットされません）")){p&&(URL.revokeObjectURL(p),p=null);try{c.transaction([e],"readwrite").objectStore(e).clear()}catch(e){console.warn("Failed to clear IndexedDB:",e)}await m(r),b(r),$(!0),alert("カスタム設定をリセットし、反映しました。")}})}()}function b(e){document.getElementById("headerBgColorInput").value=e.headerBgColor,document.getElementById("headerTextColorInput").value=e.headerTextColor,document.getElementById("headerStrokeColorInput").value=e.headerStrokeColor;const t=document.getElementById("currentBackgroundInfo"),n=document.getElementById("bg-type-video"),o=document.getElementById("bg-type-image");n.checked="video"===e.backgroundType,o.checked="image"===e.backgroundType,e.backgroundUrl.startsWith("blob:")?t.innerHTML="現在の背景: ローカルファイル (IndexedDB経由・永続化済み)":t.innerHTML="現在の背景: なし (ファイルを選択してください)",document.getElementById("opacityRange").value=e.opacity,document.getElementById("opacityValue").textContent=e.opacity,document.getElementById("brightnessRange").value=e.brightness,document.getElementById("brightnessValue").textContent=e.brightness,document.getElementById("showTimetableCheckbox").checked=e.showTimetable,document.getElementById("contentOpacityRange").value=e.contentOpacity,document.getElementById("contentOpacityValue").textContent=e.contentOpacity}function y(){const e=document.getElementById("opacityRange"),t=document.getElementById("brightnessRange");if(!e||!t)return;const n=parseInt(e.value),o=parseInt(t.value);document.getElementById("opacityValue").textContent=n,document.getElementById("brightnessValue").textContent=o,x({...s,opacity:n,brightness:o})}function h(e){let t=document.getElementById("custom-header-style");t||(t=document.createElement("style"),t.id="custom-header-style",document.head.appendChild(t));const n=`\n            -1px -1px 0 ${e.headerStrokeColor}, 1px -1px 0 ${e.headerStrokeColor},\n            -1px  1px 0 ${e.headerStrokeColor}, 1px  1px 0 ${e.headerStrokeColor}\n        `;t.innerHTML=`\n            .navbar.fixed-top.navbar-light.bg-white, .navbar {\n                background-color: ${e.headerBgColor} !important;\n                background-image: none !important;\n                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);\n                border-bottom: none !important;\n            }\n            .navbar-brand, .navbar-nav .nav-link, #customSettingsBtn {\n                color: ${e.headerTextColor} !important;\n                text-shadow: ${n};\n            }\n            .usernavigation .btn, .usernavigation .usermenu .btn {\n                color: ${e.headerTextColor} !important;\n                text-shadow: none !important;\n            }\n        `}function x(e={}){const t={...s,...e},n=document.getElementById("background-video"),o=document.getElementById("background-image-container"),r=document.querySelector(l);if(!r||!n||!o)return;r.style.overflowX="hidden";const a=t.opacity/100,i=t.brightness/100;"video"===t.backgroundType&&t.backgroundUrl?(n.src=t.backgroundUrl,n.style.display="block",n.style.opacity=a.toString(),n.style.filter=`brightness(${i})`,o.style.display="none",o.style.backgroundImage="none"):"image"===t.backgroundType&&t.backgroundUrl?(o.style.backgroundImage=`url("${t.backgroundUrl}")`,o.style.display="block",o.style.opacity=a.toString(),o.style.filter=`brightness(${i})`,n.style.display="none",n.src=""):(n.style.display="none",n.src="",o.style.display="none",o.style.backgroundImage="none")}function f(e){const t=e/100;let n=document.getElementById("custom-content-style");n||(n=document.createElement("style"),n.id="custom-content-style",document.head.appendChild(n));const o=Math.min(t+.2,1);n.innerHTML=`\n            .block, .card:not(.custom-card-style), .card-body, .card,\n            #secondary-navigation d-print-none, #page-content,\n            #region-main, #region-main-box, .bg-white {\n                background-color: rgba(255, 255, 255, ${t}) !important;\n            }\n            .card.custom-card-style {\n                background-color: rgba(255, 255, 255, ${o}) !important;\n                border: 1px solid rgba(255, 255, 255, 0.9) !important;\n            }\n        `}async function v(){const e=document.querySelector("#block-region-content");let t=document.getElementById("customTimetableWidget");if(document.URL.includes("/my/")&&e)if(s.showTimetable){const n=await w();t||(t=document.createElement("div"),t.id="customTimetableWidget",t.classList.add("card","mb-3","custom-card-style"),t.style.cssText="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); position: relative;",t.innerHTML='\n                    <div class="card-header"><h5 class="mb-0">カスタム時間割</h5></div>\n                    <div class="card-body" style="padding: 0;"></div>\n                ',e.prepend(t));const o=t.querySelector(".card-body");if(o){o.innerHTML=function(e){const t=new Date,n=d[t.getDay()],{periodNumber:o,status:r,course:a}=function(e){const t=new Date,n=d[t.getDay()],o=100*t.getHours()+t.getMinutes();for(const t of i)if(o>=t.start&&o<=t.end){const o=t.period.toString();return e[n]&&e[n][o]?{periodNumber:o,status:"授業中",course:e[n][o]}:{periodNumber:o,status:"空きコマ"}}return i.some(e=>o>e.start&&o<e.end)?{periodNumber:null,status:"休み時間"}:{periodNumber:null,status:"授業なし"}}(e);let l=`\n            <div style="padding: 15px;">\n                <h4 style="margin-top: 0; display: flex; justify-content: space-between; align-items: center;">\n                    週間時間割\n                    <button id="editTimetableBtn" style="font-size: 0.7em; padding: 5px 10px; border: 1px solid #ccc; background-color: #f8f9fa; cursor: pointer; border-radius: 4px;">編集</button>\n                </h4>\n                <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px;">\n                    現在:\n                    ${"授業中"===r?`<span style="color: #dc3545;">${o}講時 - ${a.name}</span> <a href="${k(a.id)}" target="_self" style="font-size: 0.8em; margin-left: 10px;">[コースへ]</a>`:`<span style="color: #6c757d;">${r} ${o?`(${o}講時)`:""}</span>`}\n                </div>\n                <hr style="margin: 5px 0 15px 0;">\n                <table id="customTimetableTable" style="width: 100%; border-collapse: collapse; text-align: left; font-size: 0.95em;">\n                    <thead>\n                        <tr>\n                            <th style="padding: 8px; border-bottom: 2px solid #ccc;">時間</th>\n                            ${d.slice(1,6).map(e=>`<th style="padding: 8px; border-bottom: 1px solid #ccc; ${e===n?"color: #dc3545;":""}">${e}</th>`).join("")}\n                        </tr>\n                    </thead>\n                    <tbody>\n        `;for(const t of i){const r=t.period.toString();l+=`<tr><td style="padding: 8px; border-bottom: 1px solid #eee;">${r} (${Math.floor(t.start/100)}:${(t.start%100).toString().padStart(2,"0")}〜)</td>`;for(let t=1;t<=5;t++){const a=d[t],i=e[a]?e[a][r]:null;l+=`<td style="padding: 8px; ${a===n&&r===o?"background-color: rgba(14, 114, 181, 0.1); font-weight: bold; border-bottom: 3px solid #eee;":"border-bottom: 1px solid #eee;"}">`,l+=i?`<a href="${k(i.id)}" target="_self" style="color: #007bff; text-decoration: none;">${i.name}</a>`:'<span style="color: #6c757d;">-</span>',l+="</td>"}l+="</tr>"}return l+='\n                    </tbody>\n                </table>\n                <p style="font-size: 0.8em; color: #999; margin-top: 20px;">※コース名をクリックすると直接コースページへ移動します。</p>\n            </div>\n        ',l}(n);const e=document.getElementById("editTimetableBtn");e&&e.addEventListener("click",async()=>{let e=document.getElementById("timetable-modal");e&&e.remove(),I(await w()),document.getElementById("timetable-modal").style.display="flex"})}}else t&&t.remove();else t&&t.remove()}function k(e){return`https://polite.do-johodai.ac.jp/moodle/course/view.php?id=${e}`}async function w(){let e;const t=(await chrome.storage.local.get(o))[o];if(t)try{e=JSON.parse(t)}catch(t){console.error("時間割データのパースに失敗。デフォルトを使用します。",t),e=a}else e=a,chrome.storage.local.set({[o]:JSON.stringify(a)});return e}async function B(){const e=d.slice(1,6),t=i.map(e=>e.period.toString());let n={};for(const o of e){n[o]={};for(const e of t){const t=document.getElementById(`name-${o}-${e}`),r=document.getElementById(`id-${o}-${e}`),a=t?t.value.trim():"",i=r?parseInt(r.value.trim()):null;a&&i&&!isNaN(i)&&(n[o][e]={name:a,id:i})}}await async function(e){await chrome.storage.local.set({[o]:JSON.stringify(e)})}(n),document.getElementById("timetable-modal").style.display="none",await v()}function I(e){if(document.getElementById("timetable-modal"))return;const t=function(e){const t=d.slice(1,6),n=i.map(e=>e.period.toString());let o=`\n            <p style="margin-bottom: 15px;">科目名とMoodleのコースIDを入力してください。（IDはURL <code>...id=XXX</code> のXXX部分です）</p>\n            <div id="timetable-edit-grid" style="display: grid; grid-template-columns: 80px repeat(5, 1fr); gap: 10px; font-size: 0.9em;">\n                <div style="font-weight: bold;">時間</div>\n                ${t.map(e=>`<div style="font-weight: bold; text-align: center;">${e}</div>`).join("")}\n        `;for(const r of n){const n=i.find(e=>e.period.toString()===r),a=n?`${Math.floor(n.start/100)}:${(n.start%100).toString().padStart(2,"0")}`:"";o+=`<div style="font-weight: bold; line-height: 1.2;">${r}講時<br>(${a})</div>`;for(const n of t){const t=e[n]?e[n][r]:null;o+=`\n                    <div>\n                        <input type="text" id="name-${n}-${r}" placeholder="科目名" value="${t?t.name:""}" style="width: 100%; margin-bottom: 5px; padding: 4px;">\n                        <input type="number" id="id-${n}-${r}" placeholder="コースID" value="${t?t.id:""}" style="width: 100%; padding: 4px;">\n                    </div>\n                `}}return o+="</div>",`\n            <div id="timetable-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 10000; display: none; justify-content: center; align-items: center;">\n                <div id="timetable-modal-content" style="background-color: white; padding: 30px; border-radius: 8px; width: 95%; max-width: 900px; max-height: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; display: flex; flex-direction: column;">\n                    <h4 style="margin-top: 0; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">\n                        時間割編集\n                    </h4>\n                    <div style="overflow-y: auto; flex-grow: 1;">\n                        ${o}\n                    </div>\n                    <div style="margin-top: 20px; text-align: right; flex-shrink: 0;">\n                        <button id="saveTimetableBtn" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">\n                            保存\n                        </button>\n                        <button id="closeTimetableModal" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">\n                            閉じる\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `}(e);document.body.insertAdjacentHTML("beforeend",t);const n=document.getElementById("timetable-modal");document.getElementById("saveTimetableBtn").addEventListener("click",B),document.getElementById("closeTimetableModal").addEventListener("click",()=>{n.style.display="none"})}function E(){if(!document.URL.includes("/my/"))return;const e=document.querySelector(".block_timeline");if(!e)return;const t=e.querySelectorAll('[data-region="event-list-content-date"]'),n=new Date;n.setHours(0,0,0,0);const o=new Date(n.getTime()+6048e5);t.forEach(e=>{const t=parseInt(e.getAttribute("data-timestamp")),r=new Date(1e3*t);if(r>=n&&r<o){const t=e.nextElementSibling;t&&t.querySelectorAll('[data-region="event-list-item"]').forEach(e=>{const t=e.querySelector(".timeline-name small.mb-0")?.textContent||"";(t.includes("due")||t.includes("closes")||t.includes("提出期限")||t.includes("終了"))&&e.classList.add("deadline-highlight")})}})}const T=document.createElement("style");async function $(e=!0){e&&await g();const t=s;!function(){if(document.querySelector(l)){if(!document.getElementById("background-video")){const e=document.createElement("video");e.id="background-video",e.loop=!0,e.autoplay=!0,e.muted=!0,e.playsInline=!0,e.style.cssText="\n                position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n                object-fit: cover; z-index: -100; display: none;\n                transition: opacity 0.5s ease, filter 0.5s ease;\n            ",document.body.prepend(e),e.oncanplaythrough=()=>{e.play().catch(e=>console.warn("Video autoplay blocked:",e))},e.onerror=t=>{s.backgroundUrl.startsWith("blob:")&&"video"===s.backgroundType&&(console.error("Failed to load background VIDEO (Blob/IndexedDB).",t),e.error&&alert(`動画の読み込みに失敗。\nエラーコード: ${e.error.code}\n理由: ${e.error.message}\n\nブラウザがこの動画形式をサポートしていない可能性があります。`))}}if(!document.getElementById("background-image-container")){const e=document.createElement("div");e.id="background-image-container",e.style.cssText="\n                position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n                background-size: cover; background-position: center center;\n                background-repeat: no-repeat; z-index: -100; display: none;\n                transition: opacity 0.5s ease, filter 0.5s ease;\n            ",document.body.prepend(e)}}}(),h(t),x(t),f(t.contentOpacity),await v()}T.innerHTML=`\n        /* ヘッダーの透明化 */\n        #page-header, .page-context-header, #page {\n            background-color: transparent !important;\n            border-bottom: none !important;\n        }\n\n        /* ヘッダーのドロップダウンなど */\n        .navbar-nav .nav-item .nav-link:hover,\n        .navbar-nav .nav-item.open > .nav-link {\n            background-color: rgba(0, 0, 0, 0.3) !important;\n            border-radius: 4px;\n        }\n        .navbar-nav .nav-item.dropdown .dropdown-menu {\n            background-color: #ffffff !important;\n            box-shadow: 0 5px 10px rgba(0,0,0,0.2);\n        }\n        .navbar-nav .nav-item.dropdown .dropdown-menu a.dropdown-item {\n            color: #000000 !important;\n            text-shadow: none !important;\n        }\n        .page-context-header .page-header-headings h1,\n        .page-context-header a {\n            color: #000000 !important;\n        }\n        #usernavigation .usermenu {\n             display: flex;\n             align-items: center;\n        }\n        #customSettingsBtn {\n             margin-right: 5px;\n        }\n\n        /* 背景とコンテンツ */\n        ${l} {\n            background-color: #f0f2f5 !important;\n            overflow-x: hidden !important;\n        }\n        #background-video, #background-image-container {\n             transition: opacity 0.5s ease, filter 0.5s ease;\n        }\n        #page, #page-wrapper {\n            background-color: transparent !important;\n            z-index: 1;\n            position: relative;\n        }\n        .main-inner, .secondary-navigation d-print-none, .moremenu navigation observed, .nav more-nav nav-tabs, .card-footer border-0 bg-white w-100 {\n            background-color:  rgba(255, 255, 255, 0.6) !important;\n        }\n        :is(#secondary-navigation d-print-none, #page-content, #region-main, #region-main-box, .block) {\n            background-color: transparent !important;\n            z-index: 1;\n            position: relative;\n        }\n        .section {\n             border-bottom: 2px solid rgba(255, 255, 255, 0.4) !important;\n             margin-bottom: 10px !important;\n        }\n        .card-footer, .bg-white, .form-control, .page-item, .pagination mb-0, .pagination, .secondary-navigation, .secondary-navigation, .card-foote {\n            background-color: transparent !important;\n        }\n        :is(nav, .primary-navigation, .secondary-navigation, .nav, .nav-tabs, .moremenu, .course-section-header, .section-item) {\n            background-color: transparent !important;\n        }\n        .block * { color: #000000; }\n        .block a, .card a { color: #0d6efd; }\n\n        /* その他 */\n        .deadline-highlight {\n            border: 1px solid #ff4d4d !important;\n            background-color: rgba(255, 240, 240, 0.3) !important;\n            box-shadow: 0 0 8px rgba(255, 0, 0, 0.5) !important;\n        }\n        .block, .card:not(.custom-card-style) {\n            border: 0px solid rgba(255, 255, 255, 0.8) !important;\n            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);\n            transition: box-shadow 0.3s ease-in-out, background-color 0.3s ease;\n            z-index: 1;\n            position: relative;\n        }\n        .card.custom-card-style {\n            border: 1px solid rgba(255, 255, 255, 0.9) !important;\n        }\n        #customTimetableTable th {\n             border-bottom-color: #aaa !important;\n             border-bottom-width: 2px !important;\n             border-left: 2px solid #ccc !important;\n        }\n        #customTimetableTable td {\n             border-bottom-color: #f0f0f0 !important;\n             border-bottom-width: 2px !important;\n             border-left: 2px solid #f0f0f0 !important;\n        }\n        .section {\n             border-bottom: 2px solid rgba(255, 255, 255, 0.4) !important;\n             margin-bottom: 1px !important;\n        }\n        .section-item {\n            border: none !important;\n        }\n    `,document.head.appendChild(T),async function(){await new Promise((t,n)=>{if(!window.indexedDB)return console.warn("IndexedDB not supported."),t(null);const o=indexedDB.open("MoodleCustomBGDB",2);o.onupgradeneeded=t=>{c=t.target.result,c.objectStoreNames.contains(e)||c.createObjectStore(e,{keyPath:"id"})},o.onsuccess=e=>{c=e.target.result,t(c)},o.onerror=e=>{console.error("IndexedDB error:",e.target.errorCode),n(e.target.errorCode)}});const t=await g();!function(){const e=document.querySelector("#usernavigation .usermenu");if(!e||document.getElementById("customSettingsBtn"))return;const t=document.createElement("li");t.classList.add("nav-item"),t.innerHTML='\n            <button id="customSettingsBtn" class="btn nav-link" style="\n                background: none; border: none; padding: 0.5rem 0.8rem;\n                cursor: pointer; font-size: 1.25rem; line-height: 1;\n            " title="Moodleカスタム設定">\n                <i class="fa fa-cog" aria-hidden="true"></i> </button>\n        ',e.prepend(t),document.getElementById("customSettingsBtn").addEventListener("click",async()=>{const e=await g();let t=document.getElementById("custom-settings-modal");t||(u(e),t=document.getElementById("custom-settings-modal")),b(e),t.style.display="flex"})}(),u(t),I(await w()),$(!1),setTimeout(E,1500)}()}();